<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¦¬ë·° ìƒì„¸ - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/review-detail.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
  </head>
  <body class="app review-detail-page">
    <header class="app-header">
      <h1>Via Flight</h1>
      <p class="tagline">ë¦¬ë·° ìƒì„¸</p>
      <nav class="breadcrumb">
        <button class="btn btn--ghost btn--small" onclick="goBack()">â† ë’¤ë¡œê°€ê¸°</button>
      </nav>
    </header>

    <main class="review-detail-main">
      <!-- ë¡œë”© ìƒíƒœ -->
      <div id="review-loading" class="review-loading">
        <p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>

      <!-- ì—ëŸ¬ ìƒíƒœ -->
      <div id="review-error" class="review-error" style="display: none;">
        <p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <button class="btn btn--primary" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
      </div>

      <!-- ë¦¬ë·° ë‚´ìš© -->
      <div id="review-content" style="display: none;">
        <!-- ë¦¬ë·° í—¤ë” -->
        <section class="review-header-section">
          <div class="review-header-card">
            <div class="review-header-rating">
              <div class="review-rating-display" id="review-rating-display">
                <span class="rating-stars" id="rating-stars"></span>
                <span class="rating-number" id="rating-number"></span>
              </div>
              <div class="review-header-meta">
                <span class="review-date" id="review-date"></span>
                <span class="review-city" id="review-city"></span>
              </div>
            </div>
            <div class="review-trip-info" id="review-trip-info">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
        </section>

        <!-- ì „ì²´ ë¦¬ë·° -->
        <section class="review-content-section">
          <div class="review-content-card">
            <h2 class="section-title">ğŸ’¬ í•œ ì¤„ í›„ê¸°</h2>
            <p class="review-summary-text" id="review-summary"></p>
          </div>

          <div class="review-content-card" id="review-detail-card" style="display: none;">
            <h2 class="section-title">ğŸ“„ ìƒì„¸ í›„ê¸°</h2>
            <p class="review-detail-text" id="review-detail"></p>
          </div>
        </section>

        <!-- ì—¬í–‰ ì •ë³´ -->
        <section class="review-trip-info-section">
          <div class="review-info-card">
            <h2 class="section-title">ğŸ—ºï¸ ì—¬í–‰ ì •ë³´</h2>
            <div class="trip-info-grid" id="trip-info-grid">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
        </section>

        <!-- ë°©ë¬¸í•œ ì¥ì†Œ ì „ì²´ ë¦¬ìŠ¤íŠ¸ -->
        <section class="review-visited-places-section" id="review-visited-places-section" style="display: none;">
          <div class="review-visited-places-card">
            <h2 class="section-title">ğŸ—ºï¸ ë°©ë¬¸í•œ ì¥ì†Œ ì „ì²´</h2>
            <div class="visited-places-container">
              <div class="visited-places-group" id="airport-places-group" style="display: none;">
                <h3 class="visited-places-group-title">âœˆï¸ ê³µí•­ ë‚´ë¶€</h3>
                <div class="visited-places-list" id="airport-places-list">
                  <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
              </div>
              <div class="visited-places-group" id="city-places-group" style="display: none;">
                <h3 class="visited-places-group-title">ğŸ™ï¸ ê³µí•­ ì™¸ë¶€ (ë„ì‹œ)</h3>
                <div class="visited-places-list" id="city-places-list">
                  <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ë°©ë¬¸í•œ ì¥ì†Œ ë¦¬ë·° -->
        <section class="review-places-section" id="review-places-section" style="display: none;">
          <div class="review-places-card">
            <h2 class="section-title">
              ğŸ“ ë°©ë¬¸í•œ ì¥ì†Œ ë¦¬ë·°
              <span class="place-count" id="place-count"></span>
            </h2>
            <div class="place-reviews-list" id="place-reviews-list">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
        </section>
      </div>
    </main>

    <script type="module" src="scripts/router.js"></script>
    <script type="module" src="scripts/userProfile.js"></script>
    <script type="module" src="scripts/reviewDB.js"></script>
    <script>
      // ì „ì—­ ë³€ìˆ˜
      let reviewId = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ
      document.addEventListener('DOMContentLoaded', async () => {
        // URL íŒŒë¼ë¯¸í„° ë˜ëŠ” sessionStorageì—ì„œ ë¦¬ë·° ID ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        reviewId = urlParams.get('id') || sessionStorage.getItem('selectedReviewId');

        if (!reviewId) {
          showError('ë¦¬ë·° IDê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ë¦¬ë·° ë¡œë“œ
        await loadReview();
      });

      // ë¦¬ë·° ë¡œë“œ
      async function loadReview() {
        const loadingEl = document.getElementById('review-loading');
        const errorEl = document.getElementById('review-error');
        const contentEl = document.getElementById('review-content');

        try {
          loadingEl.style.display = 'block';
          errorEl.style.display = 'none';
          contentEl.style.display = 'none';

          // DB ì´ˆê¸°í™”
          await window.reviewDB.initialize();

          console.log('ğŸ” [loadReview] ë¦¬ë·° ID:', reviewId);

          // ì „ì²´ ë¦¬ë·° ì¡°íšŒ
          const review = await window.reviewDB.getTripReviewById(reviewId);
          console.log('ğŸ” [loadReview] ì¡°íšŒëœ ë¦¬ë·°:', review);
          
          if (!review || !review.id) {
            // ë””ë²„ê¹…: ì €ì¥ëœ ëª¨ë“  ë¦¬ë·° ID í™•ì¸
            try {
              const allReviews = window.reviewDB.db.exec(`
                SELECT id FROM trip_reviews
              `);
              console.log('ğŸ“Š [loadReview] ì €ì¥ëœ ëª¨ë“  ë¦¬ë·° ID:', allReviews);
            } catch (debugError) {
              console.error('âŒ [loadReview] ë””ë²„ê¹… ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', debugError);
            }
            throw new Error('ë¦¬ë·°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          // ì¥ì†Œ ë¦¬ë·° ì¡°íšŒ
          const placeReviews = window.reviewDB.getPlaceReviewsByTripId(reviewId);

          // ë¦¬ë·° ë Œë”ë§
          await renderReview(review, placeReviews);

          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';

        } catch (error) {
          console.error('ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:', error);
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
        }
      }

      // ë¦¬ë·° ë Œë”ë§
      async function renderReview(review, placeReviews) {
        // í‰ì  í‘œì‹œ
        const rating = review.overall_review_rating || 0;
        document.getElementById('rating-stars').textContent = 'â­'.repeat(rating);
        document.getElementById('rating-number').textContent = `${rating}.0`;

        // ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        let authorName = 'ìµëª… ì‚¬ìš©ì';
        if (review.user_id && window.getUserNickname) {
          try {
            authorName = await window.getUserNickname(review.user_id) || 'ìµëª… ì‚¬ìš©ì';
          } catch (e) {
            console.warn('ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', e);
          }
        }

        // ë‚ ì§œ í‘œì‹œ
        const reviewDate = new Date(review.submitted_at);
        document.getElementById('review-date').textContent = formatReviewDate(reviewDate);

        // ë„ì‹œ í‘œì‹œ (ì‘ì„±ì ì •ë³´ í¬í•¨)
        const cityEl = document.getElementById('review-city');
        cityEl.innerHTML = `
          <span>${review.trip_info_city || ''}</span>
          <span class="review-author" style="margin-left: 0.5rem; color: var(--color-text-secondary); font-size: 0.9rem;">
            âœï¸ ${escapeHtml(authorName)}
          </span>
        `;

        // ì—¬í–‰ íƒ€ì… ì •ë³´
        const tripTypeText = review.trip_info_trip_type === 'airport-only' 
          ? 'ê³µí•­ ë‚´ë¶€ë§Œ' 
          : review.trip_info_trip_type === 'airport-external' 
          ? 'ê³µí•­ + ë„ì‹œ' 
          : 'ì „ì²´';

        const durationText = review.trip_info_duration 
          ? formatDuration(review.trip_info_duration) 
          : '';

        const tripInfoHtml = `
          <span class="trip-type-badge">${tripTypeText}</span>
          ${durationText ? `<span class="trip-duration-badge">${durationText}</span>` : ''}
          ${review.trip_info_visit_count ? `<span class="trip-visit-badge">${review.trip_info_visit_count}ê°œ ì¥ì†Œ</span>` : ''}
        `;
        document.getElementById('review-trip-info').innerHTML = tripInfoHtml;

        // í•œ ì¤„ í›„ê¸°
        document.getElementById('review-summary').textContent = review.overall_review_summary || '';

        // ìƒì„¸ í›„ê¸°
        if (review.overall_review_detail) {
          document.getElementById('review-detail').textContent = review.overall_review_detail;
          document.getElementById('review-detail-card').style.display = 'block';
        }

        // ì—¬í–‰ ì •ë³´
        const tripInfoGrid = document.getElementById('trip-info-grid');
        tripInfoGrid.innerHTML = `
          <div class="trip-info-item">
            <span class="trip-info-label">ë„ì‹œ</span>
            <span class="trip-info-value">${review.trip_info_city || '-'}</span>
          </div>
          ${durationText ? `
          <div class="trip-info-item">
            <span class="trip-info-label">í™˜ìŠ¹ ì‹œê°„</span>
            <span class="trip-info-value">${durationText}</span>
          </div>
          ` : ''}
          ${review.trip_info_visit_count ? `
          <div class="trip-info-item">
            <span class="trip-info-label">ë°©ë¬¸ ì¥ì†Œ</span>
            <span class="trip-info-value">${review.trip_info_visit_count}ê°œ</span>
          </div>
          ` : ''}
          <div class="trip-info-item">
            <span class="trip-info-label">ì—¬í–‰ íƒ€ì…</span>
            <span class="trip-info-value">${tripTypeText}</span>
          </div>
          ${review.trip_info_arrival ? `
          <div class="trip-info-item">
            <span class="trip-info-label">ë„ì°© ì‹œê°„</span>
            <span class="trip-info-value">${formatDateTime(review.trip_info_arrival)}</span>
          </div>
          ` : ''}
          ${review.trip_info_departure ? `
          <div class="trip-info-item">
            <span class="trip-info-label">ì¶œë°œ ì‹œê°„</span>
            <span class="trip-info-value">${formatDateTime(review.trip_info_departure)}</span>
          </div>
          ` : ''}
        `;

        // ë°©ë¬¸í•œ ì¥ì†Œ ì „ì²´ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        let allVisitedPlaces = [];
        try {
          if (review.trip_info_visited_places) {
            allVisitedPlaces = typeof review.trip_info_visited_places === 'string' 
              ? JSON.parse(review.trip_info_visited_places)
              : review.trip_info_visited_places;
            console.log('âœ… ë°©ë¬¸ ì¥ì†Œ ì •ë³´ ë¡œë“œ:', allVisitedPlaces);
          } else {
            console.warn('âš ï¸ ë°©ë¬¸ ì¥ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. review:', review);
          }
        } catch (e) {
          console.warn('ë°©ë¬¸ ì¥ì†Œ ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', e, review.trip_info_visited_places);
        }

        if (allVisitedPlaces && allVisitedPlaces.length > 0) {
          document.getElementById('review-visited-places-section').style.display = 'block';
          
          // ê³µí•­ ë‚´ë¶€ì™€ ì™¸ë¶€ë¡œ ë¶„ë¦¬
          const airportPlaces = allVisitedPlaces.filter(place => place.location === 'airport');
          const cityPlaces = allVisitedPlaces.filter(place => place.location === 'city');
          
          // ê³µí•­ ë‚´ë¶€ ì¥ì†Œ í‘œì‹œ
          if (airportPlaces.length > 0) {
            document.getElementById('airport-places-group').style.display = 'block';
            const airportList = document.getElementById('airport-places-list');
            airportList.innerHTML = airportPlaces.map(place => `
              <div class="visited-place-item">
                <span class="visited-place-icon">${place.categoryIcon || 'ğŸ“'}</span>
                <div class="visited-place-info">
                  <span class="visited-place-name">${escapeHtml(place.name || '')}</span>
                  ${place.category ? `<span class="visited-place-category">${escapeHtml(place.category)}</span>` : ''}
                </div>
              </div>
            `).join('');
          }
          
          // ê³µí•­ ì™¸ë¶€ ì¥ì†Œ í‘œì‹œ
          if (cityPlaces.length > 0) {
            document.getElementById('city-places-group').style.display = 'block';
            const cityList = document.getElementById('city-places-list');
            cityList.innerHTML = cityPlaces.map(place => `
              <div class="visited-place-item">
                <span class="visited-place-icon">${place.categoryIcon || 'ğŸ“'}</span>
                <div class="visited-place-info">
                  <span class="visited-place-name">${escapeHtml(place.name || '')}</span>
                  ${place.category ? `<span class="visited-place-category">${escapeHtml(place.category)}</span>` : ''}
                </div>
              </div>
            `).join('');
          }
        }

        // ì¥ì†Œ ë¦¬ë·°
        if (placeReviews && placeReviews.length > 0) {
          document.getElementById('review-places-section').style.display = 'block';
          document.getElementById('place-count').textContent = `(${placeReviews.length}ê°œ)`;

          const placeReviewsList = document.getElementById('place-reviews-list');
          placeReviewsList.innerHTML = placeReviews.map(place => {
            const stars = 'â­'.repeat(place.rating || 0);
            return `
              <div class="place-review-item">
                <div class="place-review-header">
                  <div class="place-review-name">
                    <span class="place-icon">${place.poi_category_icon || 'ğŸ“'}</span>
                    <span class="place-name">${escapeHtml(place.poi_name || '')}</span>
                    ${place.poi_category ? `<span class="place-category">${escapeHtml(place.poi_category)}</span>` : ''}
                  </div>
                  <div class="place-review-rating">
                    <span class="place-stars">${stars}</span>
                    <span class="place-rating-number">${place.rating || 0}.0</span>
                  </div>
                </div>
                ${place.poi_location ? `<p class="place-location">ğŸ“ ${escapeHtml(place.poi_location)}</p>` : ''}
                ${place.comment ? `<p class="place-comment">${escapeHtml(place.comment)}</p>` : ''}
              </div>
            `;
          }).join('');
        }
      }

      // ë‚ ì§œ í¬ë§·íŒ…
      function formatReviewDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}.${month}.${day}`;
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}.${month}.${day} ${hours}:${minutes}`;
      }

      // ê¸°ê°„ í¬ë§·íŒ…
      function formatDuration(durationMs) {
        if (!durationMs) return '';
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        if (hours > 0 && minutes > 0) {
          return `${hours}ì‹œê°„ ${minutes}ë¶„`;
        } else if (hours > 0) {
          return `${hours}ì‹œê°„`;
        } else if (minutes > 0) {
          return `${minutes}ë¶„`;
        }
        return '';
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ì—ëŸ¬ í‘œì‹œ
      function showError(message) {
        const errorEl = document.getElementById('review-error');
        const loadingEl = document.getElementById('review-loading');
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.querySelector('p').textContent = message;
      }

      // ë’¤ë¡œê°€ê¸°
      function goBack() {
        window.history.back();
      }
    </script>
  </body>
</html>

