<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <title>ì—¬í–‰ ì¼ì • ìš”ì•½ - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/trip-summary.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
    <link rel="stylesheet" href="styles/components/forms.css" />
  </head>
  <body class="app trip-summary-page">
    <header class="app-header">
      <h1>Via Flight</h1>
      <p class="tagline">ì—¬í–‰ ì¼ì • ìš”ì•½</p>
      <nav class="breadcrumb">
        <a href="landing.html" class="breadcrumb__link">â† í™ˆìœ¼ë¡œ</a>
      </nav>
    </header>

    <main class="trip-summary-main">
      <!-- Transfer Summary -->
      <section class="transfer-summary">
        <div class="summary-card">
          <h2 class="summary-title">ì—¬í–‰ ì •ë³´</h2>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">ê²½ìœ  ë„ì‹œ</span>
              <span class="summary-value" id="summary-city">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">í™˜ìŠ¹ ì‹œê°„</span>
              <span class="summary-value" id="summary-duration">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ë„ì°© ì‹œê°„</span>
              <span class="summary-value" id="summary-arrival">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ì¶œë°œ ì‹œê°„</span>
              <span class="summary-value" id="summary-departure">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</span>
              <span class="summary-value" id="summary-style">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Schedule Overview -->
      <section class="schedule-overview">
        <div class="overview-container">
          <h2 class="overview-title">ì „ì²´ ì¼ì •</h2>
          <p class="overview-description">
            ì„ íƒí•˜ì‹  ì¥ì†Œë“¤ë¡œ êµ¬ì„±ëœ ìµœì ì˜ ì—¬í–‰ ì¼ì •ì…ë‹ˆë‹¤.
          </p>

          <div class="schedule-sections" id="schedule-sections">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
          </div>

          <div class="schedule-stats">
            <div class="stat-card">
              <div class="stat-icon">ğŸ“</div>
              <div class="stat-content">
                <div class="stat-number" id="total-locations">0</div>
                <div class="stat-label">ë°©ë¬¸ ì¥ì†Œ</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">â±ï¸</div>
              <div class="stat-content">
                <div class="stat-number" id="total-time">0ë¶„</div>
                <div class="stat-label">ì´ ì†Œìš”ì‹œê°„</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸš¶</div>
              <div class="stat-content">
                <div class="stat-number" id="walking-time">0ë¶„</div>
                <div class="stat-label">ì´ë™ì‹œê°„</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tips and Recommendations -->
      <section class="tips-section">
        <div class="tips-container">
          <h2 class="tips-title">ğŸ’¡ ì—¬í–‰ íŒ</h2>
          <div class="tips-grid" id="tips-grid">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
          </div>
        </div>
      </section>

      <!-- Action Buttons -->
      <section class="action-section">
        <div class="action-container">
          <div class="completion-message">
            <h2>ğŸ‰ í™˜ìŠ¹ ì—¬í–‰ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤!</h2>
            <p>ì†Œì¤‘í•œ ì—¬í–‰ì˜ ê¸°ë¡ì„ ê³µìœ í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”.</p>
          </div>
          
          <div class="share-section">
            <h3>ì¼ì • ê³µìœ í•˜ê¸°</h3>
            <div class="share-buttons">
              <button class="btn btn--small btn--ghost" onclick="shareSchedule('link')">
                ë§í¬ ê³µìœ 
              </button>
              <button class="btn btn--small btn--ghost" onclick="shareSchedule('image')">
                ì´ë¯¸ì§€ ì €ì¥
              </button>
              <button class="btn btn--small btn--secondary" onclick="shareSchedule('text')">
                í…ìŠ¤íŠ¸ ë³µì‚¬
              </button>
            </div>
          </div>
          
          <div class="action-buttons">
            <button class="btn btn--primary" onclick="goToHome()">
              ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
          </div>
        </div>
      </section>
    </main>

    <script type="module" src="scripts/router.js"></script>
    <script>
      // ì „ì—­ ìƒíƒœ
      let scheduleData = null;
      let transferInfo = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        loadScheduleData();
        updateSummary();
        generateScheduleOverview();
        updateStats();
        generateTips();
      });

      // ì¼ì • ë°ì´í„° ë¡œë“œ
      function loadScheduleData() {
        // sessionStorageì—ì„œ ìµœì¢… ì¼ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const finalTripPlanStr = sessionStorage.getItem('finalTripPlan');
        if (finalTripPlanStr) {
          try {
            const finalTripPlan = JSON.parse(finalTripPlanStr);
            const plannerResult = finalTripPlan.plannerResult;
            
            if (plannerResult) {
              scheduleData = {
                transferInfo: {
                  city: plannerResult.meta?.cityText || 'ì‹±ê°€í¬ë¥´',
                  arrival: plannerResult.meta?.arrival,
                  departure: plannerResult.meta?.departure,
                  duration: plannerResult.meta?.exploreWindow?.availableMinutes * 60000
                },
                type: 'airport-external',
                waypoints: plannerResult.waypoints || [],
                completedAt: finalTripPlan.completedAt
              };
              transferInfo = scheduleData.transferInfo;
            }
          } catch (error) {
            console.error('ìµœì¢… ì¼ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            setDefaultData();
          }
        } else {
          setDefaultData();
        }
      }

      function setDefaultData() {
        // ê¸°ë³¸ê°’ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
        scheduleData = {
          transferInfo: {
            city: 'ì‹±ê°€í¬ë¥´',
            arrival: new Date(),
            departure: new Date(Date.now() + 4 * 60 * 60 * 1000),
            duration: 4 * 60 * 60 * 1000
          },
          type: 'airport-external',
          waypoints: [],
          completedAt: new Date().toISOString()
        };
        transferInfo = scheduleData.transferInfo;
      }

      // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateSummary() {
        if (!transferInfo) return;

        document.getElementById('summary-city').textContent = transferInfo.city;
        document.getElementById('summary-duration').textContent = formatDuration(transferInfo.duration);
        document.getElementById('summary-arrival').textContent = formatDateTime(transferInfo.arrival);
        document.getElementById('summary-departure').textContent = formatDateTime(transferInfo.departure);
        
        const styleText = scheduleData.type === 'airport-only' ? 'ê³µí•­ ë‚´ë¶€ë§Œ' : 'ê³µí•­ + ë„ì‹œ';
        document.getElementById('summary-style').textContent = styleText;
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatDuration(durationMs) {
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let result = '';
        if (hours > 0) result += `${hours}ì‹œê°„`;
        if (minutes > 0) result += ` ${minutes}ë¶„`;
        
        return result || '0ë¶„';
      }

      // ë‚ ì§œ ì‹œê°„ í¬ë§·íŒ…
      function formatDateTime(date) {
        if (!date) return '-';
        
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        
        return `${year}.${month}.${day} ${hours}:${minutes}`;
      }

      // ì¼ì • ê°œìš” ìƒì„±
      function generateScheduleOverview() {
        const container = document.getElementById('schedule-sections');
        container.innerHTML = '';

        if (scheduleData.type === 'airport-only') {
          generateAirportOnlySchedule(container);
        } else if (scheduleData.type === 'airport-external') {
          generateAirportExternalSchedule(container);
        }
      }

      // ê³µí•­ ë‚´ë¶€ë§Œ ì¼ì • ìƒì„±
      function generateAirportOnlySchedule(container) {
        const section = document.createElement('div');
        section.className = 'schedule-section airport-section';
        
        section.innerHTML = `
          <h3>ğŸ¢ ê³µí•­ ë‚´ë¶€ ì¼ì •</h3>
          <div class="timeline" id="airport-timeline">
            ${generateTimelineItems(scheduleData.airportPOIs || [], 'airport')}
          </div>
        `;
        
        container.appendChild(section);
      }

      // ê³µí•­ + ë„ì‹œ ì¼ì • ìƒì„±
      function generateAirportExternalSchedule(container) {
        // ê³µí•­ ë‚´ë¶€ ì„¹ì…˜
        const airportSection = document.createElement('div');
        airportSection.className = 'schedule-section airport-section';
        
        airportSection.innerHTML = `
          <h3>ğŸ¢ ê³µí•­ ë‚´ë¶€ ì¼ì •</h3>
          <div class="timeline" id="airport-timeline">
            ${generateTimelineItems(scheduleData.airportPOIs || [], 'airport')}
          </div>
        `;
        
        container.appendChild(airportSection);

        // ë„ì‹œ ì„¹ì…˜
        const citySection = document.createElement('div');
        citySection.className = 'schedule-section city-section';
        
        citySection.innerHTML = `
          <h3>ğŸ™ï¸ ë„ì‹œ íƒë°© ì¼ì •</h3>
          <div class="timeline" id="city-timeline">
            ${generateTimelineItems(scheduleData.cityPOIs || [], 'city')}
          </div>
        `;
        
        container.appendChild(citySection);
      }

      // íƒ€ì„ë¼ì¸ ì•„ì´í…œ ìƒì„±
      function generateTimelineItems(poiIds, type) {
        if (!poiIds || poiIds.length === 0) {
          return '<p class="empty-timeline">ì„ íƒëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ì„ì‹œ POI ë°ì´í„°
        const samplePOIs = {
          airport: [
            { id: 1, name: 'ë©´ì„¸ì  A', category: 'ì‡¼í•‘', estimatedTime: 60 },
            { id: 2, name: 'ê³µí•­ ì¹´í˜', category: 'ìŒì‹', estimatedTime: 30 },
            { id: 3, name: 'ë¬¸í™” ì „ì‹œê´€', category: 'ë¬¸í™”ì²´í—˜', estimatedTime: 45 },
            { id: 4, name: 'ìŠ¤íŒŒ & ë§ˆì‚¬ì§€', category: 'íœ´ì‹', estimatedTime: 90 },
            { id: 5, name: 'ê²Œì„ì¡´', category: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', estimatedTime: 30 },
            { id: 6, name: 'ì€í–‰ ATM', category: 'í¸ì˜ì‹œì„¤', estimatedTime: 15 }
          ],
          city: [
            { id: 101, name: 'ë„ì‹œ ëœë“œë§ˆí¬', category: 'ê´€ê´‘ëª…ì†Œ', estimatedTime: 120 },
            { id: 102, name: 'ë¡œì»¬ ì‹œì¥', category: 'ì‡¼í•‘', estimatedTime: 90 },
            { id: 103, name: 'ì „í†µ ë§›ì§‘', category: 'ìŒì‹', estimatedTime: 60 },
            { id: 104, name: 'ë°•ë¬¼ê´€', category: 'ë¬¸í™”ì²´í—˜', estimatedTime: 90 },
            { id: 105, name: 'ì¤‘ì•™ ê³µì›', category: 'ìì—°', estimatedTime: 60 },
            { id: 106, name: 'ì•¼ê²½ ì „ë§ëŒ€', category: 'ì•¼ê²½/ì•¼ìƒí™œ', estimatedTime: 45 }
          ]
        };

        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        // ë„ì‹œ ì¼ì •ì˜ ê²½ìš° ê³µí•­ ë‚´ë¶€ ì¼ì • í›„ ì‹œì‘
        if (type === 'city') {
          currentTime.setHours(currentTime.getHours() + 2);
        }

        return poiIds.map(poiId => {
          const poi = samplePOIs[type].find(p => p.id === poiId);
          if (!poi) return '';

          const startTime = new Date(currentTime);
          const endTime = new Date(currentTime.getTime() + poi.estimatedTime * 60000);
          
          const timelineItem = `
            <div class="timeline-item">
              <div class="timeline-time">
                <span class="start-time">${formatTime(startTime)}</span>
                <span class="end-time">${formatTime(endTime)}</span>
              </div>
              <div class="timeline-content">
                <h4>${poi.name}</h4>
                <span class="timeline-category">${poi.category}</span>
                <p>${poi.estimatedTime}ë¶„ ì²´ë¥˜</p>
              </div>
            </div>
          `;
          
          currentTime = endTime;
          return timelineItem;
        }).join('');
      }

      // ì‹œê°„ í¬ë§·íŒ… (HH:MM)
      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // í†µê³„ ì—…ë°ì´íŠ¸
      function updateStats() {
        const airportCount = scheduleData.airportPOIs ? scheduleData.airportPOIs.length : 0;
        const cityCount = scheduleData.cityPOIs ? scheduleData.cityPOIs.length : 0;
        const totalLocations = airportCount + cityCount;
        
        document.getElementById('total-locations').textContent = totalLocations;

        // ì´ ì†Œìš”ì‹œê°„ ê³„ì‚° (ì„ì‹œ)
        const totalTime = totalLocations * 60; // í‰ê·  60ë¶„ì”©
        document.getElementById('total-time').textContent = `${totalTime}ë¶„`;

        // ì´ë™ì‹œê°„ ê³„ì‚° (ì„ì‹œ)
        const walkingTime = Math.max(0, totalLocations - 1) * 15; // ì¥ì†Œ ê°„ ì´ë™ 15ë¶„ì”©
        document.getElementById('walking-time').textContent = `${walkingTime}ë¶„`;
      }

      // íŒ ìƒì„±
      function generateTips() {
        const container = document.getElementById('tips-grid');
        const tips = getTipsForSchedule(scheduleData);
        
        container.innerHTML = tips.map(tip => `
          <div class="tip-card">
            <div class="tip-icon">${tip.icon}</div>
            <h4>${tip.title}</h4>
            <p>${tip.description}</p>
          </div>
        `).join('');
      }

      // ì¼ì •ì— ë”°ë¥¸ íŒ ê°€ì ¸ì˜¤ê¸°
      function getTipsForSchedule(schedule) {
        const baseTips = [
          {
            icon: 'ğŸ’',
            title: 'ì§ ë³´ê´€ì†Œ',
            description: 'ê³µí•­ ë‚´ ì§ ë³´ê´€ì†Œë¥¼ ì´ìš©í•˜ë©´ ê°€ë²¼ìš´ ì‡¼í•‘ê³¼ ê´€ê´‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
          },
          {
            icon: 'ğŸ“¶',
            title: 'ë¬´ë£Œ ì™€ì´íŒŒì´',
            description: 'ê³µí•­ ë‚´ ë¬´ë£Œ ì™€ì´íŒŒì´ë¥¼ ì—°ê²°í•˜ì—¬ ì‹¤ì‹œê°„ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
          },
          {
            icon: 'â°',
            title: 'ì‹œê°„ ê´€ë¦¬',
            description: 'ì¶œë°œ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ì—¬ìœ  ì‹œê°„ì„ í™•ë³´í•˜ì„¸ìš”.'
          }
        ];

        if (schedule.type === 'airport-external') {
          baseTips.push(
            {
              icon: 'ğŸš‡',
              title: 'êµí†µí¸',
              description: 'ê³µí•­ì—ì„œ ë„ì‹œê¹Œì§€ì˜ êµí†µí¸ì„ ë¯¸ë¦¬ í™•ì¸í•˜ê³  ì‹œê°„ì„ ê³ ë ¤í•˜ì„¸ìš”.'
            },
            {
              icon: 'ğŸ—ºï¸',
              title: 'ì§€ë„ ì•±',
              description: 'ì˜¤í”„ë¼ì¸ ì§€ë„ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì¸í„°ë„· ì—†ì´ë„ ê¸¸ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
            }
          );
        }

        return baseTips;
      }

      // ì¼ì • ìˆ˜ì •í•˜ê¸°
      // í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
      function goToHome() {
        window.location.href = 'landing.html';
      }

      // ì¼ì • ê³µìœ í•˜ê¸°
      function shareSchedule(type) {
        if (type === 'link') {
          // ë§í¬ ê³µìœ  ë¡œì§
          const shareUrl = window.location.origin + window.location.pathname;
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          });
        } else if (type === 'image') {
          // ì´ë¯¸ì§€ ì €ì¥ ë¡œì§
          alert('ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }
      }
    </script>
  </body>
</html>
