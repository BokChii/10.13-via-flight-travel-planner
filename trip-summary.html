<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <title>ì—¬í–‰ ì¼ì • ìš”ì•½ - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/trip-summary.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
    <link rel="stylesheet" href="styles/components/forms.css" />
  </head>
  <body class="app trip-summary-page">
    <header class="app-header">
      <h1>Via Flight</h1>
      <p class="tagline">ì—¬í–‰ ì¼ì • ìš”ì•½</p>
      <nav class="breadcrumb">
        <a href="index.html" class="breadcrumb__link">â† í™ˆìœ¼ë¡œ</a>
      </nav>
    </header>

    <main class="trip-summary-main">
      <!-- Transfer Summary -->
      <section class="transfer-summary">
        <div class="summary-card">
          <h2 class="summary-title">ì—¬í–‰ ì •ë³´</h2>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">ê²½ìœ  ë„ì‹œ</span>
              <span class="summary-value" id="summary-city">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">í™˜ìŠ¹ ì‹œê°„</span>
              <span class="summary-value" id="summary-duration">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ë„ì°© ì‹œê°„</span>
              <span class="summary-value" id="summary-arrival">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ì¶œë°œ ì‹œê°„</span>
              <span class="summary-value" id="summary-departure">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</span>
              <span class="summary-value" id="summary-style">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Schedule Overview -->
      <section class="schedule-overview">
        <div class="overview-container">
          <h2 class="overview-title">ì „ì²´ ì¼ì •</h2>
          <p class="overview-description">
            ì„ íƒí•˜ì‹  ì¥ì†Œë“¤ë¡œ êµ¬ì„±ëœ ìµœì ì˜ ì—¬í–‰ ì¼ì •ì…ë‹ˆë‹¤.
          </p>

          <div class="schedule-sections" id="schedule-sections">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
          </div>

          <div class="schedule-stats">
            <div class="stat-card">
              <div class="stat-icon">ğŸ“</div>
              <div class="stat-content">
                <div class="stat-number" id="total-locations">0</div>
                <div class="stat-label">ë°©ë¬¸ ì¥ì†Œ</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">â±ï¸</div>
              <div class="stat-content">
                <div class="stat-number" id="total-time">0ë¶„</div>
                <div class="stat-label">ì´ ì†Œìš”ì‹œê°„</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸš¶</div>
              <div class="stat-content">
                <div class="stat-number" id="walking-time">0ë¶„</div>
                <div class="stat-label">ì´ë™ì‹œê°„</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tips and Recommendations -->
      <section class="tips-section">
        <div class="tips-container">
          <h2 class="tips-title">ğŸ’¡ ì—¬í–‰ íŒ</h2>
          <div class="tips-grid" id="tips-grid">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
          </div>
        </div>
      </section>

      <!-- Save Schedule Section -->
      <section class="save-schedule-section">
        <div class="save-schedule-container">
          <h2 class="save-schedule-title">ğŸ’¾ ì¼ì • ì €ì¥</h2>
          <p class="save-schedule-description">
            ì´ ì¼ì •ì„ ì €ì¥í•˜ë©´ ë‚˜ì¤‘ì— ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
          <button class="btn btn--primary" id="save-schedule-btn" onclick="openSaveScheduleModal()">
            ë§ˆì´ í˜ì´ì§€ì— ì¼ì • ì €ì¥
          </button>
        </div>
      </section>

      <!-- Review Section -->
      <section class="review-section">
        <div class="review-container">
          <h2 class="review-title">ğŸ“ ì—¬í–‰ ë¦¬ë·° ì‘ì„±</h2>
          <p class="review-description">
            ì†Œì¤‘í•œ í™˜ìŠ¹ ê²½í—˜ì„ ê¸°ë¡í•˜ê³ , ë‹¤ë¥¸ ì—¬í–‰ìë“¤ì—ê²Œ ë„ì›€ì„ ì£¼ì„¸ìš”.
          </p>

          <!-- ì „ì²´ ì—¬ì • ë¦¬ë·° (í•„ìˆ˜) -->
          <div class="review-card review-card--main">
            <div class="review-header">
              <h3>âœ¨ ì „ì²´ ì—¬ì • ë¦¬ë·°</h3>
              <span class="required-badge">í•„ìˆ˜</span>
            </div>
            
            <div class="rating-input">
              <label>ì „ì²´ ë§Œì¡±ë„</label>
              <div class="star-rating" id="overall-rating" data-rating="0">
                <span class="star" data-value="1">â­</span>
                <span class="star" data-value="2">â­</span>
                <span class="star" data-value="3">â­</span>
                <span class="star" data-value="4">â­</span>
                <span class="star" data-value="5">â­</span>
              </div>
              <span class="rating-text" id="rating-text">í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
            </div>
            
            <div class="review-input">
              <label for="trip-review-summary">í•œ ì¤„ í›„ê¸°</label>
              <input type="text" id="trip-review-summary" 
                     placeholder="ì˜ˆ: í™˜ìŠ¹ ì‹œê°„ì„ ì•Œì°¨ê²Œ ë³´ë‚¼ ìˆ˜ ìˆì—ˆì–´ìš”!" 
                     maxlength="100">
              <span class="char-count"><span id="summary-char-count">0</span>/100</span>
            </div>
            
            <div class="review-input">
              <label for="trip-review-detail">ìƒì„¸ í›„ê¸° (ì„ íƒ)</label>
              <textarea id="trip-review-detail" 
                        placeholder="ì´ë²ˆ í™˜ìŠ¹ ì—¬í–‰ì— ëŒ€í•œ ëŠë‚€ ì , ì¶”ì²œí•˜ê³  ì‹¶ì€ ì , ê°œì„ í•  ì  ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”."
                        rows="4"
                        maxlength="1000"></textarea>
              <span class="char-count"><span id="detail-char-count">0</span>/1000</span>
            </div>
          </div>

          <!-- ê°œë³„ ì¥ì†Œ ë¦¬ë·° (ì„ íƒ) -->
          <div class="review-card review-card--optional">
            <div class="review-header">
              <h3>ğŸ“ ë°©ë¬¸í•œ ì¥ì†Œ ë¦¬ë·°</h3>
              <span class="optional-badge">ì„ íƒ</span>
              <button class="btn btn--ghost btn--small" id="toggle-place-reviews-btn" onclick="togglePlaceReviews()">
                <span id="toggle-text">í¼ì¹˜ê¸°</span>
              </button>
            </div>
            
            <div id="place-reviews-container" style="display: none;">
              <p class="review-hint">
                ğŸ’¡ íŠ¹ë³„íˆ ì¢‹ì•˜ê±°ë‚˜ ì•„ì‰¬ì› ë˜ ì¥ì†Œë§Œ ì„ íƒí•´ì„œ ë¦¬ë·°í•´ì£¼ì„¸ìš”!
              </p>
              <div id="place-reviews-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±: ê° POIë§ˆë‹¤ ë¦¬ë·° ì¹´ë“œ -->
              </div>
            </div>
          </div>

          <!-- ë¦¬ë·° ì œì¶œ -->
          <div class="review-actions">
            <button class="btn btn--primary" id="submit-review-btn" onclick="submitReview()">
              âœ… ë¦¬ë·° ì €ì¥í•˜ê¸°
            </button>
            <button class="btn btn--ghost" onclick="skipReview()">
              ë‚˜ì¤‘ì— ì‘ì„±í•˜ê¸°
            </button>
          </div>
        </div>
      </section>

      <!-- Action Buttons -->
      <section class="action-section">
        <div class="action-container">
          <div class="completion-message">
            <h2>ğŸ‰ í™˜ìŠ¹ ì—¬í–‰ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤!</h2>
            <p>ì†Œì¤‘í•œ ì—¬í–‰ì˜ ê¸°ë¡ì„ ê³µìœ í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”.</p>
          </div>
          
          <!-- ë‚˜ë€íˆ ë‘ ë²„íŠ¼: ì¼ì • ì €ì¥ / ì¼ì • ê³µìœ  -->
          <div class="cta-row">
            <button class="btn btn--secondary" onclick="saveSummaryPDF()">ğŸ’¾ ì¼ì • ì €ì¥</button>
            <button class="btn btn--primary" onclick="shareSummary()">ğŸ“¤ ì¼ì • ê³µìœ </button>
            </div>

          <!-- ì´ë©”ì¼ ì „ì†¡: ìµœì†Œ UI -->
          <div class="cta-gap"></div>
          <div class="email-share" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
            <input id="share-email-to" type="email" placeholder="ë°›ëŠ” ì´ë©”ì¼" class="field__input" style="flex:1; min-width:220px; max-width:360px;">
            <button id="email-send-btn" class="btn btn--primary" onclick="sendSummaryByEmail()" disabled aria-disabled="true" title="í˜„ì¬ ì‚¬ìš© ë¶ˆê°€ (ì¤€ë¹„ ì¤‘)">ğŸ“§ ì´ë©”ì¼ë¡œ ë³´ë‚´ê¸°</button>
          </div>
          <p class="email-disabled-note" aria-live="polite">í˜„ì¬ ì´ë©”ì¼ ì „ì†¡ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>

          <!-- ì•„ë˜ ê°„ê²© -->
          <div class="cta-gap"></div>

          <!-- ë” í° í™ˆ ë²„íŠ¼ -->
          <div class="cta-home">
            <button class="btn btn--primary btn--large" onclick="goToHome()">ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
          </div>
        </div>
      </section>
    </main>

    <!-- ì¼ì • ì €ì¥ ëª¨ë‹¬ -->
    <div id="save-schedule-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ì¼ì • ì €ì¥</h3>
          <button class="modal-close" onclick="closeSaveScheduleModal()">&times;</button>
        </div>
        <div class="modal-body">
          <p>ì´ ì¼ì •ì— ì´ë¦„ì„ ë¶™ì—¬ì£¼ì„¸ìš”.</p>
          <input 
            type="text" 
            id="schedule-name-input" 
            class="form-input" 
            placeholder="ì˜ˆ: ì‹±ê°€í¬ë¥´ 3ì‹œê°„ ì—¬í–‰"
            maxlength="50"
            autofocus
          />
          <div class="modal-actions">
            <button class="btn btn--ghost" onclick="closeSaveScheduleModal()">ì·¨ì†Œ</button>
            <button class="btn btn--primary" onclick="saveScheduleToDB()">ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PDF/Image export libs for ì €ì¥ ê¸°ëŠ¥ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="scripts/reviewDB.js"></script>
    <script type="module" src="scripts/scheduleDB.js"></script>
    <script type="module" src="scripts/router.js"></script>
    <script type="module" src="scripts/userProfile.js"></script>
    <script type="module" src="scripts/auth.js"></script>
    <script type="module">
      import { initAuth } from './scripts/auth.js';
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAuth);
      } else {
        initAuth();
      }
    </script>
    <script>
      // ì „ì—­ ìƒíƒœ
      let scheduleData = null;
      let transferInfo = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        try {
          loadScheduleData();
          
          if (!scheduleData) {
            console.warn('âš ï¸ scheduleDataê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë°ì´í„°ë¡œ ì§„í–‰');
            setDefaultData();
          }
          
          if (transferInfo) {
            try {
              updateSummary();
            } catch (error) {
              console.error('updateSummary ì˜¤ë¥˜:', error);
            }
          }
          
          try {
            generateScheduleOverview();
          } catch (error) {
            console.error('generateScheduleOverview ì˜¤ë¥˜:', error);
          }
          
          try {
            updateStats();
          } catch (error) {
            console.error('updateStats ì˜¤ë¥˜:', error);
          }
          
          try {
            generateTips();
          } catch (error) {
            console.error('generateTips ì˜¤ë¥˜:', error);
          }
          
          // ë¦¬ë·° ê´€ë ¨ ì´ˆê¸°í™” (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOMì´ ì™„ì „íˆ ë¡œë“œë˜ë„ë¡)
          setTimeout(() => {
            initStarRatings();
            initCharCounters();
          }, 300);
          
          console.log('âœ… trip-summary ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
          console.error('âŒ trip-summary ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
      });

       // ì¼ì • ë°ì´í„° ë¡œë“œ
       function loadScheduleData() {
         const finalTripPlanStr = sessionStorage.getItem('finalTripPlan');
         
         if (finalTripPlanStr) {
           try {
             const finalTripPlan = JSON.parse(finalTripPlanStr);
             const plannerResult = finalTripPlan.plannerResult;
             
            if (plannerResult) {
              // airport-external íƒ€ì…ì¸ ê²½ìš° ê³µí•­ ë‚´ë¶€ POI ë°ì´í„°ë¥¼ sessionStorageì—ì„œ ê°€ì ¸ì˜´
              const airportPOIDataStr = sessionStorage.getItem('airportPOIData');
              let airportPOIs = [];
              let cityPOIs = [];
              
              if (airportPOIDataStr) {
                try {
                  const airportPOIData = JSON.parse(airportPOIDataStr);
                  
                  // ì„ íƒëœ POI ID ëª©ë¡ê³¼ ì „ì²´ POI ëª©ë¡ì„ ë§¤ì¹­í•˜ì—¬ airportPOIs ìƒì„±
                  airportPOIs = airportPOIData.selectedPOIs
                    .map(poiId => airportPOIData.allPOIs.find(p => p.id === poiId))
                    .filter(poi => poi != null)
                    .map(poi => ({
                      id: poi.id,
                      name: poi.name,
                      address: poi.location || '',
                      description: poi.description || '',
                      rating: poi.rating || 4.0,
                      userRatingsTotal: poi.userRatingsTotal || 0,
                      categoryIcon: poi.categoryIcon || 'ğŸ“',
                      imageUrl: poi.imageUrl || '',
                      estimatedTime: poi.estimatedTime || 10,
                      category: poi.category || 'ê¸°íƒ€'
                    }));
                  
                } catch (error) {
                  console.error('âŒ airportPOIData íŒŒì‹± ì‹¤íŒ¨:', error);
                }
              }
              
              // waypointsëŠ” city POIë¡œ ê°„ì£¼
              const allWaypoints = plannerResult.waypoints || [];
              cityPOIs = allWaypoints.map((wp, index) => ({
                id: `city_${index}`,
                name: wp.label || 'Unknown',
                address: wp.address || '',
                description: wp.description || '',
                rating: wp.rating || 0,
                userRatingsTotal: wp.userRatingsTotal || 0,
                categoryIcon: wp.categoryIcon || 'ğŸ“',
                imageUrl: wp.photos?.[0] || '',
                estimatedTime: wp.stayMinutes || 10,
                category: wp.categoryKey || 'ê¸°íƒ€'
              }));
              
              scheduleData = {
                transferInfo: {
                  city: plannerResult.meta?.cityText || 'ì‹±ê°€í¬ë¥´',
                  arrival: plannerResult.meta?.originalArrival || plannerResult.meta?.arrival,
                  departure: plannerResult.meta?.originalDeparture || plannerResult.meta?.departure,
                  duration: (() => {
                    const arrival = plannerResult.meta?.originalArrival || plannerResult.meta?.arrival;
                    const departure = plannerResult.meta?.originalDeparture || plannerResult.meta?.departure;
                    if (arrival && departure) {
                      const arrivalTime = new Date(arrival).getTime();
                      const departureTime = new Date(departure).getTime();
                      return departureTime - arrivalTime;
                    }
                    // í´ë°±: availableMinutes ì‚¬ìš© (ë²„í¼ í¬í•¨ ì¶”ì •)
                    return (plannerResult.meta?.exploreWindow?.availableMinutes || 0) * 60000;
                  })()
                },
                type: 'airport-external',
                waypoints: allWaypoints,
                airportPOIs: airportPOIs,
                cityPOIs: cityPOIs,
                actualTimeline: finalTripPlan.actualTimeline, // ì‹¤ì œ ê³„ì‚°ëœ ì‹œê°„í‘œ ì¶”ê°€
                completedAt: finalTripPlan.completedAt
              };
              console.log('ğŸ§­ [trip-summary] transferInfo ì„¤ì •:', {
                city: scheduleData.transferInfo.city,
                arrival: scheduleData.transferInfo.arrival,
                departure: scheduleData.transferInfo.departure,
                durationMs: scheduleData.transferInfo.duration
              });
              
              if (finalTripPlan.actualTimeline) {
                console.log('âœ… ì‹¤ì œ ê³„ì‚°ëœ íƒ€ì„ë¼ì¸ ë¡œë“œ ì™„ë£Œ');
              }
              transferInfo = scheduleData.transferInfo;
            } else {
              setDefaultData();
            }
           } catch (error) {
             console.error('âŒ ìµœì¢… ì¼ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
             setDefaultData();
           }
         } else {
           setDefaultData();
         }
       }

      function setDefaultData() {
        // ê¸°ë³¸ê°’ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
        scheduleData = {
          transferInfo: {
            city: 'ì‹±ê°€í¬ë¥´',
            arrival: new Date(),
            departure: new Date(Date.now() + 4 * 60 * 60 * 1000),
            duration: 4 * 60 * 60 * 1000
          },
          type: 'airport-external',
          waypoints: [],
          completedAt: new Date().toISOString()
        };
        transferInfo = scheduleData.transferInfo;
      }

      // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateSummary() {
        if (!transferInfo) {
          // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
          document.getElementById('summary-city').textContent = 'ë°ì´í„° ì—†ìŒ';
          document.getElementById('summary-duration').textContent = '-';
          document.getElementById('summary-arrival').textContent = '-';
          document.getElementById('summary-departure').textContent = '-';
          document.getElementById('summary-style').textContent = '-';
          return;
        }

        document.getElementById('summary-city').textContent = transferInfo.city || 'ì‹±ê°€í¬ë¥´';
        document.getElementById('summary-duration').textContent = formatDuration(transferInfo.duration || 0);
        document.getElementById('summary-arrival').textContent = formatDateTime(transferInfo.arrival);
        document.getElementById('summary-departure').textContent = formatDateTime(transferInfo.departure);
        
        const styleText = scheduleData.type === 'airport-only' ? 'ê³µí•­ ë‚´ë¶€ë§Œ' : 'ê³µí•­ + ë„ì‹œ';
        document.getElementById('summary-style').textContent = styleText;
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatDuration(durationMs) {
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let result = '';
        if (hours > 0) result += `${hours}ì‹œê°„`;
        if (minutes > 0) result += ` ${minutes}ë¶„`;
        
        return result || '0ë¶„';
      }

      // ë‚ ì§œ ì‹œê°„ í¬ë§·íŒ…
      function formatDateTime(date) {
        if (!date) return '-';
        
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        
        return `${year}.${month}.${day} ${hours}:${minutes}`;
      }

      // ì¼ì • ê°œìš” ìƒì„±
      function generateScheduleOverview() {
        if (!scheduleData) {
          console.warn('generateScheduleOverview: scheduleDataê°€ ì—†ìŠµë‹ˆë‹¤');
          const container = document.getElementById('schedule-sections');
          if (container) {
            container.innerHTML = '<p class="empty-message">ì¼ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
          return;
        }
        
        const container = document.getElementById('schedule-sections');
        if (!container) {
          console.error('schedule-sections ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        container.innerHTML = '';

        if (scheduleData.type === 'airport-only') {
          generateAirportOnlySchedule(container);
        } else if (scheduleData.type === 'airport-external') {
          generateAirportExternalSchedule(container);
        }
      }

      // ê³µí•­ ë‚´ë¶€ë§Œ ì¼ì • ìƒì„±
      function generateAirportOnlySchedule(container) {
        const section = document.createElement('div');
        section.className = 'schedule-section airport-section';
        
        section.innerHTML = `
          <h3>ğŸ¢ ê³µí•­ ë‚´ë¶€ ì¼ì •</h3>
          <div class="timeline" id="airport-timeline">
            ${generateTimelineItems(scheduleData.airportPOIs || [], 'airport')}
          </div>
        `;
        
        container.appendChild(section);
      }

      // ê³µí•­ + ë„ì‹œ ì¼ì • ìƒì„±
      function generateAirportExternalSchedule(container) {
        // ê³µí•­ ë‚´ë¶€ ì„¹ì…˜
        const airportSection = document.createElement('div');
        airportSection.className = 'schedule-section airport-section';
        
        airportSection.innerHTML = `
          <h3>ğŸ¢ ê³µí•­ ë‚´ë¶€ ì¼ì •</h3>
          <div class="timeline" id="airport-timeline">
            ${generateTimelineItems(scheduleData.airportPOIs || [], 'airport')}
          </div>
        `;
        
        container.appendChild(airportSection);

        // ë„ì‹œ ì„¹ì…˜
        const citySection = document.createElement('div');
        citySection.className = 'schedule-section city-section';
        
        citySection.innerHTML = `
          <h3>ğŸ™ï¸ ë„ì‹œ íƒë°© ì¼ì •</h3>
          <div class="timeline" id="city-timeline">
            ${generateTimelineItems(scheduleData.cityPOIs || [], 'city')}
          </div>
        `;
        
        container.appendChild(citySection);
      }

      // ì‹¤ì œ ê³„ì‚°ëœ íƒ€ì„ë¼ì¸ ìƒì„± (navigation.htmlì—ì„œ ê³„ì‚°ëœ ì‹¤ì œ ì‹œê°„í‘œ ì‚¬ìš©)
      function generateActualTimeline(pois, actualTimeline) {
        if (!actualTimeline || actualTimeline.length === 0) {
          return '<p class="empty-timeline">ì‹¤ì œ ê³„ì‚°ëœ ì¼ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // arrivalTimeì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        let arrivalTime;
        if (transferInfo && transferInfo.arrival) {
          arrivalTime = new Date(transferInfo.arrival);
        } else {
          // ê¸°ë³¸ê°’ ì‚¬ìš© (í˜„ì¬ ì‹œê°„ + 2ì‹œê°„)
          arrivalTime = new Date(Date.now() + 2 * 60 * 60 * 1000);
        }
        
        let currentTime = new Date(arrivalTime);
        
        // ê³µí•­ ë‚´ë¶€ ì¼ì • í›„ ë„ì‹œ ì¼ì • ì‹œì‘
        currentTime.setHours(currentTime.getHours() + 2);

        return actualTimeline.map((segment, index) => {
          
          const poi = pois[index];
          const poiName = poi?.name || segment.toLabel || 'Unknown';
          const poiCategory = poi?.category || 'ê¸°íƒ€';
          
          // ì´ë™ ì‹œê°„ ê³„ì‚° (ì„¸ê·¸ë¨¼íŠ¸ì˜ durationì„ ë¶„ìœ¼ë¡œ ë³€í™˜)
          let travelTime = 0;
          if (segment.duration) {
            travelTime = Math.round(segment.duration / 60);
          } else if (segment.durationText) {
            // durationText íŒŒì‹± ì˜ˆ: "1ì‹œê°„ 23ë¶„"
            const match = segment.durationText.match(/(?:(\d+)ì‹œê°„)?\s*(?:(\d+)ë¶„)?/);
            if (match) {
              const hours = parseInt(match[1] || '0', 10);
              const minutes = parseInt(match[2] || '0', 10);
              travelTime = hours * 60 + minutes;
            }
          }
          
          // ì´ë™ ì¤‘ ì•„ì´í…œ
          const travelStartTime = new Date(currentTime);
          const travelEndTime = new Date(currentTime.getTime() + travelTime * 60000);
          const travelTimeItem = `
            <div class="timeline-item timeline-item--travel">
              <div class="timeline-time">
                <span class="start-time">${formatTime(travelStartTime)}</span>
                <span class="end-time">${formatTime(travelEndTime)}</span>
              </div>
              <div class="timeline-content">
                <h4>ğŸš¶ ì´ë™ ì¤‘</h4>
                <p>${travelTime}ë¶„ ì´ë™ (${segment.distanceText || ''})</p>
                <p class="details">${segment.fromLabel} â†’ ${segment.toLabel}</p>
              </div>
            </div>
          `;
          
          currentTime = travelEndTime;
          
          // ì²´ë¥˜ ì‹œê°„ ê³„ì‚° (POIì˜ estimatedTime ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©)
          const stayTime = poi?.estimatedTime || poi?.stayMinutes || 60;
          const stayStartTime = new Date(currentTime);
          const stayEndTime = new Date(currentTime.getTime() + stayTime * 60000);
          
          const timelineItem = `
            <div class="timeline-item">
              <div class="timeline-time">
                <span class="start-time">${formatTime(stayStartTime)}</span>
                <span class="end-time">${formatTime(stayEndTime)}</span>
              </div>
              <div class="timeline-content">
                <h4>${poiName}</h4>
                <span class="timeline-category">${poiCategory}</span>
                <p>${stayTime}ë¶„ ì²´ë¥˜</p>
                ${poi?.address ? `<p class="address">${poi.address}</p>` : ''}
              </div>
            </div>
          `;
          
          currentTime = stayEndTime;
          return travelTimeItem + timelineItem;
        }).join('');
      }

      // íƒ€ì„ë¼ì¸ ì•„ì´í…œ ìƒì„±
      function generateTimelineItems(pois, type) {
        if (!pois || pois.length === 0) {
          return '<p class="empty-timeline">ì„ íƒëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ì‹¤ì œ ê³„ì‚°ëœ íƒ€ì„ë¼ì¸ì´ ìˆìœ¼ë©´ ì‚¬ìš©
        if (scheduleData.actualTimeline && type === 'city') {
          return generateActualTimeline(pois, scheduleData.actualTimeline);
        } else if (type === 'airport') {
          // ê³µí•­ ì¼ì •ì€ í•­ìƒ ì¶”ì •ê°’ ì‚¬ìš© (ì‹¤ì œ ê³„ì‚°ëœ ê²½ë¡œ ì—†ìŒ)
        }

        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        // ë„ì‹œ ì¼ì •ì˜ ê²½ìš° ê³µí•­ ë‚´ë¶€ ì¼ì • í›„ ì‹œì‘
        if (type === 'city') {
          currentTime.setHours(currentTime.getHours() + 2);
        }

        return pois.map((poi, index) => {
          // POIê°€ IDì¸ì§€ ê°ì²´ì¸ì§€ í™•ì¸
          const poiData = typeof poi === 'object' ? poi : { id: poi, name: 'Unknown', estimatedTime: 10 };
          
          const poiName = poiData.name || 'Unknown';
          const poiCategory = poiData.category || 'ê¸°íƒ€';
          const estimatedTime = poiData.estimatedTime || poiData.stayMinutes || 10;
          const travelTime = poiData.travelTime || 0; // ì´ì „ ê²½ìœ ì§€ì—ì„œ ì´ë™ ì‹œê°„

          // ì²« ë²ˆì§¸ ê²½ìœ ì§€ê°€ ì•„ë‹ˆê³  ì´ë™ ì‹œê°„ì´ ìˆëŠ” ê²½ìš° ì´ë™ ì‹œê°„ í‘œì‹œ
          let travelTimeItem = '';
          if (index > 0 && travelTime > 0) {
            const travelStartTime = new Date(currentTime);
            const travelEndTime = new Date(currentTime.getTime() + travelTime * 60000);
            travelTimeItem = `
              <div class="timeline-item timeline-item--travel">
                <div class="timeline-time">
                  <span class="start-time">${formatTime(travelStartTime)}</span>
                  <span class="end-time">${formatTime(travelEndTime)}</span>
                </div>
                <div class="timeline-content">
                  <h4>ğŸš¶ ì´ë™ ì¤‘</h4>
                  <p>${travelTime}ë¶„ ì´ë™</p>
                </div>
              </div>
            `;
            currentTime = travelEndTime;
          }

          const startTime = new Date(currentTime);
          const endTime = new Date(currentTime.getTime() + estimatedTime * 60000);
          
          const timelineItem = `
            ${travelTimeItem}
            <div class="timeline-item">
              <div class="timeline-time">
                <span class="start-time">${formatTime(startTime)}</span>
                <span class="end-time">${formatTime(endTime)}</span>
              </div>
              <div class="timeline-content">
                <h4>${poiName}</h4>
                <span class="timeline-category">${poiCategory}</span>
                <p>${estimatedTime}ë¶„ ì²´ë¥˜</p>
                ${poiData.address ? `<p class="address">${poiData.address}</p>` : ''}
              </div>
            </div>
          `;
          
          currentTime = endTime;
          return timelineItem;
        }).join('');
      }

      // ì‹œê°„ í¬ë§·íŒ… (HH:MM)
      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // durationText("1ì‹œê°„ 23ë¶„", "23ë¶„", "1h 23m" ë“±) â†’ ì´ˆ ë‹¨ìœ„ë¡œ íŒŒì‹±
      function parseDurationTextToSeconds(text) {
        if (!text || typeof text !== 'string') return 0;
        const t = text.trim();
        // í•œê¸€ íŒ¨í„´
        const kr = t.match(/(?:(\d+)\s*ì‹œê°„)?\s*(?:(\d+)\s*ë¶„)?/);
        if (kr && (kr[1] || kr[2])) {
          const h = parseInt(kr[1] || '0', 10);
          const m = parseInt(kr[2] || '0', 10);
          return (h * 60 + m) * 60;
        }
        // ì˜ë¬¸ íŒ¨í„´
        const en = t.match(/(?:(\d+)\s*h(?:ours?)?)?\s*(?:(\d+)\s*m(?:in(?:utes?)?)?)?/i);
        if (en && (en[1] || en[2])) {
          const h = parseInt(en[1] || '0', 10);
          const m = parseInt(en[2] || '0', 10);
          return (h * 60 + m) * 60;
        }
        // ìˆ«ì + ë¶„ë§Œ
        const onlyMin = t.match(/^(\d+)\s*ë¶„?$/);
        if (onlyMin) return parseInt(onlyMin[1], 10) * 60;
        return 0;
      }

      // í†µê³„ ì—…ë°ì´íŠ¸ (ì‹¤ì œ ê°’ ë°˜ì˜)
      function updateStats() {
        if (!scheduleData) {
          console.warn('updateStats: scheduleDataê°€ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        // ë°©ë¬¸ ì¥ì†Œ ìˆ˜
        const airportCount = Array.isArray(scheduleData.airportPOIs) ? scheduleData.airportPOIs.length : 0;
        const cityCount = Array.isArray(scheduleData.cityPOIs) ? scheduleData.cityPOIs.length : 0;
        const totalLocations = airportCount + cityCount;
        
        const totalLocationsEl = document.getElementById('total-locations');
        if (totalLocationsEl) totalLocationsEl.textContent = totalLocations;

        // ì‹¤ì œ ì´ë™ ì‹œê°„(ì´ˆ): ì‹¤ì œ íƒ€ì„ë¼ì¸ì´ ìˆìœ¼ë©´ í•©ì‚°, ì—†ìœ¼ë©´ ê°„ì´ ì¶”ì •
        const hasActual = Array.isArray(scheduleData.actualTimeline) && scheduleData.actualTimeline.length > 0;
        let travelSeconds = 0;
        if (hasActual) {
          travelSeconds = scheduleData.actualTimeline.reduce((sum, seg) => {
            // 1) ì´ˆ ë‹¨ìœ„ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
            const dSec = Number(seg?.duration) || 0;
            if (dSec > 0) return sum + dSec;
            // 2) í…ìŠ¤íŠ¸ íŒŒì‹±
            const dTxtSec = parseDurationTextToSeconds(seg?.durationText);
            if (dTxtSec > 0) return sum + dTxtSec;
            // 3) í•˜ìœ„ legs durationText í•©ì‚°
            if (Array.isArray(seg?.legs) && seg.legs.length > 0) {
              const legsSec = seg.legs.reduce((acc, leg) => acc + parseDurationTextToSeconds(leg?.durationText), 0);
              return sum + legsSec;
            }
            return sum;
          }, 0);
        } else {
          // í´ë°±: ê²½ìœ ì§€ ì‚¬ì´ 15ë¶„ìœ¼ë¡œ ì¶”ì •
          travelSeconds = Math.max(0, totalLocations - 1) * 15 * 60;
        }

        // ì²´ë¥˜ ì‹œê°„(ë¶„): ëª¨ë“  POIì˜ estimatedTime/stayMinutes í•©ì‚°
        const stayMinutesAirport = (scheduleData.airportPOIs || []).reduce((sum, p) => {
          const m = Number(p?.estimatedTime ?? p?.stayMinutes ?? 0) || 0;
          return sum + m;
        }, 0);
        const stayMinutesCity = (scheduleData.cityPOIs || []).reduce((sum, p) => {
          const m = Number(p?.estimatedTime ?? p?.stayMinutes ?? 0) || 0;
          return sum + m;
        }, 0);
        const stayMinutesTotal = stayMinutesAirport + stayMinutesCity;

        // ì¶œë ¥: ì´ë™ì‹œê°„(ë¶„), ì´ ì†Œìš”ì‹œê°„(ë¶„)
        const walkingTimeEl = document.getElementById('walking-time');
        const totalTimeEl = document.getElementById('total-time');

        const travelMinutes = Math.round(travelSeconds / 60);
        const totalMinutes = Math.max(0, travelMinutes + stayMinutesTotal);

        if (walkingTimeEl) walkingTimeEl.textContent = `${travelMinutes}ë¶„`;
        if (totalTimeEl) totalTimeEl.textContent = `${totalMinutes}ë¶„`;

        // ë””ë²„ê¹… ë¡œê·¸
        console.log('ğŸ“Š [trip-summary] í†µê³„ ê³„ì‚°', {
          airportCount,
          cityCount,
          totalLocations,
          hasActualTimeline: hasActual,
          travelSeconds,
          travelMinutes,
          stayMinutesAirport,
          stayMinutesCity,
          stayMinutesTotal,
          totalMinutes
        });
      }

      // íŒ ìƒì„±
      function generateTips() {
        const container = document.getElementById('tips-grid');
        if (!container) {
          console.error('tips-grid ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        if (!scheduleData) {
          console.warn('generateTips: scheduleDataê°€ ì—†ìŠµë‹ˆë‹¤');
          container.innerHTML = '';
          return;
        }
        
        const tips = getTipsForSchedule(scheduleData);
        
        container.innerHTML = tips.map(tip => `
          <div class="tip-card">
            <div class="tip-icon">${tip.icon}</div>
            <h4>${tip.title}</h4>
            <p>${tip.description}</p>
          </div>
        `).join('');
      }

      // ì¼ì •ì— ë”°ë¥¸ íŒ ê°€ì ¸ì˜¤ê¸°
      function getTipsForSchedule(schedule) {
        if (!schedule) {
          console.warn('getTipsForSchedule: scheduleì´ nullì…ë‹ˆë‹¤');
          return [];
        }
        
        const baseTips = [
          {
            icon: 'ğŸ’',
            title: 'ì§ ë³´ê´€ì†Œ',
            description: 'ê³µí•­ ë‚´ ì§ ë³´ê´€ì†Œë¥¼ ì´ìš©í•˜ë©´ ê°€ë²¼ìš´ ì‡¼í•‘ê³¼ ê´€ê´‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
          },
          {
            icon: 'ğŸ“¶',
            title: 'ë¬´ë£Œ ì™€ì´íŒŒì´',
            description: 'ê³µí•­ ë‚´ ë¬´ë£Œ ì™€ì´íŒŒì´ë¥¼ ì—°ê²°í•˜ì—¬ ì‹¤ì‹œê°„ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
          },
          {
            icon: 'â°',
            title: 'ì‹œê°„ ê´€ë¦¬',
            description: 'ì¶œë°œ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ì—¬ìœ  ì‹œê°„ì„ í™•ë³´í•˜ì„¸ìš”.'
          }
        ];

        if (schedule.type === 'airport-external') {
          baseTips.push(
            {
              icon: 'ğŸš‡',
              title: 'êµí†µí¸',
              description: 'ê³µí•­ì—ì„œ ë„ì‹œê¹Œì§€ì˜ êµí†µí¸ì„ ë¯¸ë¦¬ í™•ì¸í•˜ê³  ì‹œê°„ì„ ê³ ë ¤í•˜ì„¸ìš”.'
            },
            {
              icon: 'ğŸ—ºï¸',
              title: 'ì§€ë„ ì•±',
              description: 'ì˜¤í”„ë¼ì¸ ì§€ë„ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì¸í„°ë„· ì—†ì´ë„ ê¸¸ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
            }
          );
        }

        return baseTips;
      }

      // ===== ë¦¬ë·° ê´€ë ¨ í•¨ìˆ˜ =====
      
      // ë³„ì  í´ë¦­ ì´ë²¤íŠ¸
      function initStarRatings() {
        // ì „ì²´ ì—¬ì • ë¦¬ë·° ë³„ì 
        const overallRating = document.getElementById('overall-rating');
        if (overallRating) {
          const stars = overallRating.querySelectorAll('.star');
          const ratingText = document.getElementById('rating-text');
          
          stars.forEach(star => {
            star.addEventListener('click', function() {
              const value = parseInt(this.dataset.value);
              overallRating.dataset.rating = value;
              
              // ë³„ì  í‘œì‹œ ì—…ë°ì´íŠ¸
              stars.forEach((s, index) => {
                if (index < value) {
                  s.classList.add('active');
                } else {
                  s.classList.remove('active');
                }
              });
              
              // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
              const texts = ['', 'ë³„ë¡œì˜ˆìš”', 'ì•„ì‰¬ì›Œìš”', 'ë³´í†µì´ì—ìš”', 'ì¢‹ì•„ìš”', 'ì™„ë²½í•´ìš”'];
              if (ratingText) {
                ratingText.textContent = texts[value] || 'í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
              }
            });
            
            // í˜¸ë²„ íš¨ê³¼
            star.addEventListener('mouseenter', function() {
              const value = parseInt(this.dataset.value);
              stars.forEach((s, index) => {
                if (index < value) {
                  s.classList.add('hover');
                } else {
                  s.classList.remove('hover');
                }
              });
            });
          });
          
          overallRating.addEventListener('mouseleave', function() {
            const currentRating = parseInt(overallRating.dataset.rating || 0);
            stars.forEach((s, index) => {
              s.classList.remove('hover');
              if (index < currentRating) {
                s.classList.add('active');
              } else {
                s.classList.remove('active');
              }
            });
          });
        }
      }

      // ì¥ì†Œ ë¦¬ë·° í† ê¸€
      function togglePlaceReviews() {
        const container = document.getElementById('place-reviews-container');
        const toggleText = document.getElementById('toggle-text');
        
        if (!container) return;
        
        if (container.style.display === 'none') {
          container.style.display = 'block';
          if (toggleText) toggleText.textContent = 'ì ‘ê¸°';
          loadPlaceReviewList();
        } else {
          container.style.display = 'none';
          if (toggleText) toggleText.textContent = 'í¼ì¹˜ê¸°';
        }
      }

      // ì¥ì†Œ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
      function loadPlaceReviewList() {
        const container = document.getElementById('place-reviews-list');
        if (!container || !scheduleData) return;
        
        const allPOIs = [
          ...(scheduleData.airportPOIs || []),
          ...(scheduleData.cityPOIs || [])
        ];
        
        if (allPOIs.length === 0) {
          container.innerHTML = '<p class="empty-place-reviews">ë°©ë¬¸í•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = allPOIs.map(poi => `
          <div class="place-review-item" data-poi-id="${poi.id}">
            <div class="place-review-header">
              <div class="place-info">
                <span class="place-icon">${poi.categoryIcon || 'ğŸ“'}</span>
                <div>
                  <h4>${poi.name}</h4>
                  <p class="place-category">${poi.category || 'ê¸°íƒ€'}</p>
                </div>
              </div>
              <label class="review-toggle">
                <input type="checkbox" class="review-checkbox" data-poi-id="${poi.id}" />
                <span>ë¦¬ë·° ì‘ì„±í•˜ê¸°</span>
              </label>
            </div>
            
            <div class="place-review-form" style="display: none;">
              <div class="rating-input">
                <label>í‰ì </label>
                <div class="star-rating place-rating" data-poi-id="${poi.id}" data-rating="0">
                  <span class="star" data-value="1">â­</span>
                  <span class="star" data-value="2">â­</span>
                  <span class="star" data-value="3">â­</span>
                  <span class="star" data-value="4">â­</span>
                  <span class="star" data-value="5">â­</span>
                </div>
              </div>
              <textarea class="place-comment" 
                        data-poi-id="${poi.id}"
                        placeholder="ì´ ì¥ì†Œì— ëŒ€í•œ í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”..."
                        rows="2"
                        maxlength="500"></textarea>
              <span class="char-count place-char-count" data-poi-id="${poi.id}"><span class="place-char-num">0</span>/500</span>
            </div>
          </div>
        `).join('');
        
        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        container.querySelectorAll('.review-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const poiId = this.dataset.poiId;
            const form = this.closest('.place-review-item').querySelector('.place-review-form');
            if (form) {
              form.style.display = this.checked ? 'block' : 'none';
              if (this.checked) {
                initPlaceStarRating(poiId);
                initPlaceCommentCounter(poiId);
              }
            }
          });
        });
      }

      // ì¥ì†Œë³„ ë³„ì  ì´ˆê¸°í™”
      function initPlaceStarRating(poiId) {
        const ratingEl = document.querySelector(`.place-rating[data-poi-id="${poiId}"]`);
        if (!ratingEl) return;
        
        const stars = ratingEl.querySelectorAll('.star');
        
        stars.forEach(star => {
          star.addEventListener('click', function() {
            const value = parseInt(this.dataset.value);
            ratingEl.dataset.rating = value;
            
            stars.forEach((s, index) => {
              if (index < value) {
                s.classList.add('active');
              } else {
                s.classList.remove('active');
              }
            });
          });
        });
      }

      // ì¥ì†Œ ì½”ë©˜íŠ¸ ê¸€ì ìˆ˜ ì¹´ìš´í„°
      function initPlaceCommentCounter(poiId) {
        const textarea = document.querySelector(`.place-comment[data-poi-id="${poiId}"]`);
        const counter = document.querySelector(`.place-char-count[data-poi-id="${poiId}"] .place-char-num`);
        
        if (textarea && counter) {
          textarea.addEventListener('input', function() {
            counter.textContent = this.value.length;
          });
        }
      }

      // POI ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      function getPOIData(poiId) {
        if (!scheduleData) return null;
        
        const allPOIs = [
          ...(scheduleData.airportPOIs || []),
          ...(scheduleData.cityPOIs || [])
        ];
        
        return allPOIs.find(poi => poi.id === poiId);
      }

      // ì„ íƒëœ ì¥ì†Œ ë¦¬ë·° ìˆ˜ì§‘
      function getSelectedPlaceReviews() {
        const placeReviews = [];
        const checkboxes = document.querySelectorAll('.review-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
          const poiId = checkbox.dataset.poiId;
          const ratingEl = document.querySelector(`.place-rating[data-poi-id="${poiId}"]`);
          const commentEl = document.querySelector(`.place-comment[data-poi-id="${poiId}"]`);
          const poiData = getPOIData(poiId);
          
          if (!poiData || !ratingEl) return;
          
          const rating = parseInt(ratingEl.dataset.rating || 0);
          if (rating === 0) return; // í‰ì ì´ ì—†ìœ¼ë©´ ì œì™¸
          
          placeReviews.push({
            poiId: poiId,
            poiName: poiData.name,
            poiCategory: poiData.category || '',
            poiCategoryIcon: poiData.categoryIcon || '',
            poiLocation: poiData.address || poiData.location || '',
            rating: rating,
            comment: commentEl ? commentEl.value.trim() : ''
          });
        });
        
        return placeReviews;
      }

      // ë„ì‹œ ì´ë¦„ ì •ê·œí™” í•¨ìˆ˜
      function normalizeCityName(city) {
        if (!city) return '';
        
        const cityNameMap = {
          'ì‹±ê°€í¬ë¥´': 'Singapore',
          'Singapore': 'Singapore',
          'ì„œìš¸': 'Seoul',
          'Seoul': 'Seoul',
          'ë„ì¿„': 'Tokyo',
          'Tokyo': 'Tokyo',
          'ë°©ì½•': 'Bangkok',
          'Bangkok': 'Bangkok'
        };
        
        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
        if (cityNameMap[city]) {
          return cityNameMap[city];
        }
        
        // ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë§¤ì¹­
        const cityLower = city.toLowerCase();
        for (const [key, value] of Object.entries(cityNameMap)) {
          if (key.toLowerCase() === cityLower) {
            return value;
          }
        }
        
        // ë§¤í•‘ë˜ì§€ ì•Šìœ¼ë©´ ì›ë³¸ ë°˜í™˜
        return city;
      }

      // ë¦¬ë·° ì €ì¥
      async function submitReview() {
        try {
          // ë¡œê·¸ì¸ í™•ì¸
          if (window.requireAuth) {
            const authenticated = await window.requireAuth('ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            if (!authenticated) {
              return; // ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì§„í–‰í•˜ì§€ ì•ŠìŒ
            }
          }
          
          // ì „ì²´ ë¦¬ë·° ê²€ì¦
          const overallRating = parseInt(document.getElementById('overall-rating').dataset.rating || 0);
          if (overallRating === 0) {
            alert('â­ ì „ì²´ ë§Œì¡±ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }

          const summary = document.getElementById('trip-review-summary').value.trim();
          if (!summary) {
            alert('ğŸ“ í•œ ì¤„ í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.');
            return;
          }

          // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
          const userId = window.getUserId ? await window.getUserId() : null;
          if (!userId) {
            alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            return;
          }

          // ë¦¬ë·° DB ì´ˆê¸°í™”
          await window.reviewDB.initialize();

          // ë„ì‹œ ì´ë¦„ ì •ê·œí™”
          const normalizedCity = normalizeCityName(transferInfo.city);
          console.log('ğŸ’¾ ë¦¬ë·° ì €ì¥ - ë„ì‹œ ì´ë¦„ ì •ê·œí™”:', {
            original: transferInfo.city,
            normalized: normalizedCity
          });

          // ë¦¬ë·° ë°ì´í„° êµ¬ì„±
          const reviewData = {
            userId: userId, // ì‚¬ìš©ì ID ì¶”ê°€
            overallReview: {
              rating: overallRating,
              summary: summary,
              detail: document.getElementById('trip-review-detail').value.trim()
            },
            tripInfo: {
              city: normalizedCity, // ì •ê·œí™”ëœ ë„ì‹œ ì´ë¦„ ì‚¬ìš©
              duration: transferInfo.duration,
              visitCount: (scheduleData.airportPOIs?.length || 0) + (scheduleData.cityPOIs?.length || 0),
              tripType: scheduleData.type,
              arrival: transferInfo.arrival,
              departure: transferInfo.departure
            },
            placeReviews: getSelectedPlaceReviews()
          };

          // ë¦¬ë·° ì €ì¥
          const reviewId = await window.reviewDB.saveTripReview(reviewData);
          
          // ì„±ê³µ ë©”ì‹œì§€
          alert('âœ… ë¦¬ë·°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në‹¤ë¥¸ ì—¬í–‰ìë“¤ì—ê²Œ ë„ì›€ì´ ë  ê±°ì˜ˆìš”. ê°ì‚¬í•©ë‹ˆë‹¤!');
          
          // ë¦¬ë·° ì„¹ì…˜ ìˆ¨ê¸°ê¸° ë˜ëŠ” ì™„ë£Œ ìƒíƒœ í‘œì‹œ
          const reviewSection = document.querySelector('.review-section');
          if (reviewSection) {
            reviewSection.innerHTML = `
              <div class="review-completed">
                <div class="review-completed-icon">âœ…</div>
                <h3>ë¦¬ë·°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                <p>ì†Œì¤‘í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
              </div>
            `;
          }

        } catch (error) {
          console.error('ë¦¬ë·° ì €ì¥ ì‹¤íŒ¨:', error);
          alert('âŒ ë¦¬ë·° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      // ë¦¬ë·° ê±´ë„ˆë›°ê¸°
      function skipReview() {
        if (confirm('ë¦¬ë·° ì‘ì„±ì„ ê±´ë„ˆë›°ì‹œê² ìŠµë‹ˆê¹Œ?\në‚˜ì¤‘ì— ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
          const reviewSection = document.querySelector('.review-section');
          if (reviewSection) {
            reviewSection.style.display = 'none';
          }
        }
      }

      // ê¸€ì ìˆ˜ ì¹´ìš´í„° ì´ˆê¸°í™”
      function initCharCounters() {
        const summaryInput = document.getElementById('trip-review-summary');
        const summaryCounter = document.getElementById('summary-char-count');
        const detailInput = document.getElementById('trip-review-detail');
        const detailCounter = document.getElementById('detail-char-count');
        
        if (summaryInput && summaryCounter) {
          summaryInput.addEventListener('input', function() {
            summaryCounter.textContent = this.value.length;
          });
        }
        
        if (detailInput && detailCounter) {
          detailInput.addEventListener('input', function() {
            detailCounter.textContent = this.value.length;
          });
        }
      }

      // ì¼ì • ìˆ˜ì •í•˜ê¸°
      // í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
      function goToHome() {
        window.location.href = 'index.html';
      }

      // ì¼ì • ê³µìœ í•˜ê¸°
      function shareSchedule(type) {
        if (type === 'link') {
          // ë§í¬ ê³µìœ  ë¡œì§
          const shareUrl = window.location.origin + window.location.pathname;
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          });
        } else if (type === 'image') {
          // ì´ë¯¸ì§€ ì €ì¥ ë¡œì§
          alert('ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }
      }

      // ê³µí†µ CTA ê¸°ëŠ¥: ì¼ì • ì €ì¥(PDF), ì¼ì • ê³µìœ (í…ìŠ¤íŠ¸)
      async function saveSummaryPDF() {
        try {
          const target = document.querySelector('.trip-summary-main');
          if (!target) {
            alert('ì €ì¥í•  ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          const canvas = await html2canvas(target, {
            useCORS: true,
            scale: 2,
            backgroundColor: '#ffffff'
          });

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

          const imgWidth = 210;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          const imgData = canvas.toDataURL('image/png');

          let heightLeft = imgHeight;
          let position = 0;
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= 297;

          while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= 297;
          }

          const city = scheduleData?.transferInfo?.city || 'ì—¬í–‰';
          const datePart = new Date().toISOString().split('T')[0];
          pdf.save(`ì „ì²´ì¼ì •_${city}_${datePart}.pdf`);
          alert('âœ… PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
          console.error('PDF ì €ì¥ ì‹¤íŒ¨:', error);
          alert('âŒ PDF ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      function shareSummary() {
        try {
          if (!scheduleData) {
            alert('ê³µìœ í•  ì¼ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          const t = scheduleData.transferInfo || {};
          const typeText = scheduleData.type === 'airport-only' ? 'ê³µí•­ ë‚´ë¶€ë§Œ' : 'ê³µí•­ + ë„ì‹œ';
          const arrival = t.arrival ? new Date(t.arrival).toLocaleString() : '-';
          const departure = t.departure ? new Date(t.departure).toLocaleString() : '-';
          const durationMin = (t.duration || 0) / 60000;

          let text = '';
          text += `âœˆï¸ Via Flight - ì „ì²´ ì—¬í–‰ ì¼ì •\n\n`;
          text += `ë„ì‹œ: ${t.city || '-'}\n`;
          text += `ì—¬í–‰ ìŠ¤íƒ€ì¼: ${typeText}\n`;
          text += `ë„ì°©: ${arrival}\n`;
          text += `ì¶œë°œ: ${departure}\n`;
          text += `í™˜ìŠ¹ ì‹œê°„: ${durationMin}ë¶„\n\n`;

          if (scheduleData.airportPOIs?.length) {
            text += `ğŸ¢ ê³µí•­ ë‚´ë¶€ ì¼ì •\n`;
            scheduleData.airportPOIs.forEach((p, i) => {
              text += `${i + 1}. ${p.name} (${p.category || 'ê¸°íƒ€'}) - ${p.estimatedTime || 10}ë¶„`;
              if (p.address) text += ` | ${p.address}`;
              text += `\n`;
            });
            text += `\n`;
          }
          if (scheduleData.cityPOIs?.length) {
            text += `ğŸ™ï¸ ë„ì‹œ íƒë°© ì¼ì •\n`;
            scheduleData.cityPOIs.forEach((p, i) => {
              text += `${i + 1}. ${p.name} (${p.category || 'ê¸°íƒ€'}) - ${p.estimatedTime || p.stayMinutes || 10}ë¶„`;
              if (p.address) text += ` | ${p.address}`;
              text += `\n`;
            });
            text += `\n`;
          }

          navigator.clipboard.writeText(text).then(() => {
            alert('âœ… ì¼ì •ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            alert('âœ… ì¼ì •ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          });
        } catch (e) {
          console.error('ì¼ì • ê³µìœ  ì‹¤íŒ¨:', e);
          alert('âŒ ì¼ì • ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ì´ë©”ì¼ ì „ì†¡(ì„œë¹„ìŠ¤ ê³„ì • From ê³ ì •, Reply-To ìƒëµ): ìµœì†Œ êµ¬í˜„
      async function sendSummaryByEmail() {
        try {
          const to = (document.getElementById('share-email-to')?.value || '').trim();
          const emailRx = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
          if (!emailRx.test(to)) { alert('ë°›ëŠ” ì´ë©”ì¼ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

          const target = document.querySelector('.trip-summary-main');
          if (!target) { alert('ì „ì†¡í•  ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

          const canvas = await html2canvas(target, { useCORS: true, scale: 2, backgroundColor: '#ffffff' });
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
          const imgWidth = 210;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          const imgData = canvas.toDataURL('image/png');
          let heightLeft = imgHeight, position = 0;
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= 297;
          while (heightLeft > 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= 297; }
          const base64 = pdf.output('datauristring').split(',')[1];

          const res = await fetch('/api/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to,
              subject: 'Via Flight - ì „ì²´ ì—¬í–‰ ì¼ì • PDF',
              text: 'ì•ˆë…•í•˜ì„¸ìš”! ìš”ì²­í•˜ì‹  ì—¬í–‰ ì¼ì • PDFë¥¼ ì²¨ë¶€ë“œë¦½ë‹ˆë‹¤.',
              attachment: {
                filename: `viaflight_itinerary_${new Date().toISOString().slice(0,10)}.pdf`,
                contentType: 'application/pdf',
                base64
              }
            })
          });
          if (res.ok) { alert('âœ… ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!'); return; }

          // Fallback: ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ Resend API í˜¸ì¶œ(ë¡œì»¬/ì •ì  í…ŒìŠ¤íŠ¸ìš©)
          if (window.RESEND_API_KEY) {
            const fromAddr = window.EMAIL_FROM || 'onboarding@resend.dev';
            const apiRes = await fetch('https://api.resend.com/emails', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${window.RESEND_API_KEY}`,
              },
              body: JSON.stringify({
                from: fromAddr,
                to,
                subject: 'Via Flight - ì „ì²´ ì—¬í–‰ ì¼ì • PDF',
                text: 'ì•ˆë…•í•˜ì„¸ìš”! ìš”ì²­í•˜ì‹  ì—¬í–‰ ì¼ì • PDFë¥¼ ì²¨ë¶€ë“œë¦½ë‹ˆë‹¤.',
                attachments: [{
                  filename: `viaflight_itinerary_${new Date().toISOString().slice(0,10)}.pdf`,
                  content: base64,
                  contentType: 'application/pdf'
                }]
              })
            });
            if (!apiRes.ok) throw new Error('Resend direct API failed');
            alert('âœ… ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            return;
          }

          throw new Error('ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨');
        } catch (e) {
          console.error(e);
          alert('âŒ ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      // ì¼ì • ì €ì¥ ëª¨ë‹¬ ì—´ê¸°
      window.openSaveScheduleModal = function() {
        // ë¡œê·¸ì¸ í™•ì¸
        if (window.requireAuth) {
          window.requireAuth('ì¼ì •ì„ ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.').then(authenticated => {
            if (authenticated) {
              const modal = document.getElementById('save-schedule-modal');
              if (modal) {
                modal.style.display = 'flex';
                const input = document.getElementById('schedule-name-input');
                if (input) {
                  input.value = '';
                  input.focus();
                }
              }
            }
          });
        } else {
          const modal = document.getElementById('save-schedule-modal');
          if (modal) {
            modal.style.display = 'flex';
            const input = document.getElementById('schedule-name-input');
            if (input) {
              input.value = '';
              input.focus();
            }
          }
        }
      };

      // ì¼ì • ì €ì¥ ëª¨ë‹¬ ë‹«ê¸°
      window.closeSaveScheduleModal = function() {
        const modal = document.getElementById('save-schedule-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      };

      // ì¼ì • ì €ì¥
      window.saveScheduleToDB = async function() {
        try {
          const scheduleName = document.getElementById('schedule-name-input')?.value?.trim();
          if (!scheduleName) {
            alert('ì¼ì • ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }

          if (scheduleName.length > 50) {
            alert('ì¼ì • ì´ë¦„ì€ 50ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
            return;
          }

          // ì‚¬ìš©ì ID í™•ì¸
          const userId = window.getUserId ? await window.getUserId() : null;
          if (!userId) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
          }

          // finalTripPlanê³¼ scheduleData ê°€ì ¸ì˜¤ê¸°
          const finalTripPlanStr = sessionStorage.getItem('finalTripPlan');
          if (!finalTripPlanStr) {
            alert('ì¼ì • ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          const finalTripPlan = JSON.parse(finalTripPlanStr);
          
          // scheduleDataëŠ” ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
          if (!scheduleData) {
            alert('ì¼ì • ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          // ì¼ì • ì €ì¥
          await window.saveSchedule(userId, scheduleName, finalTripPlan, scheduleData);
          
          // ì €ì¥ ì™„ë£Œ ë©”ì‹œì§€ë¡œ ì„¹ì…˜ ë³€ê²½
          const saveSection = document.querySelector('.save-schedule-section');
          if (saveSection) {
            saveSection.innerHTML = `
              <div class="save-schedule-container">
                <div class="save-schedule-completed">
                  <div class="save-schedule-completed-icon">âœ…</div>
                  <h2 class="save-schedule-title">ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                  <p class="save-schedule-description">
                    ë§ˆì´ í˜ì´ì§€ì—ì„œ ì €ì¥ëœ ì¼ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            `;
          }
          
          closeSaveScheduleModal();
          
        } catch (error) {
          console.error('ì¼ì • ì €ì¥ ì‹¤íŒ¨:', error);
          alert('âŒ ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      };

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', (e) => {
        const modal = document.getElementById('save-schedule-modal');
        if (modal && e.target === modal) {
          closeSaveScheduleModal();
        }
      });

      // Enter í‚¤ë¡œ ì €ì¥
      document.addEventListener('keydown', (e) => {
        const modal = document.getElementById('save-schedule-modal');
        if (modal && modal.style.display !== 'none') {
          if (e.key === 'Enter') {
            saveScheduleToDB();
          } else if (e.key === 'Escape') {
            closeSaveScheduleModal();
          }
        }
      });
    </script>
  </body>
</html>
