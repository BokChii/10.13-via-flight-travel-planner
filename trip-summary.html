<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <title>여행 일정 요약 - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/trip-summary.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
    <link rel="stylesheet" href="styles/components/forms.css" />
  </head>
  <body class="app trip-summary-page">
    <header class="app-header">
      <h1>Via Flight</h1>
      <p class="tagline">여행 일정 요약</p>
      <nav class="breadcrumb">
        <a href="landing.html" class="breadcrumb__link">← 홈으로</a>
      </nav>
    </header>

    <main class="trip-summary-main">
      <!-- Transfer Summary -->
      <section class="transfer-summary">
        <div class="summary-card">
          <h2 class="summary-title">여행 정보</h2>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">경유 도시</span>
              <span class="summary-value" id="summary-city">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">환승 시간</span>
              <span class="summary-value" id="summary-duration">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">도착 시간</span>
              <span class="summary-value" id="summary-arrival">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">출발 시간</span>
              <span class="summary-value" id="summary-departure">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">여행 스타일</span>
              <span class="summary-value" id="summary-style">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Schedule Overview -->
      <section class="schedule-overview">
        <div class="overview-container">
          <h2 class="overview-title">전체 일정</h2>
          <p class="overview-description">
            선택하신 장소들로 구성된 최적의 여행 일정입니다.
          </p>

          <div class="schedule-sections" id="schedule-sections">
            <!-- 동적으로 생성됨 -->
          </div>

          <div class="schedule-stats">
            <div class="stat-card">
              <div class="stat-icon">📍</div>
              <div class="stat-content">
                <div class="stat-number" id="total-locations">0</div>
                <div class="stat-label">방문 장소</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">⏱️</div>
              <div class="stat-content">
                <div class="stat-number" id="total-time">0분</div>
                <div class="stat-label">총 소요시간</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">🚶</div>
              <div class="stat-content">
                <div class="stat-number" id="walking-time">0분</div>
                <div class="stat-label">이동시간</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tips and Recommendations -->
      <section class="tips-section">
        <div class="tips-container">
          <h2 class="tips-title">💡 여행 팁</h2>
          <div class="tips-grid" id="tips-grid">
            <!-- 동적으로 생성됨 -->
          </div>
        </div>
      </section>

      <!-- Action Buttons -->
      <section class="action-section">
        <div class="action-container">
          <div class="completion-message">
            <h2>🎉 환승 여행을 완료하셨습니다!</h2>
            <p>소중한 여행의 기록을 공유하고 저장해보세요.</p>
          </div>
          
          <div class="share-section">
            <h3>일정 공유하기</h3>
            <div class="share-buttons">
              <button class="btn btn--small btn--ghost" onclick="shareSchedule('link')">
                링크 공유
              </button>
              <button class="btn btn--small btn--ghost" onclick="shareSchedule('image')">
                이미지 저장
              </button>
              <button class="btn btn--small btn--secondary" onclick="shareSchedule('text')">
                텍스트 복사
              </button>
            </div>
          </div>
          
          <div class="action-buttons">
            <button class="btn btn--primary" onclick="goToHome()">
              🏠 홈으로 돌아가기
            </button>
          </div>
        </div>
      </section>
    </main>

    <script type="module" src="scripts/router.js"></script>
    <script>
      // 전역 상태
      let scheduleData = null;
      let transferInfo = null;

      // 페이지 로드 시 초기화
      document.addEventListener('DOMContentLoaded', function() {
        try {
          loadScheduleData();
          
          if (!scheduleData) {
            console.warn('⚠️ scheduleData가 없습니다. 기본 데이터로 진행');
            setDefaultData();
          }
          
          if (transferInfo) {
            try {
              updateSummary();
            } catch (error) {
              console.error('updateSummary 오류:', error);
            }
          }
          
          try {
            generateScheduleOverview();
          } catch (error) {
            console.error('generateScheduleOverview 오류:', error);
          }
          
          try {
            updateStats();
          } catch (error) {
            console.error('updateStats 오류:', error);
          }
          
          try {
            generateTips();
          } catch (error) {
            console.error('generateTips 오류:', error);
          }
          
          console.log('✅ trip-summary 초기화 완료');
        } catch (error) {
          console.error('❌ trip-summary 초기화 실패:', error);
          alert('오류가 발생했습니다. 콘솔을 확인해주세요.');
        }
      });

       // 일정 데이터 로드
       function loadScheduleData() {
         console.log('🚀 trip-summary.html 초기화 시작');
         
         // sessionStorage에서 최종 일정 데이터 가져오기
         const finalTripPlanStr = sessionStorage.getItem('finalTripPlan');
         console.log('📦 sessionStorage에서 finalTripPlan 가져옴:', finalTripPlanStr ? '있음' : '없음');
         
         if (finalTripPlanStr) {
           try {
             const finalTripPlan = JSON.parse(finalTripPlanStr);
             const plannerResult = finalTripPlan.plannerResult;
             console.log('📋 plannerResult:', plannerResult);
             console.log('📦 finalTripPlan 전체:', finalTripPlan);
             
            if (plannerResult) {
              // airport-external 타입인 경우 공항 내부 POI 데이터를 sessionStorage에서 가져옴
              const airportPOIDataStr = sessionStorage.getItem('airportPOIData');
              let airportPOIs = [];
              let cityPOIs = [];
              
              if (airportPOIDataStr) {
                try {
                  const airportPOIData = JSON.parse(airportPOIDataStr);
                  
                  // 선택된 POI ID 목록과 전체 POI 목록을 매칭하여 airportPOIs 생성
                  airportPOIs = airportPOIData.selectedPOIs
                    .map(poiId => airportPOIData.allPOIs.find(p => p.id === poiId))
                    .filter(poi => poi != null)
                    .map(poi => ({
                      id: poi.id,
                      name: poi.name,
                      address: poi.location || '',
                      description: poi.description || '',
                      rating: poi.rating || 4.0,
                      userRatingsTotal: poi.userRatingsTotal || 0,
                      categoryIcon: poi.categoryIcon || '📍',
                      imageUrl: poi.imageUrl || '',
                      estimatedTime: poi.estimatedTime || 10,
                      category: poi.category || '기타'
                    }));
                  
                } catch (error) {
                  console.error('❌ airportPOIData 파싱 실패:', error);
                }
              }
              
              // waypoints는 city POI로 간주
              const allWaypoints = plannerResult.waypoints || [];
              cityPOIs = allWaypoints.map((wp, index) => ({
                id: `city_${index}`,
                name: wp.label || 'Unknown',
                address: wp.address || '',
                description: wp.description || '',
                rating: wp.rating || 0,
                userRatingsTotal: wp.userRatingsTotal || 0,
                categoryIcon: wp.categoryIcon || '📍',
                imageUrl: wp.photos?.[0] || '',
                estimatedTime: wp.stayMinutes || 10,
                category: wp.categoryKey || '기타'
              }));
              
              scheduleData = {
                transferInfo: {
                  city: plannerResult.meta?.cityText || '싱가포르',
                  arrival: plannerResult.meta?.arrival,
                  departure: plannerResult.meta?.departure,
                  duration: plannerResult.meta?.exploreWindow?.availableMinutes * 60000
                },
                type: 'airport-external',
                waypoints: allWaypoints,
                airportPOIs: airportPOIs,
                cityPOIs: cityPOIs,
                actualTimeline: finalTripPlan.actualTimeline, // 실제 계산된 시간표 추가
                completedAt: finalTripPlan.completedAt
              };
              
              if (finalTripPlan.actualTimeline) {
                console.log('✅ 실제 계산된 타임라인 로드 완료:', finalTripPlan.actualTimeline.length, '개 세그먼트');
                console.log('📋 actualTimeline 내용:', finalTripPlan.actualTimeline);
              } else {
                console.log('⚠️ actualTimeline 데이터 없음');
              }
              transferInfo = scheduleData.transferInfo;
            } else {
              setDefaultData();
            }
           } catch (error) {
             console.error('❌ 최종 일정 데이터 로드 실패:', error);
             setDefaultData();
           }
         } else {
           setDefaultData();
         }
       }

      function setDefaultData() {
        // 기본값 설정 (테스트용)
        scheduleData = {
          transferInfo: {
            city: '싱가포르',
            arrival: new Date(),
            departure: new Date(Date.now() + 4 * 60 * 60 * 1000),
            duration: 4 * 60 * 60 * 1000
          },
          type: 'airport-external',
          waypoints: [],
          completedAt: new Date().toISOString()
        };
        transferInfo = scheduleData.transferInfo;
      }

      // 요약 정보 업데이트
      function updateSummary() {
        if (!transferInfo) {
          // 데이터가 없으면 기본 메시지 표시
          document.getElementById('summary-city').textContent = '데이터 없음';
          document.getElementById('summary-duration').textContent = '-';
          document.getElementById('summary-arrival').textContent = '-';
          document.getElementById('summary-departure').textContent = '-';
          document.getElementById('summary-style').textContent = '-';
          return;
        }

        document.getElementById('summary-city').textContent = transferInfo.city || '싱가포르';
        document.getElementById('summary-duration').textContent = formatDuration(transferInfo.duration || 0);
        document.getElementById('summary-arrival').textContent = formatDateTime(transferInfo.arrival);
        document.getElementById('summary-departure').textContent = formatDateTime(transferInfo.departure);
        
        const styleText = scheduleData.type === 'airport-only' ? '공항 내부만' : '공항 + 도시';
        document.getElementById('summary-style').textContent = styleText;
      }

      // 시간 포맷팅
      function formatDuration(durationMs) {
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let result = '';
        if (hours > 0) result += `${hours}시간`;
        if (minutes > 0) result += ` ${minutes}분`;
        
        return result || '0분';
      }

      // 날짜 시간 포맷팅
      function formatDateTime(date) {
        if (!date) return '-';
        
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        
        return `${year}.${month}.${day} ${hours}:${minutes}`;
      }

      // 일정 개요 생성
      function generateScheduleOverview() {
        if (!scheduleData) {
          console.warn('generateScheduleOverview: scheduleData가 없습니다');
          const container = document.getElementById('schedule-sections');
          if (container) {
            container.innerHTML = '<p class="empty-message">일정 데이터가 없습니다.</p>';
          }
          return;
        }
        
        const container = document.getElementById('schedule-sections');
        if (!container) {
          console.error('schedule-sections 컨테이너를 찾을 수 없습니다');
          return;
        }
        
        container.innerHTML = '';

        if (scheduleData.type === 'airport-only') {
          generateAirportOnlySchedule(container);
        } else if (scheduleData.type === 'airport-external') {
          generateAirportExternalSchedule(container);
        }
      }

      // 공항 내부만 일정 생성
      function generateAirportOnlySchedule(container) {
        const section = document.createElement('div');
        section.className = 'schedule-section airport-section';
        
        section.innerHTML = `
          <h3>🏢 공항 내부 일정</h3>
          <div class="timeline" id="airport-timeline">
            ${generateTimelineItems(scheduleData.airportPOIs || [], 'airport')}
          </div>
        `;
        
        container.appendChild(section);
      }

      // 공항 + 도시 일정 생성
      function generateAirportExternalSchedule(container) {
        // 공항 내부 섹션
        const airportSection = document.createElement('div');
        airportSection.className = 'schedule-section airport-section';
        
        airportSection.innerHTML = `
          <h3>🏢 공항 내부 일정</h3>
          <div class="timeline" id="airport-timeline">
            ${generateTimelineItems(scheduleData.airportPOIs || [], 'airport')}
          </div>
        `;
        
        container.appendChild(airportSection);

        // 도시 섹션
        const citySection = document.createElement('div');
        citySection.className = 'schedule-section city-section';
        
        citySection.innerHTML = `
          <h3>🏙️ 도시 탐방 일정</h3>
          <div class="timeline" id="city-timeline">
            ${generateTimelineItems(scheduleData.cityPOIs || [], 'city')}
          </div>
        `;
        
        container.appendChild(citySection);
      }

      // 실제 계산된 타임라인 생성 (navigation.html에서 계산된 실제 시간표 사용)
      function generateActualTimeline(pois, actualTimeline) {
        if (!actualTimeline || actualTimeline.length === 0) {
          return '<p class="empty-timeline">실제 계산된 일정 정보가 없습니다.</p>';
        }

        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        // 공항 내부 일정 후 도시 일정 시작
        currentTime.setHours(currentTime.getHours() + 2);

        return actualTimeline.map((segment, index) => {
          const poi = pois[index];
          const poiName = poi?.name || segment.toLabel || 'Unknown';
          const poiCategory = poi?.category || '기타';
          
          // 이동 시간 계산 (세그먼트의 duration을 분으로 변환)
          const travelTime = Math.round(segment.duration / 60); // 초 -> 분
          
          // 이동 중 아이템
          const travelStartTime = new Date(currentTime);
          const travelEndTime = new Date(currentTime.getTime() + travelTime * 60000);
          const travelTimeItem = `
            <div class="timeline-item timeline-item--travel">
              <div class="timeline-time">
                <span class="start-time">${formatTime(travelStartTime)}</span>
                <span class="end-time">${formatTime(travelEndTime)}</span>
              </div>
              <div class="timeline-content">
                <h4>🚶 이동 중</h4>
                <p>${travelTime}분 이동 (${segment.distanceText || ''})</p>
                <p class="details">${segment.fromLabel} → ${segment.toLabel}</p>
              </div>
            </div>
          `;
          
          currentTime = travelEndTime;
          
          // 체류 시간 계산 (POI의 estimatedTime 또는 기본값 사용)
          const stayTime = poi?.estimatedTime || poi?.stayMinutes || 60;
          const stayStartTime = new Date(currentTime);
          const stayEndTime = new Date(currentTime.getTime() + stayTime * 60000);
          
          const timelineItem = `
            <div class="timeline-item">
              <div class="timeline-time">
                <span class="start-time">${formatTime(stayStartTime)}</span>
                <span class="end-time">${formatTime(stayEndTime)}</span>
              </div>
              <div class="timeline-content">
                <h4>${poiName}</h4>
                <span class="timeline-category">${poiCategory}</span>
                <p>${stayTime}분 체류</p>
                ${poi?.address ? `<p class="address">${poi.address}</p>` : ''}
              </div>
            </div>
          `;
          
          currentTime = stayEndTime;
          return travelTimeItem + timelineItem;
        }).join('');
      }

      // 타임라인 아이템 생성
      function generateTimelineItems(pois, type) {
        if (!pois || pois.length === 0) {
          return '<p class="empty-timeline">선택된 장소가 없습니다.</p>';
        }

        // 실제 계산된 타임라인이 있으면 사용
        if (scheduleData.actualTimeline && type === 'city') {
          console.log('📅 실제 계산된 타임라인으로 생성 시작');
          return generateActualTimeline(pois, scheduleData.actualTimeline);
        } else {
          console.log('⚠️ 실제 타임라인 없음, 추정값 사용');
        }

        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        // 도시 일정의 경우 공항 내부 일정 후 시작
        if (type === 'city') {
          currentTime.setHours(currentTime.getHours() + 2);
        }

        return pois.map((poi, index) => {
          // POI가 ID인지 객체인지 확인
          const poiData = typeof poi === 'object' ? poi : { id: poi, name: 'Unknown', estimatedTime: 10 };
          
          const poiName = poiData.name || 'Unknown';
          const poiCategory = poiData.category || '기타';
          const estimatedTime = poiData.estimatedTime || poiData.stayMinutes || 10;
          const travelTime = poiData.travelTime || 0; // 이전 경유지에서 이동 시간

          // 첫 번째 경유지가 아니고 이동 시간이 있는 경우 이동 시간 표시
          let travelTimeItem = '';
          if (index > 0 && travelTime > 0) {
            const travelStartTime = new Date(currentTime);
            const travelEndTime = new Date(currentTime.getTime() + travelTime * 60000);
            travelTimeItem = `
              <div class="timeline-item timeline-item--travel">
                <div class="timeline-time">
                  <span class="start-time">${formatTime(travelStartTime)}</span>
                  <span class="end-time">${formatTime(travelEndTime)}</span>
                </div>
                <div class="timeline-content">
                  <h4>🚶 이동 중</h4>
                  <p>${travelTime}분 이동</p>
                </div>
              </div>
            `;
            currentTime = travelEndTime;
          }

          const startTime = new Date(currentTime);
          const endTime = new Date(currentTime.getTime() + estimatedTime * 60000);
          
          const timelineItem = `
            ${travelTimeItem}
            <div class="timeline-item">
              <div class="timeline-time">
                <span class="start-time">${formatTime(startTime)}</span>
                <span class="end-time">${formatTime(endTime)}</span>
              </div>
              <div class="timeline-content">
                <h4>${poiName}</h4>
                <span class="timeline-category">${poiCategory}</span>
                <p>${estimatedTime}분 체류</p>
                ${poiData.address ? `<p class="address">${poiData.address}</p>` : ''}
              </div>
            </div>
          `;
          
          currentTime = endTime;
          return timelineItem;
        }).join('');
      }

      // 시간 포맷팅 (HH:MM)
      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // 통계 업데이트
      function updateStats() {
        if (!scheduleData) {
          console.warn('updateStats: scheduleData가 없습니다');
          return;
        }
        
        const airportCount = scheduleData.airportPOIs ? scheduleData.airportPOIs.length : 0;
        const cityCount = scheduleData.cityPOIs ? scheduleData.cityPOIs.length : 0;
        const totalLocations = airportCount + cityCount;
        
        const totalLocationsEl = document.getElementById('total-locations');
        if (totalLocationsEl) {
          totalLocationsEl.textContent = totalLocations;
        }

        // 총 소요시간 계산 (임시)
        const totalTime = totalLocations * 60; // 평균 60분씩
        const totalTimeEl = document.getElementById('total-time');
        if (totalTimeEl) {
          totalTimeEl.textContent = `${totalTime}분`;
        }

        // 이동시간 계산 (임시)
        const walkingTime = Math.max(0, totalLocations - 1) * 15; // 장소 간 이동 15분씩
        const walkingTimeEl = document.getElementById('walking-time');
        if (walkingTimeEl) {
          walkingTimeEl.textContent = `${walkingTime}분`;
        }
      }

      // 팁 생성
      function generateTips() {
        const container = document.getElementById('tips-grid');
        if (!container) {
          console.error('tips-grid 컨테이너를 찾을 수 없습니다');
          return;
        }
        
        if (!scheduleData) {
          console.warn('generateTips: scheduleData가 없습니다');
          container.innerHTML = '';
          return;
        }
        
        const tips = getTipsForSchedule(scheduleData);
        
        container.innerHTML = tips.map(tip => `
          <div class="tip-card">
            <div class="tip-icon">${tip.icon}</div>
            <h4>${tip.title}</h4>
            <p>${tip.description}</p>
          </div>
        `).join('');
      }

      // 일정에 따른 팁 가져오기
      function getTipsForSchedule(schedule) {
        if (!schedule) {
          console.warn('getTipsForSchedule: schedule이 null입니다');
          return [];
        }
        
        const baseTips = [
          {
            icon: '🎒',
            title: '짐 보관소',
            description: '공항 내 짐 보관소를 이용하면 가벼운 쇼핑과 관광이 가능합니다.'
          },
          {
            icon: '📶',
            title: '무료 와이파이',
            description: '공항 내 무료 와이파이를 연결하여 실시간 정보를 확인하세요.'
          },
          {
            icon: '⏰',
            title: '시간 관리',
            description: '출발 시간을 고려하여 충분한 여유 시간을 확보하세요.'
          }
        ];

        if (schedule.type === 'airport-external') {
          baseTips.push(
            {
              icon: '🚇',
              title: '교통편',
              description: '공항에서 도시까지의 교통편을 미리 확인하고 시간을 고려하세요.'
            },
            {
              icon: '🗺️',
              title: '지도 앱',
              description: '오프라인 지도를 다운로드하여 인터넷 없이도 길을 찾을 수 있습니다.'
            }
          );
        }

        return baseTips;
      }

      // 일정 수정하기
      // 홈으로 돌아가기
      function goToHome() {
        window.location.href = 'landing.html';
      }

      // 일정 공유하기
      function shareSchedule(type) {
        if (type === 'link') {
          // 링크 공유 로직
          const shareUrl = window.location.origin + window.location.pathname;
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert('링크가 클립보드에 복사되었습니다!');
          });
        } else if (type === 'image') {
          // 이미지 저장 로직
          alert('이미지 저장 기능은 준비 중입니다.');
        }
      }
    </script>
  </body>
</html>
