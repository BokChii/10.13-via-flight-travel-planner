<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <meta name="openai-api-key" content="YOUR_OPENAI_API_KEY" />
    <title>í™˜ìŠ¹ ì •ë³´ ì…ë ¥ - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/transfer-info.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/forms.css" />
    <link rel="stylesheet" href="styles/components/steps.css" />
  </head>
  <body class="app transfer-info-page">
    <header class="app-header">
      <h1>Via Flight</h1>
      <p class="tagline">í™˜ìŠ¹ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
      <nav class="breadcrumb">
        <a href="landing.html" class="breadcrumb__link">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </nav>
    </header>

    <main class="transfer-info-main">
      <!-- Progress Indicator -->
      <div class="progress-container">
        <div class="progress-steps">
          <div class="step active">
            <div class="step-number">1</div>
            <div class="step-label">í™˜ìŠ¹ ì •ë³´</div>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <div class="step-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">ì¼ì • ìƒì„±</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 33%"></div>
        </div>
      </div>

      <!-- Transfer Info Form -->
      <section class="transfer-form-section">
        <!-- Quick Tips -->
        <div class="tips-section">
          <h3 class="tips-title">ğŸ’¡ í™˜ìŠ¹ ì‹œê°„ íŒ</h3>
          <div class="tips-grid">
            <div class="tip-card">
              <div class="tip-icon">â°</div>
              <h4>ìµœì†Œ í™˜ìŠ¹ ì‹œê°„</h4>
              <p>êµ­ì œì„  í™˜ìŠ¹ì€ ìµœì†Œ 2ì‹œê°„, êµ­ë‚´ì„ ì€ 1ì‹œê°„ì„ ê¶Œì¥í•©ë‹ˆë‹¤</p>
            </div>
            <div class="tip-card">
              <div class="tip-icon">ğŸ›‚</div>
              <h4>ì…êµ­ ì‹¬ì‚¬</h4>
              <p>ë„ì‹œ ê´€ê´‘ì„ ì›í•œë‹¤ë©´ ì…êµ­ ì‹¬ì‚¬ ì‹œê°„ì„ ê³ ë ¤í•˜ì„¸ìš”</p>
            </div>
            <div class="tip-card">
              <div class="tip-icon">ğŸ’</div>
              <h4>ì§ ë³´ê´€</h4>
              <p>ê³µí•­ ì§ ë³´ê´€ì†Œë¥¼ ì´ìš©í•˜ë©´ ê°€ë²¼ìš´ ë„ì‹œ ê´€ê´‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
            </div>
          </div>
        </div>

        <!-- AI ë§ì¶¤ ê°€ì´ë“œ -->
        <div class="ai-guide-section" id="ai-guide-section" style="display: none;">
          <div class="ai-guide-card">
            <div class="ai-guide-header">
              <h3 class="ai-guide-title" id="ai-guide-title">ğŸ¤– AI ë§ì¶¤ ê°€ì´ë“œ</h3>
              <span class="ai-badge">AI ìƒì„±</span>
            </div>
            <div class="ai-guide-content" id="ai-guide-content">
              <div class="ai-guide-loading">
                <p>ë§ì¶¤í˜• ê°€ì´ë“œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...</p>
              </div>
            </div>
          </div>
        </div>

        <div class="form-container">
          <h2 class="form-title">í™˜ìŠ¹ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</h2>
          <p class="form-description">
            ë„ì°© ì‹œê°„, ì¶œë°œ ì‹œê°„, ê²½ìœ  ë„ì‹œë¥¼ ì…ë ¥í•˜ë©´<br>
            ìµœì ì˜ í™˜ìŠ¹ ì—¬í–‰ ì¼ì •ì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.
          </p>

          <form id="transfer-form" class="transfer-form">
            <div class="form-group">
              <label class="form-label">
                <span class="label-text">ê²½ìœ  ë„ì‹œ</span>
                <div class="city-selection">
                  <button type="button" class="city-button" data-city="ë‘ë°”ì´" disabled>
                    <span class="city-name">ë‘ë°”ì´</span>
                    <span class="city-status">ì¤€ë¹„ì¤‘</span>
                  </button>
                  <button type="button" class="city-button active" data-city="ì‹±ê°€í¬ë¥´">
                    <span class="city-name">ì‹±ê°€í¬ë¥´</span>
                    <span class="city-status">í™œì„±í™”</span>
                  </button>
                  <button type="button" class="city-button" data-city="í™ì½©" disabled>
                    <span class="city-name">í™ì½©</span>
                    <span class="city-status">ì¤€ë¹„ì¤‘</span>
                  </button>
                </div>
                <div class="input-hint">í˜„ì¬ ì‹±ê°€í¬ë¥´ë§Œ ì„œë¹„ìŠ¤ ì¤‘ì…ë‹ˆë‹¤</div>
              </label>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">ë„ì°© ì‹œê°„</span>
                  <input 
                    type="datetime-local" 
                    id="arrival-input" 
                    class="form-input" 
                    required
                  />
                  <div class="input-hint">ì²« ë²ˆì§¸ í•­ê³µí¸ ë„ì°© ì‹œê°„</div>
                </label>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">ì¶œë°œ ì‹œê°„</span>
                  <input 
                    type="datetime-local" 
                    id="departure-input" 
                    class="form-input" 
                    required
                  />
                  <div class="input-hint">ë‘ ë²ˆì§¸ í•­ê³µí¸ ì¶œë°œ ì‹œê°„</div>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                <span class="label-text">í™˜ìŠ¹ ì‹œê°„</span>
                <div class="duration-display" id="duration-display">
                  <div class="duration-content">
                    <span class="duration-text">ì‹œê°„ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤</span>
                  </div>
                </div>
                <div class="input-hint">ë„ì°© ì‹œê°„ê³¼ ì¶œë°œ ì‹œê°„ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤</div>
              </label>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn--ghost" onclick="goBack()">
                ì´ì „
              </button>
              <button type="submit" class="btn btn--primary" id="next-button">
                ë‹¤ìŒ ë‹¨ê³„ë¡œ
              </button>
            </div>
          </form>
        </div>
      </section>
    </main>

    <script type="module" src="scripts/router.js"></script>
    <script type="module" src="scripts/toast.js"></script>
    <script src="scripts/aiTipsService.js"></script>
    <script type="module">
      import { getOpenAIApiKey } from './scripts/config.js';
      
      // OpenAI API í‚¤ ì„¤ì •
      const apiKey = getOpenAIApiKey();
      if (apiKey && apiKey !== 'YOUR_OPENAI_API_KEY') {
        if (window.aiTipsService) {
          window.aiTipsService.setApiKey(apiKey);
        }
      }
    </script>
    <script>
      // ì „ì—­ ìƒíƒœ ê´€ë¦¬
      const transferState = {
        city: '',
        arrival: null,
        departure: null,
        duration: 0
      };

      // DOM ìš”ì†Œë“¤
      const form = document.getElementById('transfer-form');
      const cityButtons = document.querySelectorAll('.city-button');
      const arrivalInput = document.getElementById('arrival-input');
      const departureInput = document.getElementById('departure-input');
      const durationDisplay = document.getElementById('duration-display');
      const nextButton = document.getElementById('next-button');

      // í˜„ì¬ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
      function setDefaultDateTime() {
        const now = new Date();
        const arrivalTime = new Date(now.getTime() + 2 * 60 * 60 * 1000); // 2ì‹œê°„ í›„
        const departureTime = new Date(now.getTime() + 6 * 60 * 60 * 1000); // 6ì‹œê°„ í›„

        arrivalInput.value = formatDateTimeLocal(arrivalTime);
        departureInput.value = formatDateTimeLocal(departureTime);
        
        updateDuration();
      }

      // DateTime-local í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      // í™˜ìŠ¹ ì‹œê°„ ê³„ì‚°
      function updateDuration() {
        const arrival = new Date(arrivalInput.value);
        const departure = new Date(departureInput.value);
        
        if (arrival && departure) {
          if (departure <= arrival) {
            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            durationDisplay.innerHTML = `
              <div class="duration-content">
                <span class="duration-text" style="color: #e74c3c; font-weight: 600;">âš ï¸ ì¶œë°œ ì‹œê°„ì€ ë„ì°© ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤</span>
              </div>
            `;
            nextButton.style.opacity = '0.5';
            nextButton.style.cursor = 'not-allowed';
            return;
          }
          
          const durationMs = departure.getTime() - arrival.getTime();
          const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
          const durationMinutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
          
          transferState.duration = durationMs;
          transferState.arrival = arrival;
          transferState.departure = departure;
          
          let durationText = '';
          if (durationHours > 0) {
            durationText += `${durationHours}ì‹œê°„`;
          }
          if (durationMinutes > 0) {
            durationText += ` ${durationMinutes}ë¶„`;
          }
          
          durationDisplay.innerHTML = `
            <div class="duration-content">
              <span class="duration-value">${durationText}</span>
              <span class="duration-label">í™˜ìŠ¹ ì‹œê°„</span>
            </div>
          `;
          
          validateForm();
          
          // AI ê°€ì´ë“œ ìƒì„± (ë„ì‹œê°€ ì„ íƒë˜ì–´ ìˆìœ¼ë©´)
          if (transferState.city) {
            generateAIGuide();
          }
        } else {
          durationDisplay.innerHTML = `
            <div class="duration-content">
              <span class="duration-text">ì‹œê°„ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤</span>
            </div>
          `;
          nextButton.style.opacity = '0.5';
          nextButton.style.cursor = 'not-allowed';
        }
      }

      // ë„ì‹œ ì„ íƒ ì²˜ë¦¬
      function handleCitySelection(selectedButton) {
        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        cityButtons.forEach(button => {
          button.classList.remove('active');
        });
        
        // ì„ íƒëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
        selectedButton.classList.add('active');
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        transferState.city = selectedButton.dataset.city;
        
        // í¼ ìœ íš¨ì„± ê²€ì‚¬
        validateForm();
        
        // AI ê°€ì´ë“œ ìƒì„± (ì‹œê°„ì´ ì…ë ¥ë˜ì–´ ìˆìœ¼ë©´)
        if (transferState.arrival && transferState.departure && transferState.duration > 0) {
          generateAIGuide();
        }
      }

      // í¼ ìœ íš¨ì„± ê²€ì‚¬
      function validateForm() {
        const isValid = transferState.city && 
                       arrivalInput.value && 
                       departureInput.value && 
                       transferState.duration > 0;
        
        // disabled ëŒ€ì‹  CSS ìŠ¤íƒ€ì¼ë§Œ ë³€ê²½
        if (isValid) {
          nextButton.style.opacity = '1';
          nextButton.style.cursor = 'pointer';
        } else {
          nextButton.style.opacity = '0.5';
          nextButton.style.cursor = 'not-allowed';
        }
      }

      // í¼ ì œì¶œ ì²˜ë¦¬
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // ì‹œê°„ ê²€ì¦ ì¶”ê°€
        const arrival = new Date(arrivalInput.value);
        const departure = new Date(departureInput.value);
        
        // ì¶œë°œ ì‹œê°„ì´ ë„ì°© ì‹œê°„ë³´ë‹¤ ì•ì„œê±°ë‚˜ ê°™ìœ¼ë©´ ê²½ê³ 
        if (arrival && departure && departure <= arrival) {
          showToast({ message: 'ì¶œë°œ ì‹œê°„ì€ ë„ì°© ì‹œê°„ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.', type: 'warning' });
          return;
        }
        
        // ìœ íš¨ì„± ê²€ì¦ í™•ì¸
        const isValid = transferState.city && 
                       arrivalInput.value && 
                       departureInput.value && 
                       transferState.duration > 0;
        
        if (!isValid) return;
        
        // ë¼ìš°í„°ë¥¼ í†µí•´ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
        window.navigateTo('/airport-main', { transferInfo: transferState });
      });

      // ë„ì‹œ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      cityButtons.forEach(button => {
        button.addEventListener('click', function() {
          if (!button.disabled) {
            handleCitySelection(button);
          }
        });
      });

      // ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      arrivalInput.addEventListener('change', updateDuration);
      departureInput.addEventListener('change', updateDuration);

      // AI ê°€ì´ë“œ ìƒì„±
      async function generateAIGuide() {
        // í•„ìˆ˜ ì •ë³´ í™•ì¸
        if (!transferState.city || !transferState.arrival || !transferState.departure || transferState.duration <= 0) {
          return;
        }

        const guideSection = document.getElementById('ai-guide-section');
        const guideContent = document.getElementById('ai-guide-content');
        const guideTitle = document.getElementById('ai-guide-title');

        // ì„¹ì…˜ í‘œì‹œ
        guideSection.style.display = 'block';
        guideContent.innerHTML = `
          <div class="ai-guide-loading">
            <p>ğŸ¤– ë§ì¶¤í˜• ê°€ì´ë“œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...</p>
          </div>
        `;

        try {
          const guide = await window.aiTipsService.generateTransferInfoTips(
            transferState.city,
            transferState.duration,
            transferState.arrival,
            transferState.departure
          );

          // ê°€ì´ë“œ ë Œë”ë§
          let html = `
            <div class="ai-guide-summary">
              <p>${guide.summary}</p>
            </div>
          `;

          if (guide.recommendations && guide.recommendations.length > 0) {
            html += `
              <div class="ai-guide-recommendations">
                <h4>âœ¨ ì¶”ì²œ í™œë™</h4>
                <ul>
                  ${guide.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          if (guide.tips && guide.tips.length > 0) {
            html += `
              <div class="ai-guide-tips">
                <h4>ğŸ’¡ ì‹¤ìš© íŒ</h4>
                <ul>
                  ${guide.tips.map(tip => `<li>${tip}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          if (guide.warning) {
            html += `
              <div class="ai-guide-warning">
                <h4>âš ï¸ ì£¼ì˜ì‚¬í•­</h4>
                <p>${guide.warning}</p>
              </div>
            `;
          }

          guideTitle.textContent = `ğŸ¤– ${guide.title}`;
          guideContent.innerHTML = html;

        } catch (error) {
          console.error('AI ê°€ì´ë“œ ìƒì„± ì‹¤íŒ¨:', error);
          
          let errorMessage = 'ë§ì¶¤í˜• ê°€ì´ë“œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          if (error.message.includes('401')) {
            errorMessage = 'OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
          } else if (error.message.includes('429')) {
            errorMessage = 'API ì‚¬ìš©ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          }

          guideContent.innerHTML = `
            <div class="ai-guide-error">
              <p>${errorMessage}</p>
            </div>
          `;
        }
      }

      // ë’¤ë¡œê°€ê¸° í•¨ìˆ˜
      function goBack() {
        window.goBack();
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        setDefaultDateTime();
        
        // ê¸°ë³¸ ë„ì‹œ ì„ íƒ (ì‹±ê°€í¬ë¥´)
        const singaporeButton = document.querySelector('.city-button[data-city="ì‹±ê°€í¬ë¥´"]');
        if (singaporeButton) {
          handleCitySelection(singaporeButton);
        }
        
        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        const formContainer = document.querySelector('.form-container');
        const tipsSection = document.querySelector('.tips-section');
        
        setTimeout(() => {
          formContainer.style.opacity = '1';
          formContainer.style.transform = 'translateY(0)';
        }, 300);
        
        setTimeout(() => {
          tipsSection.style.opacity = '1';
          tipsSection.style.transform = 'translateY(0)';
        }, 600);
      });
    </script>
  </body>
</html>
