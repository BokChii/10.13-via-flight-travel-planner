<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <title>공항 밖 여행 일정 - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/airport-external.css" />
    <link rel="stylesheet" href="styles/pages/airport-only.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
    <link rel="stylesheet" href="styles/components/forms.css" />
    <link rel="stylesheet" href="styles/components/steps.css" />
  </head>
  <body class="app airport-external-page">
    <header class="app-header">
      <h1>Via Flight</h1>
      <p class="tagline">공항 밖 여행 일정 만들기</p>
      <nav class="breadcrumb">
        <a href="airport-main.html" class="breadcrumb__link">← 여행 스타일 다시 선택</a>
      </nav>
    </header>

    <main class="airport-external-main">
      <!-- Progress Indicator -->
      <div class="progress-container">
        <div class="progress-steps">
          <div class="step completed">
            <div class="step-number">✓</div>
            <div class="step-label">환승 정보</div>
          </div>
          <div class="step completed">
            <div class="step-number">✓</div>
            <div class="step-label">여행 스타일</div>
          </div>
          <div class="step active">
            <div class="step-number">3</div>
            <div class="step-label">공항 내부</div>
          </div>
          <div class="step">
            <div class="step-number">4</div>
            <div class="step-label">도시 탐방</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 75%"></div>
        </div>
      </div>

      <!-- Transfer Summary -->
      <section class="transfer-summary">
        <div class="summary-card">
          <h2 class="summary-title">공항 밖 여행 일정</h2>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">경유 도시</span>
              <span class="summary-value" id="summary-city">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">환승 시간</span>
              <span class="summary-value" id="summary-duration">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">여행 스타일</span>
              <span class="summary-value">공항 + 도시</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Step 3: Airport Preferences + POI Selection (통합) -->
      <section class="preferences-poi-step" id="preferences-poi-step">
        <div class="step-container">
          <h2 class="step-title">공항 내부에서 어떤 것을 좋아하시나요?</h2>
          <p class="step-description">
            관심 있는 카테고리를 선택하고<br>
            방문하고 싶은 장소를 선택해주세요.
          </p>

          <!-- 카테고리 선택 섹션 -->
          <div class="preferences-section">
            <h3 class="section-title">카테고리 선택</h3>
            <div class="preference-cards">
              <button class="preference-card" data-table="rests_db_frame">
                <div class="preference-icon">💆</div>
                <h3>휴식 & 라운지</h3>
                <p>라운지, 휴식공간, 호텔</p>
              </button>
              <button class="preference-card" data-table="meal_options_db_frame">
                <div class="preference-icon">🍽️</div>
                <h3>식사 & 음료</h3>
                <p>식당, 카페, 디저트</p>
              </button>
              <button class="preference-card" data-table="shopping_options_db_frame">
                <div class="preference-icon">🛍️</div>
                <h3>쇼핑 & 면세</h3>
                <p>면세점, 브랜드샵, 기념품</p>
              </button>
              <button class="preference-card" data-table="airport_events_db_frame">
                <div class="preference-icon">🎮</div>
                <h3>체험 & 이벤트</h3>
                <p>문화체험, 엔터테인먼트</p>
              </button>
            </div>
          </div>

          <!-- POI 선택 섹션 -->
          <div class="poi-selection-section" id="poi-selection-section" style="display: none;">
            <h3 class="section-title">방문할 장소 선택</h3>
            
            <!-- 카테고리 필터 -->
            <div class="filters-section">
              <h4>카테고리 필터</h4>
              <div class="filter-buttons" id="filter-buttons">
                <!-- 동적으로 생성됨 -->
              </div>
            </div>

            <!-- 좌우 분할 레이아웃 -->
            <div class="poi-selection-layout">
              <!-- 좌측: POI 리스트 -->
              <div class="poi-list-container">
                <div class="poi-list-header">
                  <h4>장소 목록</h4>
                </div>
                <div class="poi-list" id="poi-list">
                  <!-- POI 리스트 항목들이 동적으로 생성됨 -->
                </div>
              </div>

              <!-- 우측: 상세 정보 패널 -->
              <div class="poi-detail-container">
                <!-- POI 상세 정보 -->
                <div class="poi-detail-panel" id="poi-detail-panel">
                  <div class="poi-detail-placeholder">
                    <p>좌측에서 장소를 선택하면 상세 정보가 표시됩니다.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- 선택된 POI 목록 (화면 하단) -->
            <div class="selected-pois-summary-bottom">
              <h4>선택한 장소</h4>
              <div class="selected-list" id="selected-list">
                <p class="empty-message">아직 선택한 장소가 없습니다.</p>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--primary" onclick="nextToCityPreferences()" id="preferences-poi-next">
              도시 탐방으로
            </button>
          </div>
        </div>
      </section>

      <!-- Step 3.3: City Preferences -->
      <section class="city-preferences-step" id="city-preferences-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">도시에서 어떤 것을 좋아하시나요?</h2>
          <p class="step-description">
            도시 탐방에서 관심 있는 카테고리를 선택해주세요.<br>
            선택한 카테고리에 맞는 도시 내 장소들을 추천해드립니다. (최대 3개)
          </p>

          <div class="preference-cards">
            <button class="preference-card" data-category="food">
              <div class="preference-icon">🍽️</div>
              <h3>미식 & 로컬 맛집</h3>
              <p>현지 맛집과 특색 있는 음식</p>
            </button>
            <button class="preference-card" data-category="shopping">
              <div class="preference-icon">🛍️</div>
              <h3>쇼핑 & 기념품</h3>
              <p>현지 상품과 기념품 쇼핑</p>
            </button>
            <button class="preference-card" data-category="culture">
              <div class="preference-icon">🏛️</div>
              <h3>문화 & 역사</h3>
              <p>박물관, 역사적 장소</p>
            </button>
            <button class="preference-card" data-category="nature">
              <div class="preference-icon">🌿</div>
              <h3>자연 & 정원</h3>
              <p>공원, 정원, 자연 경관</p>
            </button>
            <button class="preference-card" data-category="view">
              <div class="preference-icon">🌆</div>
              <h3>전망 & 야경</h3>
              <p>전망대, 야경 명소</p>
            </button>
          </div>

          <!-- 기본 체류 시간 설정 -->
          <div class="stay-time-section" style="margin-top: 2rem;">
            <h4 style="margin-bottom: 1rem; color: var(--color-text);">장소별 기본 체류 시간</h4>
            <div class="stay-time-input" style="display: flex; align-items: center; gap: 1rem;">
              <div class="stay-time-slider" style="flex: 1;">
                <input id="city-default-stay" type="range" min="20" max="240" step="5" value="60" class="stay-slider" style="width: 100%;" />
                <div class="stay-time-labels" style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                  <span style="font-size: 0.875rem; color: var(--color-text-secondary);">20분</span>
                  <span style="font-size: 0.875rem; color: var(--color-text-secondary);">240분</span>
                </div>
              </div>
              <div class="stay-time-display" style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="number" id="city-stay-number" min="20" max="240" step="5" value="60" style="width: 80px; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 4px;" />
                <span style="color: var(--color-text-secondary);">분</span>
              </div>
            </div>
            <small style="display: block; margin-top: 0.5rem; color: var(--color-text-muted); font-size: 0.875rem;">각 장소에서 보낼 예상 시간입니다</small>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToAirportPOISelection()">
              이전
            </button>
            <button class="btn btn--primary" onclick="nextToCityPOISelection()" id="city-preferences-next">
              다음 단계로
            </button>
          </div>
        </div>
      </section>

      <!-- Step 3.4: City POI Selection -->
      <section class="city-poi-selection-step" id="city-poi-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">도시에서 방문할 장소를 선택해주세요</h2>
          <p class="step-description">
            선택한 카테고리의 추천 장소들을 확인하고<br>
            도시에서 방문하고 싶은 장소를 선택해주세요.
          </p>

          <div class="poi-selection-content">
            <div class="filters-section">
              <h3>카테고리 필터</h3>
              <div class="filter-buttons" id="city-filter-buttons">
                <!-- 동적으로 생성됨 -->
              </div>
            </div>

            <div class="poi-grid" id="city-poi-grid">
              <!-- POI 카드들이 동적으로 생성됨 -->
            </div>

            <div class="selected-pois">
              <h3>선택한 도시 장소</h3>
              <div class="selected-list" id="city-selected-list">
                <p class="empty-message">아직 선택한 장소가 없습니다.</p>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToCityPreferences()">
              이전
            </button>
            <button class="btn btn--primary" onclick="nextToSchedule()" id="city-poi-next" disabled>
              일정 만들기
            </button>
          </div>
        </div>
      </section>

      <!-- Step 3.2: Airport Schedule Summary -->
      <section class="schedule-step" id="airport-schedule-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">공항 내부 일정 완성!</h2>
          <p class="step-description">
            선택한 장소들로 최적의 일정을 만들어드렸습니다.<br>
            일정을 확인하고 다음 단계로 진행해주세요.
          </p>

          <!-- 공항 팁 섹션 (상단) -->
          <div class="tips-section">
            <h3>💡 공항 팁</h3>
            <div class="tips-grid">
              <div class="tip-card">
                <div class="tip-icon">🎒</div>
                <h4>짐 보관소</h4>
                <p>공항 내 짐 보관소를 이용하면 가벼운 쇼핑과 관광이 가능합니다.</p>
              </div>
              <div class="tip-card">
                <div class="tip-icon">📶</div>
                <h4>무료 와이파이</h4>
                <p>공항 내 무료 와이파이를 연결하여 실시간 정보를 확인하세요.</p>
              </div>
              <div class="tip-card">
                <div class="tip-icon">🛂</div>
                <h4>보안 검색</h4>
                <p>출발 2시간 전에는 보안 검색대가 혼잡할 수 있으니 미리 준비하세요.</p>
              </div>
            </div>
          </div>

          <!-- 공항 내부 일정 (하단) -->
          <div class="schedule-content">
            <div class="schedule-header">
              <h3>📅 공항 내부 일정</h3>
            </div>
            <div class="timeline" id="timeline">
              <!-- 타임라인이 동적으로 생성됨 -->
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToPOISelection()">
              장소 다시 선택
            </button>
            <button class="btn btn--secondary" onclick="saveSchedule()">
              💾 일정 저장
            </button>
            <button class="btn btn--secondary" onclick="shareSchedule()">
              📤 일정 공유
            </button>
            <button class="btn btn--primary" onclick="goToCityPreferences()">
              공항 외부 일정 구성하기
            </button>
          </div>
        </div>
      </section>

      <!-- Step 4: Full Schedule Summary -->
      <section class="full-schedule-step" id="full-schedule-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">전체 여행 일정 완성!</h2>
          <p class="step-description">
            공항 내부와 도시 탐방을 포함한 최적의 일정을 만들어드렸습니다.<br>
            일정을 확인하고 여행을 시작해보세요.
          </p>

          <div class="schedule-content">
            <div class="schedule-sections">
              <div class="schedule-section">
                <h3>🏢 공항 내부 일정</h3>
                <div class="timeline" id="airport-timeline">
                  <!-- 공항 내부 타임라인이 동적으로 생성됨 -->
                </div>
              </div>
              
              <div class="schedule-section">
                <h3>🏙️ 도시 탐방 일정</h3>
                <p class="schedule-note" style="margin-bottom: 1rem; color: var(--color-text-secondary); font-size: 0.875rem;">
                  ⏰ 구체적인 시간표는 "여행 일정 구성하기"를 눌러 확인할 수 있습니다.
                </p>
                <div class="timeline" id="city-timeline">
                  <!-- 도시 타임라인이 동적으로 생성됨 -->
                </div>
              </div>
            </div>

            <div class="tips-section">
              <h3>💡 여행 팁</h3>
              <div class="tips-grid">
                <div class="tip-card">
                  <div class="tip-icon">🚇</div>
                  <h4>교통편</h4>
                  <p>공항에서 도시까지의 교통편을 미리 확인하고 시간을 고려하세요.</p>
                </div>
                <div class="tip-card">
                  <div class="tip-icon">🎒</div>
                  <h4>짐 보관</h4>
                  <p>공항 내 짐 보관소를 이용하면 가벼운 도시 탐방이 가능합니다.</p>
                </div>
                <div class="tip-card">
                  <div class="tip-icon">⏰</div>
                  <h4>시간 관리</h4>
                  <p>출발 시간을 고려하여 충분한 여유 시간을 확보하세요.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToCityPOISelection()">
              장소 다시 선택
            </button>
            <button class="btn btn--primary" onclick="startNavigation()">
              여행 일정 구성하기
            </button>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module" src="scripts/router.js"></script>
    <script type="module" src="scripts/airportPOIService.js"></script>
    <script type="module" src="scripts/cityPOIService.js"></script>
    <script type="module" src="scripts/poiServiceManager.js"></script>
    <script type="module" src="scripts/toast.js"></script>
    <script src="scripts/sqliteClient.js"></script>
    <script type="module">
      // 필요한 함수들을 import
      import { getPOIInfo } from './scripts/poiManager.js';
      import { getBusinessStatus } from './scripts/businessHours.js';
      
      // 전역에서 사용 가능하도록 window에 노출
      window.getPOIInfo = getPOIInfo;
      window.getBusinessStatus = getBusinessStatus;
    </script>
    <script>
      // 전역 상태
      let transferInfo = null;
      let selectedTable = null;
      let selectedTypes = [];
      let selectedPOIs = [];
      let allPOIs = [];
      let allPOIsMap = new Map(); // 모든 카테고리의 POI를 누적 저장
      let currentStep = 'preferences';
      let expandedGroups = new Set();
      let currentExpandedGroup = null;
      
      // City preferences
      let selectedCityPreferences = [];
      let selectedCityPOIs = [];

      // 페이지 로드 시 초기화
      document.addEventListener('DOMContentLoaded', function() {
        loadTransferInfo();
        updateSummary();
        initializePreferences();
      });

      // 환승 정보 로드
      function loadTransferInfo() {
        const state = window.getAppState();
        if (state.transferInfo) {
          transferInfo = state.transferInfo;
        }
      }

      // 요약 정보 업데이트
      function updateSummary() {
        if (!transferInfo) return;

        document.getElementById('summary-city').textContent = transferInfo.city;
        document.getElementById('summary-duration').textContent = formatDuration(transferInfo.duration);
      }

      // 시간 포맷팅
      function formatDuration(durationMs) {
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let result = '';
        if (hours > 0) result += `${hours}시간`;
        if (minutes > 0) result += ` ${minutes}분`;
        
        return result || '0분';
      }

      // 공항 선호도 초기화
      function initializePreferences() {
        const cards = document.querySelectorAll('#preferences-poi-step .preference-card');
        cards.forEach(card => {
          card.addEventListener('click', function() {
            toggleTableSelection(this.dataset.table);
          });
        });
      }

      // 테이블 선택 토글
      function toggleTableSelection(tableName) {
        const card = document.querySelector(`[data-table="${tableName}"]`);
        
        if (selectedTable === tableName) {
          selectedTable = null;
          selectedTypes = [];
          card.classList.remove('selected');
        } else {
          selectedTable = tableName;
          selectedTypes = [];
          document.querySelectorAll('.preference-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
        }
        
        togglePOISelectionSection();
        updatePreferencesPOINextButton();
      }

      function updatePreferencesPOINextButton() {
        const nextButton = document.getElementById('preferences-poi-next');
        const hasTable = selectedTable !== null;
        const hasSelectedPOIs = selectedPOIs.length > 0;
        
        // disabled 대신 CSS 클래스로만 스타일 변경
        if (!hasTable || !hasSelectedPOIs) {
          nextButton.style.opacity = '0.5';
          nextButton.style.cursor = 'not-allowed';
        } else {
          nextButton.style.opacity = '1';
          nextButton.style.cursor = 'pointer';
        }
      }

      function togglePOISelectionSection() {
        const poiSection = document.getElementById('poi-selection-section');
        if (selectedTable !== null) {
          poiSection.style.display = 'block';
          initializePOISelection();
        } else {
          poiSection.style.display = 'none';
        }
      }

      function initializePOISelection() {
        generateFilterButtons();
        generatePOIList();
        updatePOINextButton();
      }

      function generateFilterButtons() {
        const container = document.getElementById('filter-buttons');
        if (!container) return;
        
        container.innerHTML = '';
        
        const allButton = document.createElement('button');
        allButton.className = 'filter-btn active';
        allButton.textContent = '전체';
        allButton.dataset.type = 'all';
        allButton.onclick = () => filterPOIs('all');
        container.appendChild(allButton);
        
        if (selectedTable) {
          getTableTypes(selectedTable).then(types => {
            types.forEach(type => {
              const existingButton = container.querySelector(`[data-type="${type}"]`);
              if (!existingButton) {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.textContent = getTypeLabel(type);
                button.dataset.type = type;
                button.onclick = () => filterPOIs(type);
                container.appendChild(button);
              }
            });
          });
        }
      }

      async function getTableTypes(tableName) {
        try {
          await window.sqliteClient.initialize();
          const types = await window.sqliteClient.getTableTypes(tableName);
          return types;
        } catch (error) {
          console.error('테이블 타입 조회 실패:', error);
          return [];
        }
      }

      function getTypeLabel(type) {
        const labels = {
          'Lounge': '라운지', 'Rest': '휴식공간', 'Hotel': '호텔',
          'Meal': '식당', 'Cafe': '카페', 'Dessert': '디저트',
          'Fashion': '패션', 'Beauty': '뷰티', 'Beverage': '음료',
          'Snack': '스낵', 'Duty_free': '면세점',
          'Attraction': '관광명소', 'Entertainment': '엔터테인먼트'
        };
        return labels[type] || type;
      }

      async function generatePOIList() {
        selectedTypes = [];
        await loadPOIListWithFilter();
      }

      async function loadPOIListWithFilter(categoryFilter = null) {
        if (!selectedTable) return;
        
        try {
          console.log(`SQLite 데이터베이스에서 ${selectedTable} 테이블 POI 데이터 로드 시작... (필터: ${categoryFilter || '전체'})`);
          
          await window.sqliteClient.initialize();
          const pois = await window.sqliteClient.getTablePOIs(selectedTable, categoryFilter);
          
          // 새로 로드된 POI를 기존 Map에 추가
          pois.forEach(poi => {
            if (!allPOIsMap.has(poi.id)) {
              allPOIsMap.set(poi.id, poi);
            }
          });
          
          // allPOIs 업데이트 (현재 필터에 해당하는 POI만 포함)
          allPOIs = pois;
          const groupedPOIs = groupDuplicatePOIs(pois);
          
          renderPOIList(groupedPOIs);
          console.log(`SQLite 데이터베이스에서 POI 로드 완료: ${pois.length}개 발견 (${groupedPOIs.length}개 그룹)`);
        } catch (error) {
          console.error('SQLite 데이터베이스 로드 실패:', error);
        }
      }

      function groupDuplicatePOIs(pois) {
        const grouped = {};
        pois.forEach(poi => {
          const key = poi.name;
          if (!grouped[key]) {
            grouped[key] = {
              name: poi.name,
              category: poi.category,
              categoryIcon: poi.categoryIcon,
              items: []
            };
          }
          grouped[key].items.push(poi);
        });
        return Object.values(grouped);
      }

      function renderPOIList(groupedPOIs) {
        const container = document.getElementById('poi-list');
        container.innerHTML = '';
        
        groupedPOIs.forEach((group, index) => {
          const item = createPOIListItem(group, index);
          container.appendChild(item);
        });
      }

      function createPOIListItem(group, index) {
        const wrapper = document.createElement('div');
        wrapper.className = 'poi-list-item';
        wrapper.dataset.poiGroup = index;
        
        const count = group.items.length;
        const isMultiple = count > 1;
        
        const firstItem = group.items[0];
        const shortDescription = firstItem.description ? 
          (firstItem.description.length > 50 ? firstItem.description.substring(0, 50) + '...' : firstItem.description) : 
          firstItem.location || '';
        
        wrapper.innerHTML = `
          <div class="poi-list-item-main" data-group-index="${index}">
            <div class="poi-list-item-header">
              <h5>${group.name}${isMultiple ? ` (${count}곳)` : ''}</h5>
            </div>
            <p class="poi-list-item-description">${shortDescription}</p>
            ${isMultiple ? '<div class="poi-list-item-arrow">▼</div>' : ''}
          </div>
        `;
        
        const mainElement = wrapper.querySelector('.poi-list-item-main');
        mainElement.addEventListener('click', (e) => {
          e.stopPropagation();
          selectPOIItem(group, index);
        });
        
        if (isMultiple) {
          const subContainer = document.createElement('div');
          subContainer.className = 'poi-list-subitems';
          subContainer.style.display = 'none';
          subContainer.id = `subitems-${index}`;
          wrapper.appendChild(subContainer);
        }
        
        return wrapper;
      }

      function selectPOIItem(group, index) {
        const count = group.items.length;
        if (count > 1) {
          toggleGroupExpanded(group, index);
        } else {
          showPOIDetailSingle(group.items[0]);
        }
      }

      function toggleGroupExpanded(group, index) {
        const subContainer = document.getElementById(`subitems-${index}`);
        const arrow = document.querySelector(`[data-group-index="${index}"] .poi-list-item-arrow`);
        
        if (expandedGroups.has(index)) {
          expandedGroups.delete(index);
          subContainer.style.display = 'none';
          arrow.textContent = '▼';
          const panel = document.getElementById('poi-detail-panel');
          panel.innerHTML = '<div class="poi-detail-placeholder"><p>좌측에서 장소를 선택하면 상세 정보가 표시됩니다.</p></div>';
          currentExpandedGroup = null;
        } else {
          expandedGroups.add(index);
          subContainer.style.display = 'block';
          arrow.textContent = '▲';
          subContainer.innerHTML = '';
          group.items.forEach((item, idx) => {
            const subItem = createSubItem(group.name, item, idx);
            subContainer.appendChild(subItem);
          });
        }
      }

      function createSubItem(groupName, item, idx) {
        const subItem = document.createElement('div');
        subItem.className = 'poi-list-subitem';
        subItem.innerHTML = `
          <div class="poi-list-subitem-header">
            <h6>📍 ${item.location || '위치 정보 없음'}</h6>
            ${item.businessHours ? `<p class="poi-list-subitem-hours">🕐 ${item.businessHours}</p>` : ''}
          </div>
        `;
        
        subItem.addEventListener('click', (e) => {
          e.stopPropagation();
          showPOIDetailSingle(item);
        });
        
        return subItem;
      }

      function showPOIDetailSingle(poi) {
        const panel = document.getElementById('poi-detail-panel');
        panel.innerHTML = `
          ${poi.imageUrl ? `<img src="${poi.imageUrl}" alt="${poi.name}" class="poi-detail-image" onerror="this.style.display='none'">` : ''}
          <div class="poi-detail-header">
            <h3>${poi.name}</h3>
          </div>
          <div class="poi-detail-content">
            ${poi.description ? `<p class="poi-detail-description">${poi.description}</p>` : ''}
            ${poi.location ? `<p class="poi-detail-location">📍 ${poi.location}</p>` : ''}
            ${poi.businessHours ? `<p class="poi-detail-hours">🕐 ${poi.businessHours}</p>` : ''}
            ${poi.phoneNumber ? `<p class="poi-detail-phone">📞 ${poi.phoneNumber}</p>` : ''}
            ${poi.website ? `<p class="poi-detail-website">🌐 <a href="${poi.website}" target="_blank">${poi.website}</a></p>` : ''}
            ${poi.cost ? `<p class="poi-detail-cost">💰 ${poi.cost}</p>` : ''}
          </div>
          <div class="poi-detail-actions">
            <div class="time-input-section">
              <label class="time-label">예상 소요시간:</label>
              <input type="number" class="time-input" value="${poi.estimatedTime || 5}" min="1" max="300" 
                     onchange="updatePOITimeForItem('${poi.id}', this.value)">
              <span class="time-unit">분</span>
            </div>
            <button class="btn btn--primary" onclick="selectPOISingle('${poi.id}')">
              선택
            </button>
          </div>
        `;
      }

      function selectPOISingle(poiId) {
        // allPOIsMap에서 먼저 찾고, 없으면 allPOIs에서 찾기
        let poi = allPOIsMap.get(poiId);
        if (!poi) {
          poi = allPOIs.find(p => p.id === poiId);
        }
        if (!poi) return;
        
        // 중복 선택 확인
        if (selectedPOIs.includes(poiId)) {
          showToast({ message: '이미 선택한 장소입니다.', type: 'warning' });
          return;
        }
        
        selectedPOIs.push(poiId);
        updateSelectedPOIsList();
        updatePOINextButton();
        
        // 성공 메시지 추가
        showToast({ message: `${poi.name}이(가) 리스트에 추가되었습니다.`, type: 'success' });
      }

      function updatePOITimeForItem(poiId, time) {
        const timeValue = parseInt(time);
        if (isNaN(timeValue) || timeValue < 1 || timeValue > 300) {
          const input = document.querySelector('.poi-detail-actions .time-input');
          if (input) input.value = 10;
          return;
        }
        const poi = allPOIs.find(p => p.id === poiId);
        if (poi) {
          poi.estimatedTime = timeValue;
        }
        updateSelectedPOIsList();
      }

      function togglePOI(poiId) {
        // allPOIsMap에서 먼저 찾고, 없으면 allPOIs에서 찾기
        let poi = allPOIsMap.get(poiId);
        if (!poi) {
          poi = allPOIs.find(p => p.id === poiId);
        }
        if (!poi) return;
        
        selectedPOIs = selectedPOIs.filter(id => id !== poiId);
        updateSelectedPOIsList();
        updatePOINextButton();
        
        // 제거 메시지 추가
        showToast({ message: `${poi.name}이(가) 리스트에서 제거되었습니다.`, type: 'info' });
      }

      function updateSelectedPOIsList() {
        const container = document.getElementById('selected-list');
        if (!container) return;
        
        if (selectedPOIs.length === 0) {
          container.innerHTML = '<p class="empty-message">아직 선택한 장소가 없습니다.</p>';
          return;
        }
        
        container.innerHTML = selectedPOIs.map(poiId => {
          // allPOIsMap에서 먼저 찾고, 없으면 allPOIs에서 찾기
          let poi = allPOIsMap.get(poiId);
          if (!poi) {
            poi = allPOIs.find(p => p.id === poiId);
          }
          
          if (!poi) return '';
          
          return `
            <div class="selected-poi-item">
              <div class="poi-info">
                <h5>${poi.name}</h5>
              </div>
              <div class="poi-time">
                <span class="time-label">소요시간:</span>
                <span class="time-value">${poi.estimatedTime || 10}분</span>
              </div>
              <button class="btn btn--small btn--ghost" onclick="togglePOI('${poiId}')">제거</button>
            </div>
          `;
        }).join('');
      }

      function updatePOINextButton() {
        // updatePreferencesPOINextButton으로 통합됨 (동일한 버튼 제어)
        updatePreferencesPOINextButton(); // 실제로 호출하도록 수정
      }

      function filterPOIs(type) {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
          if (btn.dataset.type === type) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        loadPOIListWithFilter(type === 'all' ? null : type);
      }

      // 도시 선호도 초기화
      function initializeCityPreferences() {
        const cards = document.querySelectorAll('#city-preferences-step .preference-card');
        cards.forEach(card => {
          card.addEventListener('click', function() {
            toggleCityPreference(this.dataset.category);
          });
        });

        // 체류 시간 슬라이더와 숫자 입력 동기화
        const slider = document.getElementById('city-default-stay');
        const numberInput = document.getElementById('city-stay-number');
        
        if (slider && numberInput) {
          // 슬라이더 값 변경 시 숫자 입력 업데이트
          slider.addEventListener('input', function() {
            numberInput.value = this.value;
          });
          
          // 숫자 입력 값 변경 시 슬라이더 업데이트
          numberInput.addEventListener('input', function() {
            let value = parseInt(this.value);
            if (value < 20) value = 20;
            if (value > 240) value = 240;
            this.value = value;
            slider.value = value;
          });
        }
      }

      // 공항 선호도 토글
      function togglePreference(category) {
        const card = document.querySelector(`#preferences-step [data-category="${category}"]`);
        
        if (selectedAirportPreferences.includes(category)) {
          selectedAirportPreferences = selectedAirportPreferences.filter(p => p !== category);
          card.classList.remove('selected');
        } else {
          selectedAirportPreferences.push(category);
          card.classList.add('selected');
        }
        
        updateAirportPreferencesNextButton();
      }

      // 공항 선호도 다음 버튼 업데이트
      function updateAirportPreferencesNextButton() {
        const nextButton = document.getElementById('preferences-next');
        nextButton.disabled = selectedAirportPreferences.length === 0;
      }

      // 공항 POI 선택 단계로 이동
      function nextToAirportPOISelection() {
        if (selectedAirportPreferences.length === 0) return;
        
        currentStep = 'airport-poi-selection';
        document.getElementById('preferences-step').style.display = 'none';
        document.getElementById('airport-poi-step').style.display = 'block';
        
        initializeAirportPOISelection();
      }

      // 공항 POI 선택 초기화
      function initializeAirportPOISelection() {
        generateAirportFilterButtons();
        generateAirportPOICards();
        updateAirportPOINextButton();
      }

      // 공항 필터 버튼 생성
      function generateAirportFilterButtons() {
        const container = document.getElementById('airport-filter-buttons');
        container.innerHTML = '';
        
        const allButton = document.createElement('button');
        allButton.className = 'filter-btn active';
        allButton.textContent = '전체';
        allButton.onclick = () => filterAirportPOIs('all');
        container.appendChild(allButton);
        
        selectedAirportPreferences.forEach(category => {
          const button = document.createElement('button');
          button.className = 'filter-btn';
          button.textContent = getCategoryLabel(category);
          button.onclick = () => filterAirportPOIs(category);
          container.appendChild(button);
        });
      }

      // 공항 POI 카드 생성 (임시 데이터)
      function generateAirportPOICards() {
        const container = document.getElementById('airport-poi-grid');
        container.innerHTML = '';
        
        // 임시 공항 POI 데이터
        const sampleAirportPOIs = [
          { id: 1, name: '면세점 A', category: 'shopping', description: '브랜드 면세점', estimatedTime: 60 },
          { id: 2, name: '공항 카페', category: 'food', description: '로컬 커피 전문점', estimatedTime: 30 },
          { id: 3, name: '문화 전시관', category: 'culture', description: '한국 전통 문화 체험', estimatedTime: 45 },
          { id: 4, name: '스파 & 마사지', category: 'relax', description: '공항 내 휴식 공간', estimatedTime: 90 },
          { id: 5, name: '게임존', category: 'entertainment', description: 'VR 게임 체험', estimatedTime: 30 },
          { id: 6, name: '은행 ATM', category: 'services', description: '환전 및 현금 인출', estimatedTime: 15 }
        ];
        
        sampleAirportPOIs.forEach(poi => {
          if (selectedAirportPreferences.includes(poi.category) || selectedAirportPreferences.length === 0) {
            const card = createAirportPOICard(poi);
            container.appendChild(card);
          }
        });
      }

      // 공항 POI 카드 생성
      function createAirportPOICard(poi) {
        const card = document.createElement('div');
        card.className = 'poi-card';
        card.dataset.poiId = poi.id;
        card.dataset.category = poi.category;
        
        card.innerHTML = `
          <div class="poi-header">
            <h4>${poi.name}</h4>
            <span class="poi-category">${getCategoryLabel(poi.category)}</span>
          </div>
          <p class="poi-description">${poi.description}</p>
          <div class="poi-footer">
            <span class="estimated-time">예상 소요시간: ${poi.estimatedTime}분</span>
            <button class="btn btn--small" onclick="toggleAirportPOI(${poi.id})">선택</button>
          </div>
        `;
        
        return card;
      }

      // 공항 POI 토글
      function toggleAirportPOI(poiId) {
        const card = document.querySelector(`#airport-poi-grid [data-poi-id="${poiId}"]`);
        const button = card.querySelector('button');
        
        if (selectedPOIs.includes(poiId)) {
          selectedPOIs = selectedPOIs.filter(id => id !== poiId);
          card.classList.remove('selected');
          button.textContent = '선택';
        } else {
          selectedPOIs.push(poiId);
          card.classList.add('selected');
          button.textContent = '선택됨';
        }
        
        updateSelectedPOIsList();
        updatePOINextButton();
      }

      // 선택된 공항 POI 목록 업데이트 (deprecated, using updateSelectedPOIsList)
      function updateAirportSelectedPOIsList() {
        updateSelectedPOIsList();
      }
      
      function updateAirportSelectedPOIsList2() {
        const container = document.getElementById('airport-selected-list');
        
        if (selectedPOIs.length === 0) {
          container.innerHTML = '<p class="empty-message">아직 선택한 장소가 없습니다.</p>';
          return;
        }
        
        container.innerHTML = selectedPOIs.map(poiId => {
          const card = document.querySelector(`#airport-poi-grid [data-poi-id="${poiId}"]`);
          const name = card.querySelector('h4').textContent;
          const category = card.querySelector('.poi-category').textContent;
          const time = card.querySelector('.estimated-time').textContent;
          
          return `
            <div class="selected-poi-item">
              <div class="poi-info">
                <h5>${name}</h5>
                <span class="poi-category">${category}</span>
              </div>
              <div class="poi-time">${time}</div>
              <button class="btn btn--small btn--ghost" onclick="toggleAirportPOI(${poiId})">제거</button>
            </div>
          `;
        }).join('');
      }

      // 공항 POI 다음 버튼 업데이트
      function updateAirportPOINextButton() {
        const nextButton = document.getElementById('airport-poi-next');
        nextButton.disabled = selectedPOIs.length === 0;
      }

      // 공항 필터 적용
      function filterAirportPOIs(category) {
        document.querySelectorAll('#airport-filter-buttons .filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('#airport-poi-grid .poi-card').forEach(card => {
          if (category === 'all' || card.dataset.category === category) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }

      // 도시 선호도 토글
      function toggleCityPreference(category) {
        console.log('toggleCityPreference 호출됨:', category);
        console.log('현재 selectedCityPreferences:', selectedCityPreferences);
        
        const card = document.querySelector(`#city-preferences-step [data-category="${category}"]`);
        
        if (selectedCityPreferences.includes(category)) {
          selectedCityPreferences = selectedCityPreferences.filter(p => p !== category);
          card.classList.remove('selected');
          console.log('도시 선택 해제:', category);
        } else {
          // 최대 3개까지만 선택 가능
          if (selectedCityPreferences.length >= 3) {
            alert('최대 3개의 카테고리만 선택할 수 있습니다.');
            return;
          }
          selectedCityPreferences.push(category);
          card.classList.add('selected');
          console.log('도시 선택 추가:', category);
        }
        
        console.log('업데이트된 selectedCityPreferences:', selectedCityPreferences);
        updateCityPreferencesNextButton();
      }

      // 도시 선호도 다음 버튼 업데이트
      function updateCityPreferencesNextButton() {
        const nextButton = document.getElementById('city-preferences-next');
        const hasSelected = selectedCityPreferences.length > 0;
        
        // disabled 대신 CSS로 시각적 비활성화 (클릭은 가능하게 하여 toast 표시)
        if (!hasSelected) {
          nextButton.style.opacity = '0.5';
          nextButton.style.cursor = 'not-allowed';
        } else {
          nextButton.style.opacity = '1';
          nextButton.style.cursor = 'pointer';
        }
      }

      // 도시 선호도 단계로 이동
      function nextToCityPreferences() {
        // 검증: 카테고리 선택 확인
        if (!selectedTable) {
          showToast({ message: '관심 카테고리를 먼저 선택해주세요.', type: 'warning' });
          return;
        }
        
        // 검증: 장소 선택 확인
        if (selectedPOIs.length === 0) {
          showToast({ message: '방문할 장소를 먼저 선택해주세요.', type: 'warning' });
          return;
        }
        
        // 공항 내부 일정 페이지로 이동
        currentStep = 'airport-schedule';
        document.getElementById('preferences-poi-step').style.display = 'none';
        document.getElementById('airport-schedule-step').style.display = 'block';
        
        // 공항 내부 일정 생성
        generateSchedule();
      }

      // 도시 선호도 페이지로 이동 (공항 내부 일정 페이지에서 호출)
      function goToCityPreferences() {
        currentStep = 'city-preferences';
        document.getElementById('airport-schedule-step').style.display = 'none';
        document.getElementById('city-preferences-step').style.display = 'block';
        
        // 도시 선호도 초기화
        initializeCityPreferences();
      }

      function backToPOISelection() {
        currentStep = 'preferences';
        document.getElementById('airport-schedule-step').style.display = 'none';
        document.getElementById('preferences-poi-step').style.display = 'block';
      }

      function generateSchedule() {
        console.log('📝 공항 내부 일정 생성 시작');
        console.log('selectedPOIs:', selectedPOIs);
        
        const container = document.getElementById('timeline');
        container.innerHTML = '';
        
        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        selectedPOIs.forEach((poiId, index) => {
          // allPOIsMap에서 먼저 찾고, 없으면 allPOIs에서 찾기
          let poi = allPOIsMap.get(poiId);
          if (!poi) {
            poi = allPOIs.find(p => p.id === poiId);
          }
          
          console.log(`POI ${index + 1} 조회:`, poiId, poi);
          if (!poi) return;
          
          const timelineItem = document.createElement('div');
          timelineItem.className = 'timeline-item';
          
          const startTime = new Date(currentTime);
          const endTime = new Date(currentTime.getTime() + (poi.estimatedTime || 10) * 60000);
          
          // 이미지 HTML 추가 (airport-only.html과 동일)
          const imageHtml = poi.imageUrl ? 
            `<div class="timeline-image"><img src="${poi.imageUrl}" alt="${poi.name}" onerror="this.style.display='none'"></div>` : '';
          
          timelineItem.innerHTML = `
            <div class="timeline-time">
              <span class="start-time">${formatTime(startTime)}</span>
              <span class="end-time">${formatTime(endTime)}</span>
            </div>
            <div class="timeline-content">
              <h4>${poi.name}</h4>
              <span class="timeline-category">${poi.categoryIcon || '📍'} ${poi.category || ''}</span>
              ${poi.location ? `<p class="timeline-location">📍 ${poi.location}</p>` : ''}
              <p>${poi.estimatedTime || 10}분 체류</p>
            </div>
            ${imageHtml}
          `;
          
          container.appendChild(timelineItem);
          currentTime = endTime;
        });
        
        console.log('📝 공항 내부 일정 생성 완료');
      }

      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // 일정 저장 (PDF 다운로드)
      async function saveSchedule() {
        try {
          const scheduleContent = document.getElementById('airport-schedule-step');
          
          // html2canvas로 HTML을 이미지로 변환
          const canvas = await html2canvas(scheduleContent, {
            useCORS: true,
            scale: 2,
            backgroundColor: '#ffffff'
          });
          
          // PDF 생성
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
          });
          
          // 이미지 크기 계산
          const imgWidth = 210; // A4 width in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          // 이미지를 PDF에 추가
          const imgData = canvas.toDataURL('image/png');
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          
          // PDF 저장
          const fileName = `공항내부일정_${transferInfo.city}_${new Date().toISOString().split('T')[0]}.pdf`;
          pdf.save(fileName);
          
          alert('✅ PDF가 다운로드되었습니다!');
        } catch (error) {
          console.error('PDF 생성 실패:', error);
          alert('❌ PDF 생성에 실패했습니다.');
        }
      }

      // 일정 공유
      function shareSchedule() {
        let shareText = `🏢 공항 내부 일정\n\n`;
        shareText += `경유 도시: ${transferInfo.city}\n`;
        shareText += `환승 시간: ${formatDuration(transferInfo.duration)}\n\n`;
        shareText += `📍 방문 장소:\n`;
        
        selectedPOIs.forEach((poiId, index) => {
          const poi = allPOIs.find(p => p.id === poiId);
          if (poi) {
            shareText += `${index + 1}. ${poi.name}\n`;
            shareText += `   위치: ${poi.location}\n`;
            shareText += `   소요 시간: ${poi.estimatedTime}분\n`;
            if (poi.businessHours) {
              shareText += `   영업 시간: ${poi.businessHours}\n`;
            }
            shareText += `\n`;
          }
        });
        
        // 클립보드에 복사
        navigator.clipboard.writeText(shareText).then(() => {
          alert('✅ 일정이 클립보드에 복사되었습니다!\n공유할 곳에 붙여넣기(Ctrl+V) 하세요.');
        }).catch((error) => {
          console.error('클립보드 복사 실패:', error);
          alert('❌ 일정 공유에 실패했습니다.');
        });
      }

      // 도시 POI 선택 단계로 이동
      async function nextToCityPOISelection() {
        // 검증: 도시 카테고리 선택 확인
        if (selectedCityPreferences.length === 0) {
          showToast({ message: '관심 카테고리를 먼저 선택해주세요.', type: 'warning' });
          return;
        }
        
        // 로딩 표시
        alert('일정을 생성하고 있습니다. 잠시만 기다려주세요...');
        
        try {
          // 공항 내부 POI 데이터를 sessionStorage에 저장
          const airportPOIData = {
            selectedPOIs: selectedPOIs,
            allPOIs: allPOIs,
            selectedTable: selectedTable,
            selectedTypes: selectedTypes
          };
          sessionStorage.setItem('airportPOIData', JSON.stringify(airportPOIData));
          console.log('✅ 공항 내부 POI 데이터 저장 완료:', airportPOIData);
          
          // 일정 생성
          await generateCityPlan();
          
          // 전체 일정 페이지로 이동
          currentStep = 'full-schedule';
          document.getElementById('city-preferences-step').style.display = 'none';
          document.getElementById('full-schedule-step').style.display = 'block';
          
          // 전체 일정 생성
          generateFullSchedule();
        } catch (error) {
          console.error('도시 일정 생성 실패:', error);
          alert('일정 생성에 실패했습니다. 다시 시도해주세요.');
        }
      }
      
      // 도시 일정 생성
      async function generateCityPlan() {
        console.log('🏙️ [generateCityPlan] 도시 일정 생성 시작');
        
        // transferInfo에서 도착/출발 시간 가져오기
        const arrivalTime = new Date(transferInfo.arrival);
        const departureTime = new Date(transferInfo.departure);
        
        // 버퍼 시간 설정 (기본값 사용)
        const entryBufferMinutes = 90; // 입국 버퍼
        const returnBufferMinutes = 120; // 복귀 버퍼
        
        // 기본 체류 시간 가져오기
        const defaultStayMinutes = parseInt(document.getElementById('city-stay-number')?.value || '60', 10);
        
        // 탐방 가능 시간 계산
        const startWindow = new Date(arrivalTime.getTime() + entryBufferMinutes * 60000);
        const endWindow = new Date(departureTime.getTime() - returnBufferMinutes * 60000);
        const availableMinutes = Math.max((endWindow.getTime() - startWindow.getTime()) / 60000, 0);
        
        console.log('⏰ [generateCityPlan] 도시 탐방 시간:', {
          start: startWindow.toISOString(),
          end: endWindow.toISOString(),
          available: availableMinutes,
          selectedCategories: selectedCityPreferences
        });
        
        // 도시 POI 검색 (POI Service Manager 사용)
        if (!window.poiServiceManager) {
          throw new Error('POI Service Manager가 초기화되지 않았습니다.');
        }
        
        // 싱가포르 도시 중심 좌표
        const cityCenter = { lat: 1.3521, lng: 103.8198 }; // Singapore city center
        
        // 1단계: 각 카테고리별로 POI 검색 (균형 있는 선택을 위해 충분히 가져오기)
        const categoryPOIsMap = new Map(); // 카테고리별 POI 그룹
        const targetCount = 3; // 최종적으로 선택할 POI 개수
        
        console.log('🔍 [generateCityPlan] 카테고리별 POI 검색 시작');
        
        for (const category of selectedCityPreferences) {
          const pois = await window.poiServiceManager.searchCityPOIs(cityCenter, [category], 10000); // 10km 반경
          
          if (pois.length > 0) {
            // 각 카테고리별로 최소 5-10개 정도는 가져와서 운영 시간 필터링 후 선택
            categoryPOIsMap.set(category, pois.slice(0, 10)); // 상위 10개만 사용
          }
        }
        
        console.log('📊 [generateCityPlan] 카테고리별 POI 검색 완료:', {
          totalCategories: categoryPOIsMap.size,
          poisPerCategory: Array.from(categoryPOIsMap.entries()).map(([cat, pois]) => ({ category: cat, count: pois.length }))
        });
        
        // 2단계: 각 POI의 상세 정보(운영 시간 포함) 가져오기 및 운영 시간 필터링
        const allPOIsWithDetails = [];
        const exploreWindow = {
          start: startWindow,
          end: endWindow,
          durationMinutes: defaultStayMinutes,
          timeZone: 'Asia/Singapore' // 싱가포르 시간대
        };
        
        for (const [category, pois] of categoryPOIsMap.entries()) {
          for (let i = 0; i < pois.length; i++) {
            const poi = pois[i];
            if (!poi.id) {
              console.warn(`  ⚠️ [generateCityPlan] POI "${poi.name}"에 place_id가 없습니다.`);
              continue;
            }
            
            try {
              // POI 상세 정보 가져오기 (opening_hours 포함)
              const poiDetails = await window.getPOIInfo(poi.id);
              
              if (!poiDetails) {
                console.warn(`  ⚠️ [generateCityPlan] POI "${poi.name}" 상세 정보를 가져올 수 없습니다.`);
                continue;
              }
              
              // 운영 시간 확인을 위한 travelTime 생성 (exploreWindow 중간 시점을 방문 시간으로 가정)
              const visitStartTime = new Date(startWindow.getTime() + (i * (availableMinutes / categoryPOIsMap.size / 2) * 60000));
              const travelTime = {
                start: visitStartTime,
                durationMinutes: defaultStayMinutes,
                timeZone: 'Asia/Singapore'
              };
              
              // 운영 상태 확인
              const businessStatus = window.getBusinessStatus(poiDetails, travelTime);
              
              console.log(`  🔍 [generateCityPlan] POI "${poi.name}" 영업 상태 확인:`, {
                name: poi.name,
                businessStatus,
                hasOpeningHours: !!poiDetails.opening_hours,
                visitStartTime: visitStartTime.toISOString(),
                visitEndTime: new Date(visitStartTime.getTime() + defaultStayMinutes * 60000).toISOString(),
                timeZone: travelTime.timeZone
              });
              
              // OPEN 상태인 POI만 추가 (UNKNOWN과 CLOSED는 제외)
              if (businessStatus === 'OPEN') {
                allPOIsWithDetails.push({
                  ...poi,
                  ...poiDetails,
                  category,
                  businessStatus,
                  visitStartTime
                });
                
                console.log(`  ✅ [generateCityPlan] "${poi.name}" 추가됨 (${businessStatus})`);
                
                // 충분한 POI를 모으면 중단 (성능 최적화)
                if (allPOIsWithDetails.length >= targetCount * 2) {
                  console.log(`  📊 [generateCityPlan] 충분한 POI를 수집했습니다 (${allPOIsWithDetails.length}개). 조회 중단.`);
                  break;
                }
              } else {
                console.log(`  ❌ [generateCityPlan] "${poi.name}" 제외됨 (영업 상태: ${businessStatus})`);
              }
            } catch (error) {
              console.error(`  ❌ [generateCityPlan] POI "${poi.name}" 상세 정보 조회 실패:`, error);
              // 에러가 발생해도 다음 POI 계속 검색
              continue;
            }
          }
        }
        
        console.log('📊 [generateCityPlan] 운영 시간 필터링 완료:', {
          totalOpen: allPOIsWithDetails.length,
          categories: Array.from(new Set(allPOIsWithDetails.map(p => p.category)))
        });
        
        // 3단계: 카테고리별 균형 있는 선택
        console.log('⚖️ [generateCityPlan] 카테고리별 균형 있는 선택 시작');
        const selectedPOIs = [];
        const categoryCount = selectedCityPreferences.length;
        const poisPerCategory = Math.ceil(targetCount / categoryCount); // 카테고리당 최소 개수
        
        // 카테고리별로 분류
        const poisByCategory = new Map();
        for (const poi of allPOIsWithDetails) {
          if (!poisByCategory.has(poi.category)) {
            poisByCategory.set(poi.category, []);
          }
          poisByCategory.get(poi.category).push(poi);
        }
        
        
        // 카테고리별로 균형 있게 선택 (라운드 로빈 방식)
        const categoryIndices = new Map(); // 각 카테고리의 현재 인덱스
        selectedCityPreferences.forEach(cat => categoryIndices.set(cat, 0));
        
        while (selectedPOIs.length < targetCount && allPOIsWithDetails.length > 0) {
          let found = false;
          
          // 각 카테고리를 순회하면서 하나씩 선택
          for (const category of selectedCityPreferences) {
            if (selectedPOIs.length >= targetCount) break;
            
            const categoryPOIs = poisByCategory.get(category) || [];
            const currentIndex = categoryIndices.get(category) || 0;
            
            if (currentIndex < categoryPOIs.length) {
              const poi = categoryPOIs[currentIndex];
              
              // 중복 체크 (이미 선택된 POI 제외)
              if (!selectedPOIs.some(sp => sp.id === poi.id)) {
                selectedPOIs.push(poi);
                categoryIndices.set(category, currentIndex + 1);
                found = true;
              } else {
                categoryIndices.set(category, currentIndex + 1);
              }
            }
          }
          
          // 더 이상 선택할 수 없으면 종료
          if (!found) {
            break;
          }
        }
        
        // 선택된 POI가 부족한 경우, 나머지는 평점/리뷰 기준으로 추가
        if (selectedPOIs.length < targetCount) {
          const remainingPOIs = allPOIsWithDetails
            .filter(poi => !selectedPOIs.some(sp => sp.id === poi.id))
            .sort((a, b) => {
              // 평점 우선, 그 다음 리뷰 수
              if (b.rating !== a.rating) return b.rating - a.rating;
              return (b.userRatingsTotal || 0) - (a.userRatingsTotal || 0);
            });
          
          while (selectedPOIs.length < targetCount && remainingPOIs.length > 0) {
            selectedPOIs.push(remainingPOIs.shift());
          }
        }
        
        console.log('✅ [generateCityPlan] 카테고리별 균형 선택 완료:', {
          selectedCount: selectedPOIs.length,
          categories: Array.from(new Set(selectedPOIs.map(p => p.category))),
          selectedPOIs: selectedPOIs.map(p => ({ name: p.name, category: p.category, rating: p.rating }))
        });
        
        // 검색된 POI를 waypoint 형태로 변환 (Google Maps API 실제 데이터 포함)
        const waypoints = selectedPOIs.map((poi, index) => ({
          label: poi.name,
          address: poi.address || poi.location,
          location: poi.location,
          categoryKey: poi.category,
          category: poi.category, // 카테고리 라벨
          categoryIcon: poi.categoryIcon, // 하드코딩된 이모지
          stayMinutes: defaultStayMinutes,
          rating: poi.rating || 0, // Google Maps API에서 가져온 실제 평점
          userRatingsTotal: poi.userRatingsTotal || 0, // Google Maps API에서 가져온 실제 리뷰 수
          photos: poi.photos || [] // Google Maps Photo 객체
        }));
        
        // 공항 앵커 생성
        const arriveAnchor = {
          label: '싱가포르 창이공항',
          address: 'Singapore Changi Airport',
          location: { lat: 1.3644, lng: 103.9915 },
          placeId: null
        };
        
        // 일정 데이터 생성
        const plan = {
          origin: arriveAnchor,
          destination: arriveAnchor,
          waypoints,
          meta: {
            // 원본 도착/출발 시간 (transfer-info에서 입력한 값)
            originalArrival: arrivalTime.toISOString(),
            originalDeparture: departureTime.toISOString(),
            // 버퍼 적용된 도착/출발 시간
            arrival: startWindow.toISOString(),
            departure: endWindow.toISOString(),
            entryBufferMinutes,
            returnBufferMinutes,
            exploreWindow: {
              start: startWindow.toISOString(),
              end: endWindow.toISOString(),
              availableMinutes: Math.round(availableMinutes)
            },
            categoriesUsed: selectedCityPreferences,
            cityText: 'Singapore',
            timeZone: 'Asia/Singapore' // 싱가포르 시간대 명시적으로 저장
          }
        };
        
        // 생성된 일정 저장
        sessionStorage.setItem('cityPlan', JSON.stringify(plan));
        
        console.log('✅ [generateCityPlan] 도시 일정 생성 완료:', {
          selectedCategories: selectedCityPreferences,
          selectedPOIs: selectedPOIs.map(p => ({
            name: p.name,
            category: p.category,
            rating: p.rating,
            businessStatus: p.businessStatus
          })),
          waypointsCount: waypoints.length,
          originalArrival: arrivalTime.toISOString(),
          originalDeparture: departureTime.toISOString(),
          bufferedArrival: startWindow.toISOString(),
          bufferedDeparture: endWindow.toISOString(),
          entryBuffer: entryBufferMinutes,
          returnBuffer: returnBufferMinutes,
          availableMinutes: Math.round(availableMinutes)
        });
        
        return plan;
      }

      // 도시 POI 선택 초기화
      function initializeCityPOISelection() {
        generateCityFilterButtons();
        generateCityPOICards();
        updateCityPOINextButton();
      }

      // 도시 필터 버튼 생성
      function generateCityFilterButtons() {
        const container = document.getElementById('city-filter-buttons');
        container.innerHTML = '';
        
        const allButton = document.createElement('button');
        allButton.className = 'filter-btn active';
        allButton.textContent = '전체';
        allButton.onclick = () => filterCityPOIs('all');
        container.appendChild(allButton);
        
        selectedCityPreferences.forEach(category => {
          const button = document.createElement('button');
          button.className = 'filter-btn';
          button.textContent = getCityCategoryLabel(category);
          button.onclick = () => filterCityPOIs(category);
          container.appendChild(button);
        });
      }

      // 도시 카테고리 라벨 가져오기
      function getCityCategoryLabel(category) {
        const labels = {
          attractions: '관광명소',
          shopping: '쇼핑',
          food: '음식',
          culture: '문화체험',
          nature: '자연',
          nightlife: '야경/야생활'
        };
        return labels[category] || category;
      }

      // 도시 POI 카드 생성 (임시 데이터)
      function generateCityPOICards() {
        const container = document.getElementById('city-poi-grid');
        container.innerHTML = '';
        
        // 임시 도시 POI 데이터
        const sampleCityPOIs = [
          { id: 101, name: '도시 랜드마크', category: 'attractions', description: '유명한 관광명소', estimatedTime: 120 },
          { id: 102, name: '로컬 시장', category: 'shopping', description: '전통 시장 체험', estimatedTime: 90 },
          { id: 103, name: '전통 맛집', category: 'food', description: '로컬 전통 음식', estimatedTime: 60 },
          { id: 104, name: '박물관', category: 'culture', description: '역사 문화 체험', estimatedTime: 90 },
          { id: 105, name: '중앙 공원', category: 'nature', description: '자연 휴식 공간', estimatedTime: 60 },
          { id: 106, name: '야경 전망대', category: 'nightlife', description: '도시 야경 감상', estimatedTime: 45 }
        ];
        
        sampleCityPOIs.forEach(poi => {
          if (selectedCityPreferences.includes(poi.category) || selectedCityPreferences.length === 0) {
            const card = createCityPOICard(poi);
            container.appendChild(card);
          }
        });
      }

      // 도시 POI 카드 생성
      function createCityPOICard(poi) {
        const card = document.createElement('div');
        card.className = 'poi-card';
        card.dataset.poiId = poi.id;
        card.dataset.category = poi.category;
        
        card.innerHTML = `
          <div class="poi-header">
            <h4>${poi.name}</h4>
            <span class="poi-category">${getCityCategoryLabel(poi.category)}</span>
          </div>
          <p class="poi-description">${poi.description}</p>
          <div class="poi-footer">
            <span class="estimated-time">예상 소요시간: ${poi.estimatedTime}분</span>
            <button class="btn btn--small" onclick="toggleCityPOI(${poi.id})">선택</button>
          </div>
        `;
        
        return card;
      }

      // 도시 POI 토글
      function toggleCityPOI(poiId) {
        const card = document.querySelector(`#city-poi-grid [data-poi-id="${poiId}"]`);
        if (!card) return;
        
        const button = card.querySelector('button');
        if (!button) return;
        
        // 이미 선택된 경우 제거
        if (selectedCityPOIs.includes(poiId)) {
          selectedCityPOIs = selectedCityPOIs.filter(id => id !== poiId);
          card.classList.remove('selected');
          button.textContent = '선택';
        } else {
          // 중복 선택 확인 (이미 선택된 경우)
          if (selectedCityPOIs.includes(poiId)) {
            showToast({ message: '이미 선택한 장소입니다.', type: 'warning' });
            return;
          }
          
          selectedCityPOIs.push(poiId);
          card.classList.add('selected');
          button.textContent = '선택됨';
        }
        
        updateCitySelectedPOIsList();
        updateCityPOINextButton();
      }

      // 선택된 도시 POI 목록 업데이트
      function updateCitySelectedPOIsList() {
        const container = document.getElementById('city-selected-list');
        
        if (selectedCityPOIs.length === 0) {
          container.innerHTML = '<p class="empty-message">아직 선택한 장소가 없습니다.</p>';
          return;
        }
        
        container.innerHTML = selectedCityPOIs.map(poiId => {
          const card = document.querySelector(`#city-poi-grid [data-poi-id="${poiId}"]`);
          const name = card.querySelector('h4').textContent;
          const category = card.querySelector('.poi-category').textContent;
          const time = card.querySelector('.estimated-time').textContent;
          
          return `
            <div class="selected-poi-item">
              <div class="poi-info">
                <h5>${name}</h5>
                <span class="poi-category">${category}</span>
              </div>
              <div class="poi-time">${time}</div>
              <button class="btn btn--small btn--ghost" onclick="toggleCityPOI(${poiId})">제거</button>
            </div>
          `;
        }).join('');
      }

      // 도시 POI 다음 버튼 업데이트
      function updateCityPOINextButton() {
        const nextButton = document.getElementById('city-poi-next');
        nextButton.disabled = selectedCityPOIs.length === 0;
      }

      // 도시 필터 적용
      function filterCityPOIs(category) {
        document.querySelectorAll('#city-filter-buttons .filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('#city-poi-grid .poi-card').forEach(card => {
          if (category === 'all' || card.dataset.category === category) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }

      // 일정 단계로 이동
      async function nextToSchedule() {
        // 검증: 도시 장소 선택 확인
        if (selectedCityPOIs.length === 0) {
          showToast({ message: '방문할 장소를 먼저 선택해주세요.', type: 'warning' });
          return;
        }
        
        try {
          // 도시 일정 생성
          await generateCityPlan();
          
          // 전체 일정 페이지로 이동
          currentStep = 'full-schedule';
          document.getElementById('city-poi-step').style.display = 'none';
          document.getElementById('full-schedule-step').style.display = 'block';
          
          // 전체 일정 생성
          generateFullSchedule();
        } catch (error) {
          console.error('도시 일정 생성 실패:', error);
          showToast({ message: '일정 생성에 실패했습니다. 다시 시도해주세요.', type: 'error' });
        }
      }

      // 일정 생성
      // 전체 일정 생성 (전체 일정 페이지용)
      function generateFullSchedule() {
        generateAirportTimeline();
        generateCitySchedule();
      }

      // 공항 내부 타임라인 생성 (전체 일정 페이지용)
      function generateAirportTimeline() {
        const container = document.getElementById('airport-timeline');
        if (!container) return;
        container.innerHTML = '';
        
        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        selectedPOIs.forEach((poiId, index) => {
          const poi = allPOIs.find(p => p.id === poiId);
          if (!poi) return;
          
          const timelineItem = document.createElement('div');
          timelineItem.className = 'timeline-item';
          
          const startTime = new Date(currentTime);
          const endTime = new Date(currentTime.getTime() + poi.estimatedTime * 60000);
          
          timelineItem.innerHTML = `
            <div class="timeline-time">
              <span class="start-time">${formatTime(startTime)}</span>
              <span class="end-time">${formatTime(endTime)}</span>
            </div>
            <div class="timeline-content">
              <h4>${poi.name}</h4>
              <p>${poi.location || ''}</p>
            </div>
          `;
          
          container.appendChild(timelineItem);
          currentTime = endTime;
        });
      }

      // 도시 일정 생성
      function generateCitySchedule() {
        const container = document.getElementById('city-timeline');
        if (!container) return;
        container.innerHTML = '';
        
        // 저장된 도시 일정 가져오기
        const cityPlanStr = sessionStorage.getItem('cityPlan');
        if (!cityPlanStr) {
          container.innerHTML = '<p class="empty-message">도시 탐방 일정이 없습니다.</p>';
          return;
        }
        
        const cityPlan = JSON.parse(cityPlanStr);
        const { waypoints, meta } = cityPlan;
        
        if (!waypoints || waypoints.length === 0) {
          container.innerHTML = '<p class="empty-message">방문할 장소가 없습니다.</p>';
          return;
        }
        
        waypoints.forEach((waypoint, index) => {
          const poiCard = document.createElement('div');
          poiCard.className = 'city-poi-card';
          
          // 이미지, 평점, 리뷰 수 정보 표시 (Google Maps API 실제 데이터 사용)
          // photos는 Google Maps Photo 객체이거나 직렬화된 경우를 대비
          let imageUrl = null;
          if (waypoint.photos && waypoint.photos.length > 0) {
            const photo = waypoint.photos[0];
            if (typeof photo.getUrl === 'function') {
              // Google Maps Photo 객체인 경우
              try {
                imageUrl = photo.getUrl({ maxWidth: 300, maxHeight: 200 });
              } catch (e) {
                console.warn('Photo getUrl() 실패:', e);
              }
            } else if (photo.url) {
              // 직렬화된 경우 URL이 있을 수 있음
              imageUrl = photo.url;
            }
          }
          const rating = waypoint.rating || 0; // 실제 Google Maps API 평점 (폴백 제거)
          const reviewCount = waypoint.userRatingsTotal || 0; // 실제 Google Maps API 리뷰 수 (폴백 제거)
          const categoryIcon = waypoint.categoryIcon || '📍'; // 하드코딩된 이모지 (유지)
          
          poiCard.innerHTML = `
            <div class="poi-card-content">
              ${imageUrl ? `<img src="${imageUrl}" alt="${waypoint.label}" onerror="this.style.display='none'" />` : ''}
              <div class="poi-card-details">
                <h4>${waypoint.label}</h4>
                <p class="poi-address">${waypoint.address || '주소 정보 없음'}</p>
                <div class="poi-meta">
                  <div class="poi-rating">
                    <span class="rating-stars">⭐ ${rating.toFixed(1)}</span>
                    <span class="review-count">(${reviewCount.toLocaleString()}리뷰)</span>
                  </div>
                  <div class="poi-category-badge">
                    ${categoryIcon} ${waypoint.category || '기타'}
                  </div>
                </div>
              </div>
            </div>
          `;
          
          container.appendChild(poiCard);
        });
      }

      // 시간 포맷팅
      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // 네비게이션 시작
      function startNavigation() {
        // 도시 일정 가져오기
        const cityPlanStr = sessionStorage.getItem('cityPlan');
        const airportPOIDataStr = sessionStorage.getItem('airportPOIData');
        
        if (!cityPlanStr) {
          alert('도시 탐방 일정이 생성되지 않았습니다. 다시 시도해주세요.');
          return;
        }
        
        const cityPlan = JSON.parse(cityPlanStr);
        
        // navigation.html에서 사용할 형태로 데이터 저장
        const plan = {
          origin: cityPlan.origin,
          destination: cityPlan.destination,
          waypoints: cityPlan.waypoints,
          meta: cityPlan.meta
        };
        
        // sessionStorage에 저장
        sessionStorage.setItem('plannerResult', JSON.stringify(plan));
        
        // airport POI 데이터도 함께 저장
        if (airportPOIDataStr) {
          sessionStorage.setItem('airportPOIData', airportPOIDataStr);
        }
        
        // navigation.html로 이동
        window.location.href = 'navigation.html';
      }

      // 뒤로가기 함수들
      function backToAirportPreferences() {
        currentStep = 'preferences';
        document.getElementById('airport-poi-step').style.display = 'none';
        document.getElementById('preferences-step').style.display = 'block';
      }

      function backToAirportPOISelection() {
        // 공항 내부 일정 페이지로 돌아가기 (도시 선호도 페이지에서 온 경우)
        currentStep = 'airport-schedule';
        document.getElementById('city-preferences-step').style.display = 'none';
        document.getElementById('airport-schedule-step').style.display = 'block';
      }

      function backToCityPreferences() {
        currentStep = 'city-preferences';
        document.getElementById('city-poi-step').style.display = 'none';
        document.getElementById('city-preferences-step').style.display = 'block';
      }

      function backToCityPOISelection() {
        currentStep = 'city-poi-selection';
        document.getElementById('full-schedule-step').style.display = 'none';
        document.getElementById('city-poi-step').style.display = 'block';
      }

      // 카테고리 라벨 가져오기 (공항용)
      function getCategoryLabel(category) {
        const labels = {
          shopping: '쇼핑',
          food: '음식',
          culture: '문화체험',
          relax: '휴식',
          entertainment: '엔터테인먼트',
          services: '편의시설'
        };
        return labels[category] || category;
      }
    </script>
  </body>
</html>
