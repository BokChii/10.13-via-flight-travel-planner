<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <meta name="supabase-url" content="https://qghwyrdxxlsigtputuyj.supabase.co" />
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnaHd5cmR4eGxzaWd0cHV0dXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MjIyNzIsImV4cCI6MjA3OTA5ODI3Mn0.8Ia_UCE-HYjZy2XX0VYEAKY2zGaN1QlvcTUlPPK8mxY" />
    <meta name="openai-api-key" content="YOUR_OPENAI_API_KEY" />
    <title>ê³µí•­ ë‚´ë¶€+ì™¸ë¶€ ì—¬í–‰ ì¼ì • - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/airport-external.css" />
    <link rel="stylesheet" href="styles/pages/airport-only.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
    <link rel="stylesheet" href="styles/components/forms.css" />
    <link rel="stylesheet" href="styles/components/ai-chat.css" />
    <link rel="stylesheet" href="styles/components/steps.css" />
  </head>
  <body class="app airport-external-page">
    <header class="app-header">
      <div>
      <h1>Via Flight</h1>
      <p class="tagline">ê³µí•­ ë°– ì—¬í–‰ ì¼ì • ë§Œë“¤ê¸°</p>
      <nav class="breadcrumb">
        <a href="airport-main.html" class="breadcrumb__link">â† ì—¬í–‰ ìŠ¤íƒ€ì¼ ë‹¤ì‹œ ì„ íƒ</a>
      </nav>
      </div>
      
      <!-- ì¸ì¦ UI -->
      <div class="auth-container">
        <div class="user-info-container" style="display: none;" title="í”„ë¡œí•„ ë³´ê¸°">
          <span class="user-info"></span>
          <span class="user-email"></span>
        </div>
        <button class="auth-button" data-action="login" onclick="window.loginWithGoogle()">
          Googleë¡œ ë¡œê·¸ì¸
        </button>
        <button class="auth-button" data-action="logout" style="display: none;" onclick="window.logout()">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </header>

    <main class="airport-external-main">
      <!-- Progress Indicator -->
      <div class="progress-container">
        <div class="progress-steps">
          <div class="step completed">
            <div class="step-number">âœ“</div>
            <div class="step-label">í™˜ìŠ¹ ì •ë³´</div>
          </div>
          <div class="step completed">
            <div class="step-number">âœ“</div>
            <div class="step-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</div>
          </div>
          <div class="step active">
            <div class="step-number">3</div>
            <div class="step-label">ê³µí•­ ë‚´ë¶€</div>
          </div>
          <div class="step">
            <div class="step-number">4</div>
            <div class="step-label">ë„ì‹œ íƒë°©</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 75%"></div>
        </div>
      </div>

      <!-- Transfer Summary -->
      <section class="transfer-summary">
        <div class="summary-card">
          <h2 class="summary-title">ê³µí•­ ë‚´ë¶€ + ë„ì‹œ ì—¬í–‰ ì¼ì •</h2>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">ê²½ìœ  ë„ì‹œ</span>
              <span class="summary-value" id="summary-city">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">í™˜ìŠ¹ ì‹œê°„</span>
              <span class="summary-value" id="summary-duration">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</span>
              <span class="summary-value">ê³µí•­ + ë„ì‹œ</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Step 3: Airport Preferences + POI Selection (í†µí•©) -->
      <section class="preferences-poi-step" id="preferences-poi-step">
        <div class="step-container">
          <h2 class="step-title">ê³µí•­ ë‚´ë¶€ì—ì„œ ì–´ë–¤ ê²ƒì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš”?</h2>
          <p class="step-description">
            ê´€ì‹¬ ìˆëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê³ <br>
            ë°©ë¬¸í•˜ê³  ì‹¶ì€ ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
          </p>

          <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ì„¹ì…˜ -->
          <div class="preferences-section">
            <h3 class="section-title">ì¹´í…Œê³ ë¦¬ ì„ íƒ</h3>
            <div class="preference-cards">
              <button class="preference-card" data-table="rests_db_frame">
                <div class="preference-icon">ğŸ’†</div>
                <h3>íœ´ì‹ & ë¼ìš´ì§€</h3>
                <p>ë¼ìš´ì§€, íœ´ì‹ê³µê°„, í˜¸í…”</p>
              </button>
              <button class="preference-card" data-table="meal_options_db_frame">
                <div class="preference-icon">ğŸ½ï¸</div>
                <h3>ì‹ì‚¬ & ìŒë£Œ</h3>
                <p>ì‹ë‹¹, ì¹´í˜, ë””ì €íŠ¸</p>
              </button>
              <button class="preference-card" data-table="shopping_options_db_frame">
                <div class="preference-icon">ğŸ›ï¸</div>
                <h3>ì‡¼í•‘ & ë©´ì„¸</h3>
                <p>ë©´ì„¸ì , ë¸Œëœë“œìƒµ, ê¸°ë…í’ˆ</p>
              </button>
              <button class="preference-card" data-table="airport_events_db_frame">
                <div class="preference-icon">ğŸ®</div>
                <h3>ì²´í—˜ & ì´ë²¤íŠ¸</h3>
                <p>ë¬¸í™”ì²´í—˜, ì—”í„°í…Œì¸ë¨¼íŠ¸</p>
              </button>
            </div>
          </div>

          <!-- POI ì„ íƒ ì„¹ì…˜ -->
          <div class="poi-selection-section" id="poi-selection-section" style="display: none;">
            <h3 class="section-title">ë°©ë¬¸í•  ì¥ì†Œ ì„ íƒ</h3>
            <p class="open-only-hint">í™˜ìŠ¹ ì‹œê°„ ë™ì•ˆ ìš´ì˜ ì¤‘ì¸ ê³³ë§Œ í‘œì‹œë©ë‹ˆë‹¤!</p>
            
            <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
            <div class="filters-section">
              <h4>ì¹´í…Œê³ ë¦¬ í•„í„°</h4>
              <div class="filter-buttons" id="filter-buttons">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
              </div>
            </div>

            <!-- ì¢Œìš° ë¶„í•  ë ˆì´ì•„ì›ƒ -->
            <div class="poi-selection-layout">
              <!-- ì¢Œì¸¡: POI ë¦¬ìŠ¤íŠ¸ -->
              <div class="poi-list-container">
                <div class="poi-list-header">
                  <h4>ì¥ì†Œ ëª©ë¡</h4>
                </div>
                <div class="poi-list" id="poi-list">
                  <!-- POI ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
              </div>

              <!-- ìš°ì¸¡: ìƒì„¸ ì •ë³´ íŒ¨ë„ -->
              <div class="poi-detail-container">
                <!-- POI ìƒì„¸ ì •ë³´ -->
                <div class="poi-detail-panel" id="poi-detail-panel">
                  <div class="poi-detail-placeholder">
                    <p>ì¢Œì¸¡ì—ì„œ ì¥ì†Œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- AI ì±„íŒ…ì°½ (ìš°ì¸¡ ê³ ì •) -->
            <div class="ai-chat-container" id="ai-chat-container">
              <div class="ai-chat-header">
                <h3>ğŸ¤– AI ì¥ì†Œ ì¶”ì²œ</h3>
                <button class="ai-chat-toggle" id="ai-chat-toggle" aria-label="ì±„íŒ…ì°½ ì ‘ê¸°/í¼ì¹˜ê¸°">ì ‘ê¸°</button>
              </div>
              <div class="ai-chat-messages" id="ai-chat-messages">
                <div class="ai-message ai-message--system">
                  <p>ì•ˆë…•í•˜ì„¸ìš”! ì°¾ê³  ì‹¶ì€ ì¥ì†Œë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”.</p>
                  <p class="ai-examples">ì˜ˆ: "íŠ€ê¹€ ìš”ë¦¬ ì‹ë‹¹", "ì‰´ ìˆ˜ ìˆëŠ” ê³³", "ë©´ì„¸ì " ë“±</p>
                </div>
              </div>
              <div class="ai-chat-input-container">
                <input 
                  type="text" 
                  class="ai-chat-input" 
                  id="ai-chat-input" 
                  placeholder="ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”..."
                  aria-label="AI ì¥ì†Œ ê²€ìƒ‰ ì…ë ¥"
                />
                <button class="ai-chat-send" id="ai-chat-send" aria-label="ê²€ìƒ‰ ì „ì†¡">ì „ì†¡</button>
              </div>
            </div>

            <!-- ì„ íƒëœ POI ëª©ë¡ (í™”ë©´ í•˜ë‹¨) -->
            <div class="selected-pois-summary-bottom">
              <h4>ì„ íƒí•œ ì¥ì†Œ</h4>
              <div class="selected-list" id="selected-list">
                <p class="empty-message">ì•„ì§ ì„ íƒí•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--primary" onclick="nextToCityPreferences()" id="preferences-poi-next">
              ë„ì‹œ íƒë°©ìœ¼ë¡œ
            </button>
          </div>
        </div>
      </section>

      <!-- Step 3.3: City Preferences -->
      <section class="city-preferences-step" id="city-preferences-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">ë„ì‹œì—ì„œ ì–´ë–¤ ê²ƒì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš”?</h2>
          <p class="step-description">
            ë„ì‹œ íƒë°©ì—ì„œ ê´€ì‹¬ ìˆëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.<br>
            ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ë„ì‹œ ë‚´ ì¥ì†Œë“¤ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤. (ìµœëŒ€ 3ê°œ)
          </p>

          <div class="preference-cards">
            <button class="preference-card" data-category="food">
              <div class="preference-icon">ğŸ½ï¸</div>
              <h3>ë¯¸ì‹ & ë¡œì»¬ ë§›ì§‘</h3>
              <p>í˜„ì§€ ë§›ì§‘ê³¼ íŠ¹ìƒ‰ ìˆëŠ” ìŒì‹</p>
            </button>
            <button class="preference-card" data-category="shopping">
              <div class="preference-icon">ğŸ›ï¸</div>
              <h3>ì‡¼í•‘ & ê¸°ë…í’ˆ</h3>
              <p>í˜„ì§€ ìƒí’ˆê³¼ ê¸°ë…í’ˆ ì‡¼í•‘</p>
            </button>
            <button class="preference-card" data-category="culture">
              <div class="preference-icon">ğŸ›ï¸</div>
              <h3>ë¬¸í™” & ì—­ì‚¬</h3>
              <p>ë°•ë¬¼ê´€, ì—­ì‚¬ì  ì¥ì†Œ</p>
            </button>
            <button class="preference-card" data-category="nature">
              <div class="preference-icon">ğŸŒ¿</div>
              <h3>ìì—° & ì •ì›</h3>
              <p>ê³µì›, ì •ì›, ìì—° ê²½ê´€</p>
            </button>
            <button class="preference-card is-disabled" data-category="view" disabled aria-disabled="true" title="í˜„ì¬ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤">
              <div class="preference-icon">ğŸŒ†</div>
              <h3>ì „ë§ & ì•¼ê²½</h3>
              <p>ì „ë§ëŒ€, ì•¼ê²½ ëª…ì†Œ</p>
            </button>
          </div>

          <!-- ê¸°ë³¸ ì²´ë¥˜ ì‹œê°„ ì„¤ì • -->
          <div class="stay-time-section" style="margin-top: 2rem;">
            <h4 style="margin-bottom: 1rem; color: var(--color-text);">ì¥ì†Œë³„ ê¸°ë³¸ ì²´ë¥˜ ì‹œê°„</h4>
            <div class="stay-time-input" style="display: flex; align-items: center; gap: 1rem;">
              <div class="stay-time-slider" style="flex: 1;">
                <input id="city-default-stay" type="range" min="20" max="240" step="5" value="60" class="stay-slider" style="width: 100%;" />
                <div class="stay-time-labels" style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                  <span style="font-size: 0.875rem; color: var(--color-text-secondary);">20ë¶„</span>
                  <span style="font-size: 0.875rem; color: var(--color-text-secondary);">240ë¶„</span>
                </div>
              </div>
              <div class="stay-time-display" style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="number" id="city-stay-number" min="20" max="240" step="5" value="60" style="width: 80px; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 4px;" />
                <span style="color: var(--color-text-secondary);">ë¶„</span>
              </div>
            </div>
            <small style="display: block; margin-top: 0.5rem; color: var(--color-text-muted); font-size: 0.875rem;">ê° ì¥ì†Œì—ì„œ ë³´ë‚¼ ì˜ˆìƒ ì‹œê°„ì…ë‹ˆë‹¤</small>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToAirportPOISelection()">
              ì´ì „
            </button>
            <button class="btn btn--primary" onclick="nextToCityPOISelection()" id="city-preferences-next">
              ë‹¤ìŒ ë‹¨ê³„ë¡œ
            </button>
          </div>
        </div>
      </section>

      <!-- Step 3.4: City POI Selection -->
      <section class="city-poi-selection-step" id="city-poi-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">ë„ì‹œì—ì„œ ë°©ë¬¸í•  ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
          <p class="open-only-hint">í™˜ìŠ¹ ì‹œê°„ ë™ì•ˆ ìš´ì˜ ì¤‘ì¸ ê³³ë§Œ í‘œì‹œë©ë‹ˆë‹¤!</p>
          <p class="step-description">
            ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì˜ ì¶”ì²œ ì¥ì†Œë“¤ì„ í™•ì¸í•˜ê³ <br>
            ë„ì‹œì—ì„œ ë°©ë¬¸í•˜ê³  ì‹¶ì€ ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
          </p>

          <div class="poi-selection-content">
            <div class="filters-section">
              <h3>ì¹´í…Œê³ ë¦¬ í•„í„°</h3>
              <div class="filter-buttons" id="city-filter-buttons">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
              </div>
            </div>

            <div class="poi-grid" id="city-poi-grid">
              <!-- POI ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>

            <div class="selected-pois">
              <h3>ì„ íƒí•œ ë„ì‹œ ì¥ì†Œ</h3>
              <div class="selected-list" id="city-selected-list">
                <p class="empty-message">ì•„ì§ ì„ íƒí•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToCityPreferences()">
              ì´ì „
            </button>
            <button class="btn btn--primary" onclick="nextToSchedule()" id="city-poi-next" disabled>
              ì¼ì • ë§Œë“¤ê¸°
            </button>
          </div>
        </div>
      </section>

      <!-- Step 3.2: Airport Schedule Summary -->
      <section class="schedule-step" id="airport-schedule-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">ê³µí•­ ë‚´ë¶€ ì¼ì • ì™„ì„±!</h2>
          <p class="step-description">
            ì„ íƒí•œ ì¥ì†Œë“¤ë¡œ ìµœì ì˜ ì¼ì •ì„ ë§Œë“¤ì–´ë“œë ¸ìŠµë‹ˆë‹¤.<br>
            ì¼ì •ì„ í™•ì¸í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.
          </p>

          <!-- ê³µí•­ íŒ ì„¹ì…˜ (ìƒë‹¨) -->
          <div class="tips-section">
            <div class="tips-header">
              <h3>ğŸ’¡ ê³µí•­ íŒ</h3>
              <button class="btn btn--ai-tips" id="generate-ai-tips-btn" onclick="generateAITips()">
                ğŸ¤– AI ë§ì¶¤ íŒ ë°›ê¸°
              </button>
            </div>
            <div class="tips-grid" id="tips-grid">
              <div class="tip-card">
                <div class="tip-icon">ğŸ’</div>
                <h4>ì§ ë³´ê´€ì†Œ</h4>
                <p>ê³µí•­ ë‚´ ì§ ë³´ê´€ì†Œë¥¼ ì´ìš©í•˜ë©´ ê°€ë²¼ìš´ ì‡¼í•‘ê³¼ ê´€ê´‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
              </div>
              <div class="tip-card">
                <div class="tip-icon">ğŸ“¶</div>
                <h4>ë¬´ë£Œ ì™€ì´íŒŒì´</h4>
                <p>ê³µí•­ ë‚´ ë¬´ë£Œ ì™€ì´íŒŒì´ë¥¼ ì—°ê²°í•˜ì—¬ ì‹¤ì‹œê°„ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
              </div>
              <div class="tip-card">
                <div class="tip-icon">ğŸ›‚</div>
                <h4>ë³´ì•ˆ ê²€ìƒ‰</h4>
                <p>ì¶œë°œ 2ì‹œê°„ ì „ì—ëŠ” ë³´ì•ˆ ê²€ìƒ‰ëŒ€ê°€ í˜¼ì¡í•  ìˆ˜ ìˆìœ¼ë‹ˆ ë¯¸ë¦¬ ì¤€ë¹„í•˜ì„¸ìš”.</p>
              </div>
            </div>
            
            <!-- AI ìƒì„± íŒ ì»¨í…Œì´ë„ˆ -->
            <div class="ai-tips-container" id="ai-tips-container" style="display: none;">
              <h4 class="ai-tips-title">ğŸ¤– AI ë§ì¶¤ íŒ</h4>
              <div class="ai-tips-grid" id="ai-tips-grid">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
              </div>
            </div>
          </div>

          <!-- ê³µí•­ ë‚´ë¶€ ì¼ì • (í•˜ë‹¨) -->
          <div class="schedule-content">
            <div class="schedule-header">
              <h3>ğŸ“… ê³µí•­ ë‚´ë¶€ ì¼ì •</h3>
            </div>
            <div class="timeline" id="timeline">
              <!-- íƒ€ì„ë¼ì¸ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToPOISelection()">
              ì¥ì†Œ ë‹¤ì‹œ ì„ íƒ
            </button>
            <button class="btn btn--secondary" onclick="saveSchedule()">
              ğŸ’¾ ì¼ì • ì €ì¥
            </button>
            <button class="btn btn--secondary" onclick="shareSchedule()">
              ğŸ“¤ ì¼ì • ê³µìœ 
            </button>
            <button class="btn btn--primary" onclick="goToCityPreferences()">
              ê³µí•­ ì™¸ë¶€ ì¼ì • êµ¬ì„±í•˜ê¸°
            </button>
          </div>
        </div>
      </section>

      <!-- Step 4: Full Schedule Summary -->
      <section class="full-schedule-step" id="full-schedule-step" style="display: none;">
        <div class="step-container">
          <h2 class="step-title">ì „ì²´ ì—¬í–‰ ì¼ì • ì™„ì„±!</h2>
          <p class="step-description">
            ê³µí•­ ë‚´ë¶€ì™€ ë„ì‹œ íƒë°©ì„ í¬í•¨í•œ ìµœì ì˜ ì¼ì •ì„ ë§Œë“¤ì–´ë“œë ¸ìŠµë‹ˆë‹¤.<br>
            ì¼ì •ì„ í™•ì¸í•˜ê³  ì—¬í–‰ì„ ì‹œì‘í•´ë³´ì„¸ìš”.
          </p>

          <div class="schedule-content">
            <div class="schedule-sections">
              <div class="schedule-section">
                <h3>ğŸ¢ ê³µí•­ ë‚´ë¶€ ì¼ì •</h3>
                <div class="timeline" id="airport-timeline">
                  <!-- ê³µí•­ ë‚´ë¶€ íƒ€ì„ë¼ì¸ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
              </div>
              
              <div class="schedule-section">
                <h3>ğŸ™ï¸ ë„ì‹œ íƒë°© ì¼ì •</h3>
                <p class="schedule-note" style="margin-bottom: 1rem; color: var(--color-text-secondary); font-size: 0.875rem;">
                  â° êµ¬ì²´ì ì¸ ì‹œê°„í‘œëŠ” "ì—¬í–‰ ì¼ì • êµ¬ì„±í•˜ê¸°"ë¥¼ ëˆŒëŸ¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="timeline" id="city-timeline">
                  <!-- ë„ì‹œ íƒ€ì„ë¼ì¸ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
              </div>
            </div>

            <div class="tips-section">
              <h3>ğŸ’¡ ì—¬í–‰ íŒ</h3>
              <div class="tips-grid">
                <div class="tip-card">
                  <div class="tip-icon">ğŸš‡</div>
                  <h4>êµí†µí¸</h4>
                  <p>ê³µí•­ì—ì„œ ë„ì‹œê¹Œì§€ì˜ êµí†µí¸ì„ ë¯¸ë¦¬ í™•ì¸í•˜ê³  ì‹œê°„ì„ ê³ ë ¤í•˜ì„¸ìš”.</p>
                </div>
                <div class="tip-card">
                  <div class="tip-icon">ğŸ’</div>
                  <h4>ì§ ë³´ê´€</h4>
                  <p>ê³µí•­ ë‚´ ì§ ë³´ê´€ì†Œë¥¼ ì´ìš©í•˜ë©´ ê°€ë²¼ìš´ ë„ì‹œ íƒë°©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="tip-card">
                  <div class="tip-icon">â°</div>
                  <h4>ì‹œê°„ ê´€ë¦¬</h4>
                  <p>ì¶œë°œ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ì—¬ìœ  ì‹œê°„ì„ í™•ë³´í•˜ì„¸ìš”.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn--ghost" onclick="backToCityPOISelection()">
              ì¥ì†Œ ë‹¤ì‹œ ì„ íƒ
            </button>
            <button class="btn btn--primary" onclick="startNavigation()">
              ì—¬í–‰ ì¼ì • êµ¬ì„±í•˜ê¸°
            </button>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module" src="scripts/router.js"></script>
    <script type="module" src="scripts/userProfile.js"></script>
    <script type="module" src="scripts/auth.js"></script>
    <script type="module" src="scripts/airportPOIService.js"></script>
    <script type="module">
      import { initAuth } from './scripts/auth.js';
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAuth);
      } else {
        initAuth();
      }
    </script>
    <script type="module" src="scripts/cityPOIService.js"></script>
    <script type="module" src="scripts/poiServiceManager.js"></script>
    <script type="module" src="scripts/toast.js"></script>
    <script src="scripts/sqliteClient.js"></script>
    <script src="scripts/aiTipsService.js"></script>
    <script type="module">
      // í•„ìš”í•œ í•¨ìˆ˜ë“¤ì„ import
      import { getPOIInfo } from './scripts/poiManager.js';
      import { getBusinessStatus, getStatusFromBusinessHoursString } from './scripts/businessHours.js';
      import { getOpenAIApiKey } from './scripts/config.js';
      window.getOpenAIApiKey = getOpenAIApiKey;
      
      // ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ windowì— ë…¸ì¶œ
      window.getPOIInfo = getPOIInfo;
      window.getBusinessStatus = getBusinessStatus;
      window.getStatusFromBusinessHoursString = getStatusFromBusinessHoursString;
    </script>
    <script>
      // ì „ì—­ ìƒíƒœ
      let transferInfo = null;
      let selectedTable = null;
      let selectedTypes = [];
      let selectedPOIs = [];
      let allPOIs = [];
      let allPOIsMap = new Map(); // ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ POIë¥¼ ëˆ„ì  ì €ì¥
      let currentStep = 'preferences';
      let expandedGroups = new Set();
      let currentExpandedGroup = null;
      
      // City preferences
      let selectedCityPreferences = [];
      let selectedCityPOIs = [];

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', async function() {
        loadTransferInfo();
        updateSummary();
        initializePreferences();
        
        // AI ì±„íŒ…ì°½ ì´ˆê¸°í™” (POI ë°ì´í„° ë¡œë“œ í›„)
        setTimeout(() => {
          initAIChat();
        }, 500);
        
        // AIë¡œ ìƒì„±ëœ ì¼ì •ì´ ìˆëŠ”ì§€ í™•ì¸
        const aiGenerated = sessionStorage.getItem('aiGeneratedPlan');
        if (aiGenerated === 'true') {
          await loadAIGeneratedPlan();
        }
      });

      // í™˜ìŠ¹ ì •ë³´ ë¡œë“œ
      function loadTransferInfo() {
        const state = window.getAppState();
        if (state.transferInfo) {
          transferInfo = state.transferInfo;
        }
      }

      // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateSummary() {
        if (!transferInfo) return;

        document.getElementById('summary-city').textContent = transferInfo.city;
        document.getElementById('summary-duration').textContent = formatDuration(transferInfo.duration);
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatDuration(durationMs) {
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let result = '';
        if (hours > 0) result += `${hours}ì‹œê°„`;
        if (minutes > 0) result += ` ${minutes}ë¶„`;
        
        return result || '0ë¶„';
      }

      // AI ìƒì„± ì¼ì • ë¡œë“œ
      async function loadAIGeneratedPlan() {
        try {
          const airportPOIDataStr = sessionStorage.getItem('airportPOIData');
          const cityPOIDataStr = sessionStorage.getItem('cityPOIData');
          const aiCategoriesStr = sessionStorage.getItem('aiSelectedCategories');
          
          if (airportPOIDataStr) {
            const airportPOIData = JSON.parse(airportPOIDataStr);
            
            // í…Œì´ë¸” ì„ íƒ
            if (airportPOIData.selectedTable) {
              selectedTable = airportPOIData.selectedTable;
              const card = document.querySelector(`[data-table="${selectedTable}"]`);
              if (card) {
                card.classList.add('selected');
                togglePOISelectionSection();
                
                // POI ì„ íƒ
                if (airportPOIData.selectedPOIs && airportPOIData.allPOIs) {
                  selectedPOIs = airportPOIData.selectedPOIs;
                  allPOIsMap.clear();
                  
                  // allPOIsë¥¼ allPOIsMapì— ì¶”ê°€
                  airportPOIData.allPOIs.forEach(poi => {
                    allPOIsMap.set(poi.id, poi);
                  });
                  
                  // POI ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                  await loadPOIListWithFilter();
                  
                  // ì„ íƒëœ POI í‘œì‹œ
                  selectedPOIs.forEach(poiId => {
                    const poi = allPOIsMap.get(poiId);
                    if (poi) {
                      // POI ì„ íƒ ìƒíƒœ í‘œì‹œ
                      const poiElement = document.querySelector(`[data-poi-id="${poiId}"]`);
                      if (poiElement) {
                        poiElement.classList.add('selected');
                      }
                    }
                  });
                  
                  // ì„ íƒëœ POI ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì œê±° ë²„íŠ¼ í™œì„±í™”)
                  updateSelectedPOIsList();
                  updatePreferencesPOINextButton();
                  
                  // ë„ì‹œ ì¹´í…Œê³ ë¦¬ ì„ íƒ
                  if (cityPOIDataStr && aiCategoriesStr) {
                    const cityPOIData = JSON.parse(cityPOIDataStr);
                    const aiCategories = JSON.parse(aiCategoriesStr);
                    
                    if (aiCategories.city && aiCategories.city.length > 0) {
                      selectedCityPreferences = aiCategories.city;
                      
                      // ë„ì‹œ ì¹´í…Œê³ ë¦¬ ì¹´ë“œ ì„ íƒ í‘œì‹œ
                      selectedCityPreferences.forEach(category => {
                        const card = document.querySelector(`[data-category="${category}"]`);
                        if (card) {
                          card.classList.add('selected');
                        }
                      });
                      
                      // ë„ì‹œ POI ë°ì´í„° ì €ì¥
                      if (cityPOIData.allPOIs) {
                        selectedCityPOIs = cityPOIData.selectedPOIs || [];
                      }
                    }
                  }
                  
                  // ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™ (ê³µí•­ POI ì„ íƒ í›„ ë„ì‹œ íƒë°©ìœ¼ë¡œ)
                  setTimeout(() => {
                    const nextButton = document.getElementById('preferences-poi-next');
                    if (nextButton && selectedPOIs.length > 0) {
                      console.log('âœ… AI ìƒì„± ì¼ì •: ë‹¤ìŒ ë‹¨ê³„ë¡œ ìë™ ì´ë™');
                      nextButton.click();
                    }
                  }, 1500);
                }
              }
            }
          }
          
          // AI ìƒì„± í”Œë˜ê·¸ ì œê±°
          sessionStorage.removeItem('aiGeneratedPlan');
          
          console.log('âœ… AI ìƒì„± ì¼ì • ë¡œë“œ ì™„ë£Œ');
        } catch (error) {
          console.error('AI ìƒì„± ì¼ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }

      // ê³µí•­ ì„ í˜¸ë„ ì´ˆê¸°í™”
      function initializePreferences() {
        const cards = document.querySelectorAll('#preferences-poi-step .preference-card');
        cards.forEach(card => {
          card.addEventListener('click', function() {
            toggleTableSelection(this.dataset.table);
          });
        });
      }

      // í…Œì´ë¸” ì„ íƒ í† ê¸€
      function toggleTableSelection(tableName) {
        const card = document.querySelector(`[data-table="${tableName}"]`);
        
        if (selectedTable === tableName) {
          selectedTable = null;
          selectedTypes = [];
          card.classList.remove('selected');
        } else {
          selectedTable = tableName;
          selectedTypes = [];
          document.querySelectorAll('.preference-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
        }
        
        togglePOISelectionSection();
        updatePreferencesPOINextButton();
      }

      function updatePreferencesPOINextButton() {
        const nextButton = document.getElementById('preferences-poi-next');
        const hasTable = selectedTable !== null;
        const hasSelectedPOIs = selectedPOIs.length > 0;
        
        // disabled ëŒ€ì‹  CSS í´ë˜ìŠ¤ë¡œë§Œ ìŠ¤íƒ€ì¼ ë³€ê²½
        if (!hasTable || !hasSelectedPOIs) {
          nextButton.style.opacity = '0.5';
          nextButton.style.cursor = 'not-allowed';
        } else {
          nextButton.style.opacity = '1';
          nextButton.style.cursor = 'pointer';
        }
      }

      function togglePOISelectionSection() {
        const poiSection = document.getElementById('poi-selection-section');
        if (selectedTable !== null) {
          poiSection.style.display = 'block';
          initializePOISelection();
        } else {
          poiSection.style.display = 'none';
        }
      }

      function initializePOISelection() {
        generateFilterButtons();
        generatePOIList();
        updatePOINextButton();
      }

      function generateFilterButtons() {
        const container = document.getElementById('filter-buttons');
        if (!container) return;
        
        container.innerHTML = '';
        
        const allButton = document.createElement('button');
        allButton.className = 'filter-btn active';
        allButton.textContent = 'ì „ì²´';
        allButton.dataset.type = 'all';
        allButton.onclick = () => filterPOIs('all');
        container.appendChild(allButton);
        
        if (selectedTable) {
          getTableTypes(selectedTable).then(types => {
            types.forEach(type => {
              const existingButton = container.querySelector(`[data-type="${type}"]`);
              if (!existingButton) {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.textContent = getTypeLabel(type);
                button.dataset.type = type;
                button.onclick = () => filterPOIs(type);
                container.appendChild(button);
              }
            });
          });
        }
      }

      async function getTableTypes(tableName) {
        try {
          await window.sqliteClient.initialize();
          const types = await window.sqliteClient.getTableTypes(tableName);
          return types;
        } catch (error) {
          console.error('í…Œì´ë¸” íƒ€ì… ì¡°íšŒ ì‹¤íŒ¨:', error);
          return [];
        }
      }

      function getTypeLabel(type) {
        const labels = {
          'Lounge': 'ë¼ìš´ì§€', 'Rest': 'íœ´ì‹ê³µê°„', 'Hotel': 'í˜¸í…”',
          'Meal': 'ì‹ë‹¹', 'Cafe': 'ì¹´í˜', 'Dessert': 'ë””ì €íŠ¸',
          'Fashion': 'íŒ¨ì…˜', 'Beauty': 'ë·°í‹°', 'Beverage': 'ìŒë£Œ',
          'Snack': 'ìŠ¤ë‚µ', 'Duty_free': 'ë©´ì„¸ì ',
          'Attraction': 'ê´€ê´‘ëª…ì†Œ', 'Entertainment': 'ì—”í„°í…Œì¸ë¨¼íŠ¸'
        };
        return labels[type] || type;
      }

      async function generatePOIList() {
        selectedTypes = [];
        await loadPOIListWithFilter();
      }

      async function loadPOIListWithFilter(categoryFilter = null) {
        if (!selectedTable) return;
        
        try {
          console.log(`SQLite ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ${selectedTable} í…Œì´ë¸” POI ë°ì´í„° ë¡œë“œ ì‹œì‘... (í•„í„°: ${categoryFilter || 'ì „ì²´'})`);
          
          await window.sqliteClient.initialize();
          const pois = await window.sqliteClient.getTablePOIs(selectedTable, categoryFilter);
          
          // ìƒˆë¡œ ë¡œë“œëœ POIë¥¼ allPOIsMapì— ì¶”ê°€ (ê¸°ì¡´ í•­ëª©ì€ ì—…ë°ì´íŠ¸, ìƒˆ í•­ëª©ì€ ì¶”ê°€)
          pois.forEach(poi => {
            // ì„ íƒëœ POIëŠ” ë®ì–´ì“°ì§€ ì•Šê¸° (ì•ˆì „ì¥ì¹˜)
            if (selectedPOIs.includes(poi.id) && allPOIsMap.has(poi.id)) {
              const existingPoi = allPOIsMap.get(poi.id);
              // ê¸°ì¡´ POI ì •ë³´ ìœ ì§€ (ì´ë¦„ì´ ë‹¤ë¥´ë©´ ê²½ê³  ë¡œê·¸)
              if (existingPoi.name !== poi.name) {
                console.warn(`âš ï¸ ì„ íƒëœ POI ë®ì–´ì“°ê¸° ë°©ì§€: ${poi.id}`, {
                  existing: existingPoi.name,
                  new: poi.name,
                  message: 'ê¸°ì¡´ POI ì •ë³´ê°€ ìœ ì§€ë©ë‹ˆë‹¤.'
                });
              }
              return; // ê±´ë„ˆë›°ê¸°
            }
            // ê°™ì€ IDê°€ ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
            allPOIsMap.set(poi.id, poi);
          });
          
          // ë°©ë¬¸ ì‹œê°„ ê¸°ì¤€ ê³„ì‚° (ê³µí•­ ë‚´ë¶€ íƒë°© ì‹œì‘ ì‹œê°„ ê°€ì •)
          let visitStart = null;
          try {
            if (transferInfo?.arrival) {
              visitStart = new Date(transferInfo.arrival);
            } else {
              visitStart = new Date();
            }
          } catch (_) {
            visitStart = new Date();
          }

          // ìš´ì˜ ìƒíƒœ í•„í„°ë§: OPENì¸ í•­ëª©ë§Œ ìœ ì§€ (UNKNOWN/CLOSED ì œì™¸)
          const filtered = pois.filter(poi => {
            const stay = Number(poi.estimatedTime || 30);
            const status = window.getStatusFromBusinessHoursString?.(poi.businessHours, visitStart, stay, 'Asia/Singapore') || 'UNKNOWN';
            poi.airportBusinessStatus = status;
            return status === 'OPEN';
          });

          // allPOIs ì—…ë°ì´íŠ¸ (í˜„ì¬ í•„í„° + ìš´ì˜ ìƒíƒœ ë°˜ì˜)
          allPOIs = filtered;
          const groupedPOIs = groupDuplicatePOIs(filtered);
          
          renderPOIList(groupedPOIs);
          console.log(`SQLite ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ POI ë¡œë“œ ì™„ë£Œ: ${pois.length}ê°œ ë°œê²¬ (${groupedPOIs.length}ê°œ ê·¸ë£¹)`);
        } catch (error) {
          console.error('SQLite ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }

      function groupDuplicatePOIs(pois) {
        const grouped = {};
        pois.forEach(poi => {
          const key = poi.name;
          if (!grouped[key]) {
            grouped[key] = {
              name: poi.name,
              category: poi.category,
              categoryIcon: poi.categoryIcon,
              items: []
            };
          }
          grouped[key].items.push(poi);
        });
        return Object.values(grouped);
      }

      function renderPOIList(groupedPOIs) {
        const container = document.getElementById('poi-list');
        container.innerHTML = '';
        
        groupedPOIs.forEach((group, index) => {
          const item = createPOIListItem(group, index);
          container.appendChild(item);
        });
      }

      function createPOIListItem(group, index) {
        const wrapper = document.createElement('div');
        wrapper.className = 'poi-list-item';
        wrapper.dataset.poiGroup = index;
        
        const count = group.items.length;
        const isMultiple = count > 1;
        
        const firstItem = group.items[0];
        const shortDescription = firstItem.description ? 
          (firstItem.description.length > 50 ? firstItem.description.substring(0, 50) + '...' : firstItem.description) : 
          firstItem.location || '';
        
        // ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸° (ì²« ë²ˆì§¸ í•­ëª©ì˜ ì´ë¯¸ì§€ ì‚¬ìš©)
        const imageUrl = firstItem.imageUrl || '';
        const imageHtml = imageUrl ? 
          `<div class="poi-list-item-image">
            <img src="${imageUrl}" alt="${group.name}" onerror="this.style.display='none'; this.parentElement.style.display='none';">
          </div>` : 
          '<div class="poi-list-item-image placeholder"><span>ğŸ“·</span></div>';
        
        wrapper.innerHTML = `
          <div class="poi-list-item-main" data-group-index="${index}">
            ${imageHtml}
            <div class="poi-list-item-content">
              <div class="poi-list-item-header">
                <h5>${group.name}${isMultiple ? ` (${count}ê³³)` : ''}</h5>
              </div>
              <p class="poi-list-item-description">${shortDescription}</p>
              ${isMultiple ? '<div class="poi-list-item-arrow">â–¼</div>' : ''}
            </div>
          </div>
        `;
        
        const mainElement = wrapper.querySelector('.poi-list-item-main');
        mainElement.addEventListener('click', (e) => {
          e.stopPropagation();
          selectPOIItem(group, index);
        });
        
        if (isMultiple) {
          const subContainer = document.createElement('div');
          subContainer.className = 'poi-list-subitems';
          subContainer.style.display = 'none';
          subContainer.id = `subitems-${index}`;
          wrapper.appendChild(subContainer);
        }
        
        return wrapper;
      }

      function selectPOIItem(group, index) {
        const count = group.items.length;
        if (count > 1) {
          toggleGroupExpanded(group, index);
        } else {
          showPOIDetailSingle(group.items[0]);
        }
      }

      function toggleGroupExpanded(group, index) {
        const subContainer = document.getElementById(`subitems-${index}`);
        const arrow = document.querySelector(`[data-group-index="${index}"] .poi-list-item-arrow`);
        
        if (!subContainer || !arrow) {
          console.error('toggleGroupExpanded: ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', { index, subContainer, arrow });
          return;
        }
        
        if (expandedGroups.has(index)) {
          expandedGroups.delete(index);
          subContainer.style.display = 'none';
          arrow.textContent = 'â–¼';
          const panel = document.getElementById('poi-detail-panel');
          if (panel) {
            panel.innerHTML = '<div class="poi-detail-placeholder"><p>ì¢Œì¸¡ì—ì„œ ì¥ì†Œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p></div>';
          }
          currentExpandedGroup = null;
        } else {
          expandedGroups.add(index);
          subContainer.style.display = 'block';
          arrow.textContent = 'â–²';
          subContainer.innerHTML = '';
          
          // group.itemsì˜ ê° itemì— ëŒ€í•´ ìµœì‹  ì •ë³´ ì¡°íšŒ
          group.items.forEach((item, idx) => {
            // allPOIsMapì—ì„œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const latestItem = allPOIsMap.get(item.id) || item;
            const subItem = createSubItem(group.name, latestItem, idx);
            subContainer.appendChild(subItem);
          });
        }
      }

      function createSubItem(groupName, item, idx) {
        const subItem = document.createElement('div');
        subItem.className = 'poi-list-subitem';
        
        // í´ë¡œì € ë¬¸ì œ ë°©ì§€: item.idë¥¼ ë³€ìˆ˜ë¡œ ì €ì¥
        const itemId = item.id;
        
        subItem.innerHTML = `
          <div class="poi-list-subitem-header">
            <h6>ğŸ“ ${item.location || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}</h6>
            ${item.businessHours ? `<p class="poi-list-subitem-hours">ğŸ• ${item.businessHours}</p>` : ''}
          </div>
        `;
        
        subItem.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // itemIdë¥¼ í†µí•´ allPOIsMapì—ì„œ ìµœì‹  POI ì •ë³´ ì¡°íšŒ
          const actualItem = allPOIsMap.get(itemId) || allPOIs.find(p => p.id === itemId);
          if (actualItem) {
            showPOIDetailSingle(actualItem);
          } else {
            console.error('createSubItem: POIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', itemId);
            showToast({ message: 'ì¥ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', type: 'error' });
          }
        });
        
        return subItem;
      }

      function showPOIDetailSingle(poi) {
        // POI ìœ íš¨ì„± ê²€ì¦
        if (!poi || !poi.id) {
          console.error('showPOIDetailSingle: Invalid POI object:', poi);
          const panel = document.getElementById('poi-detail-panel');
          if (panel) {
            panel.innerHTML = '<div class="poi-detail-placeholder"><p>ì¥ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
          }
          return;
        }
        
        // POI ê°ì²´ë¥¼ allPOIsMapì— ì¶”ê°€/ì—…ë°ì´íŠ¸ (AI ì¶”ì²œ POIê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì—ì„œ ë¡œë“œëœ ê²½ìš° ëŒ€ë¹„)
        if (poi.id) {
          allPOIsMap.set(poi.id, poi);
        }
        
        const panel = document.getElementById('poi-detail-panel');
        if (!panel) {
          console.error('showPOIDetailSingle: poi-detail-panel ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // poi.idë¥¼ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„
        const safeId = String(poi.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        panel.innerHTML = `
          ${poi.imageUrl ? `<img src="${poi.imageUrl}" alt="${poi.name}" class="poi-detail-image" onerror="this.style.display='none'">` : ''}
          <div class="poi-detail-header">
            <h3>${poi.name}</h3>
          </div>
          <div class="poi-detail-content">
            ${poi.description ? `<p class="poi-detail-description">${poi.description}</p>` : ''}
            ${poi.location ? `<p class="poi-detail-location">ğŸ“ ${poi.location}</p>` : ''}
            ${poi.businessHours ? `<p class="poi-detail-hours">ğŸ• ${poi.businessHours}</p>` : ''}
            ${poi.phoneNumber ? `<p class="poi-detail-phone">ğŸ“ ${poi.phoneNumber}</p>` : ''}
            ${poi.website ? `<p class="poi-detail-website">ğŸŒ <a href="${poi.website}" target="_blank">${poi.website}</a></p>` : ''}
            ${poi.cost ? `<p class="poi-detail-cost">ğŸ’° ${poi.cost}</p>` : ''}
          </div>
          <div class="poi-detail-actions">
            <div class="time-input-section">
              <label class="time-label">ì˜ˆìƒ ì†Œìš”ì‹œê°„:</label>
              <input type="number" class="time-input" data-poi-id="${safeId}" value="${poi.estimatedTime || 5}" min="1" max="300">
              <span class="time-unit">ë¶„</span>
            </div>
            <button class="btn btn--primary" data-poi-id="${safeId}">
              ì„ íƒ
            </button>
          </div>
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (onclick ëŒ€ì‹ )
        const selectButton = panel.querySelector('.btn--primary[data-poi-id]');
        const timeInput = panel.querySelector('.time-input[data-poi-id]');
        
        if (selectButton) {
          // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œ ìƒì„±
          const poiId = poi.id; // í´ë¡œì €ë¡œ í¬ì°©
          selectButton.addEventListener('click', function selectButtonHandler() {
            // ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ì‹¤í–‰
            selectButton.removeEventListener('click', selectButtonHandler);
            // POIê°€ allPOIsMapì— ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ì¶”ê°€
            if (!allPOIsMap.has(poiId)) {
              allPOIsMap.set(poiId, poi);
              console.log('âœ… [POI Detail] POIë¥¼ allPOIsMapì— ì¶”ê°€:', { id: poiId, name: poi.name });
            }
            selectPOISingle(poiId);
          });
        }
        
        if (timeInput) {
          const poiId = poi.id; // í´ë¡œì €ë¡œ í¬ì°©
          timeInput.addEventListener('change', function timeInputHandler(e) {
            updatePOITimeForItem(poiId, e.target.value);
          });
        }
      }

      function selectPOISingle(poiId) {
        // poiId ê²€ì¦
        if (!poiId) {
          console.error('selectPOISingle: poiId is missing');
          showToast({ message: 'ì¥ì†Œë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', type: 'error' });
          return;
        }
        
        // allPOIsMapì—ì„œ ë¨¼ì € ì°¾ê¸° (ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ POIê°€ ì €ì¥ë˜ì–´ ìˆìŒ)
        let poi = allPOIsMap.get(poiId);
        
        // ì—†ìœ¼ë©´ allPOIsì—ì„œ ì°¾ê¸°
        if (!poi) {
          poi = allPOIs.find(p => p.id === poiId);
        }
        
        // ì—¬ì „íˆ ì—†ìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
        if (!poi) {
          console.error('selectPOISingle: POI not found', {
            poiId,
            allPOIsMapSize: allPOIsMap.size,
            allPOIsLength: allPOIs.length,
            selectedTable,
            allPOIsIds: Array.from(allPOIsMap.keys()).slice(0, 10) // ì²˜ìŒ 10ê°œë§Œ ë¡œê·¸
          });
          showToast({ message: 'ì„ íƒí•œ ì¥ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', type: 'error' });
          return;
        }
        
        // ì¤‘ë³µ ì„ íƒ í™•ì¸
        if (selectedPOIs.includes(poiId)) {
          showToast({ message: `ì´ë¯¸ ì„ íƒí•œ ì¥ì†Œì…ë‹ˆë‹¤: ${poi.name}`, type: 'warning' });
          return;
        }
        
        // ì„ íƒëœ POIì— ì¶”ê°€
        selectedPOIs.push(poiId);
        updateSelectedPOIsList();
        updatePOINextButton();
        
        // ì„±ê³µ ë©”ì‹œì§€
        showToast({ message: `${poi.name}ì´(ê°€) ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, type: 'success' });
        
        // ë””ë²„ê¹… ë¡œê·¸
        console.log('POI ì„ íƒë¨:', {
          poiId,
          poiName: poi.name,
          selectedCount: selectedPOIs.length,
          allSelectedIds: selectedPOIs
        });
      }

      function updatePOITimeForItem(poiId, time) {
        const timeValue = parseInt(time);
        if (isNaN(timeValue) || timeValue < 1 || timeValue > 300) {
          const input = document.querySelector('.poi-detail-actions .time-input');
          if (input) input.value = 10;
          return;
        }
        
        // allPOIsMapì—ì„œ ë¨¼ì € ì°¾ê¸° (ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ POIê°€ ì €ì¥ë˜ì–´ ìˆìŒ)
        let poi = allPOIsMap.get(poiId);
        if (!poi) {
          poi = allPOIs.find(p => p.id === poiId);
        }
        
        if (poi) {
          poi.estimatedTime = timeValue;
          // allPOIsMapì—ë„ ì—…ë°ì´íŠ¸
          allPOIsMap.set(poiId, poi);
        } else {
          console.warn('updatePOITimeForItem: POIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', poiId);
        }
        
        updateSelectedPOIsList();
      }

      function togglePOI(poiId) {
        // poiId ê²€ì¦
        if (!poiId) {
          console.error('togglePOI: poiId is missing');
          return;
        }
        
        // allPOIsMapì—ì„œ ë¨¼ì € ì°¾ê¸° (ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ POIê°€ ì €ì¥ë˜ì–´ ìˆìŒ)
        let poi = allPOIsMap.get(poiId);
        if (!poi) {
          poi = allPOIs.find(p => p.id === poiId);
        }
        if (!poi) {
          console.warn('togglePOI: POIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', poiId);
          return;
        }
        
        selectedPOIs = selectedPOIs.filter(id => id !== poiId);
        updateSelectedPOIsList();
        updatePOINextButton();
        
        // ì œê±° ë©”ì‹œì§€ ì¶”ê°€
        showToast({ message: `${poi.name}ì´(ê°€) ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`, type: 'info' });
      }

      function updateSelectedPOIsList() {
        const container = document.getElementById('selected-list');
        if (!container) {
          console.warn('updateSelectedPOIsList: selected-list ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        if (selectedPOIs.length === 0) {
          container.innerHTML = '<p class="empty-message">ì•„ì§ ì„ íƒí•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = selectedPOIs.map(poiId => {
          // allPOIsMapì—ì„œ ë¨¼ì € ì°¾ê¸° (ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ POIê°€ ì €ì¥ë˜ì–´ ìˆìŒ)
          let poi = allPOIsMap.get(poiId);
          
          // ì—†ìœ¼ë©´ allPOIsì—ì„œ ì°¾ê¸°
          if (!poi) {
            poi = allPOIs.find(p => p.id === poiId);
          }
          
          if (!poi) {
            console.warn(`updateSelectedPOIsList: POIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${poiId}`, {
              selectedPOIs,
              allPOIsMapSize: allPOIsMap.size,
              allPOIsLength: allPOIs.length,
              sampleMapKeys: Array.from(allPOIsMap.keys()).slice(0, 5)
            });
            return '';
          }
          
          // poiIdë¥¼ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„
          const safeId = String(poiId).replace(/'/g, "\\'").replace(/"/g, '&quot;');
          
          return `
            <div class="selected-poi-item" data-selected-poi-id="${safeId}">
              <div class="poi-info">
                <h5>${poi.name}</h5>
              </div>
              <div class="poi-time">
                <span class="time-label">ì†Œìš”ì‹œê°„:</span>
                <span class="time-value">${poi.estimatedTime || 10}ë¶„</span>
              </div>
              <button class="btn btn--small btn--ghost" data-remove-poi-id="${safeId}">ì œê±°</button>
            </div>
          `;
        }).filter(html => html).join('');
        
        // ì œê±° ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (onclick ëŒ€ì‹ )
        container.querySelectorAll('[data-remove-poi-id]').forEach(button => {
          const poiId = button.getAttribute('data-remove-poi-id');
          // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œ ìƒì„±
          const newButton = button.cloneNode(true);
          button.parentNode.replaceChild(newButton, button);
          
          // ìƒˆ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          newButton.addEventListener('click', () => {
            togglePOI(poiId);
          });
        });
      }

      function updatePOINextButton() {
        // updatePreferencesPOINextButtonìœ¼ë¡œ í†µí•©ë¨ (ë™ì¼í•œ ë²„íŠ¼ ì œì–´)
        updatePreferencesPOINextButton(); // ì‹¤ì œë¡œ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
      }

      function filterPOIs(type) {
        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
          if (btn.dataset.type === type) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        loadPOIListWithFilter(type === 'all' ? null : type);
      }

      // ë„ì‹œ ì„ í˜¸ë„ ì´ˆê¸°í™”
      function initializeCityPreferences() {
        const cards = document.querySelectorAll('#city-preferences-step .preference-card');
        cards.forEach(card => {
          card.addEventListener('click', function() {
            toggleCityPreference(this.dataset.category);
          });
        });

        // ì²´ë¥˜ ì‹œê°„ ìŠ¬ë¼ì´ë”ì™€ ìˆ«ì ì…ë ¥ ë™ê¸°í™”
        const slider = document.getElementById('city-default-stay');
        const numberInput = document.getElementById('city-stay-number');
        
        if (slider && numberInput) {
          // ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì‹œ ìˆ«ì ì…ë ¥ ì—…ë°ì´íŠ¸
          slider.addEventListener('input', function() {
            numberInput.value = this.value;
          });
          
          // ìˆ«ì ì…ë ¥ ê°’ ë³€ê²½ ì‹œ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
          numberInput.addEventListener('input', function() {
            let value = parseInt(this.value);
            if (value < 20) value = 20;
            if (value > 240) value = 240;
            this.value = value;
            slider.value = value;
          });
        }
      }

      // ê³µí•­ ì„ í˜¸ë„ í† ê¸€
      function togglePreference(category) {
        const card = document.querySelector(`#preferences-step [data-category="${category}"]`);
        
        if (selectedAirportPreferences.includes(category)) {
          selectedAirportPreferences = selectedAirportPreferences.filter(p => p !== category);
          card.classList.remove('selected');
        } else {
          selectedAirportPreferences.push(category);
          card.classList.add('selected');
        }
        
        updateAirportPreferencesNextButton();
      }

      // ê³µí•­ ì„ í˜¸ë„ ë‹¤ìŒ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      function updateAirportPreferencesNextButton() {
        const nextButton = document.getElementById('preferences-next');
        nextButton.disabled = selectedAirportPreferences.length === 0;
      }

      // ê³µí•­ POI ì„ íƒ ë‹¨ê³„ë¡œ ì´ë™
      function nextToAirportPOISelection() {
        if (selectedAirportPreferences.length === 0) return;
        
        currentStep = 'airport-poi-selection';
        document.getElementById('preferences-step').style.display = 'none';
        document.getElementById('airport-poi-step').style.display = 'block';
        
        initializeAirportPOISelection();
      }

      // ê³µí•­ POI ì„ íƒ ì´ˆê¸°í™”
      function initializeAirportPOISelection() {
        generateAirportFilterButtons();
        generateAirportPOICards();
        updateAirportPOINextButton();
      }

      // ê³µí•­ í•„í„° ë²„íŠ¼ ìƒì„±
      function generateAirportFilterButtons() {
        const container = document.getElementById('airport-filter-buttons');
        container.innerHTML = '';
        
        const allButton = document.createElement('button');
        allButton.className = 'filter-btn active';
        allButton.textContent = 'ì „ì²´';
        allButton.onclick = () => filterAirportPOIs('all');
        container.appendChild(allButton);
        
        selectedAirportPreferences.forEach(category => {
          const button = document.createElement('button');
          button.className = 'filter-btn';
          button.textContent = getCategoryLabel(category);
          button.onclick = () => filterAirportPOIs(category);
          container.appendChild(button);
        });
      }

      // ê³µí•­ POI ì¹´ë“œ ìƒì„± (ì„ì‹œ ë°ì´í„°)
      function generateAirportPOICards() {
        const container = document.getElementById('airport-poi-grid');
        container.innerHTML = '';
        
        // ì„ì‹œ ê³µí•­ POI ë°ì´í„°
        const sampleAirportPOIs = [
          { id: 1, name: 'ë©´ì„¸ì  A', category: 'shopping', description: 'ë¸Œëœë“œ ë©´ì„¸ì ', estimatedTime: 60 },
          { id: 2, name: 'ê³µí•­ ì¹´í˜', category: 'food', description: 'ë¡œì»¬ ì»¤í”¼ ì „ë¬¸ì ', estimatedTime: 30 },
          { id: 3, name: 'ë¬¸í™” ì „ì‹œê´€', category: 'culture', description: 'í•œêµ­ ì „í†µ ë¬¸í™” ì²´í—˜', estimatedTime: 45 },
          { id: 4, name: 'ìŠ¤íŒŒ & ë§ˆì‚¬ì§€', category: 'relax', description: 'ê³µí•­ ë‚´ íœ´ì‹ ê³µê°„', estimatedTime: 90 },
          { id: 5, name: 'ê²Œì„ì¡´', category: 'entertainment', description: 'VR ê²Œì„ ì²´í—˜', estimatedTime: 30 },
          { id: 6, name: 'ì€í–‰ ATM', category: 'services', description: 'í™˜ì „ ë° í˜„ê¸ˆ ì¸ì¶œ', estimatedTime: 15 }
        ];
        
        sampleAirportPOIs.forEach(poi => {
          if (selectedAirportPreferences.includes(poi.category) || selectedAirportPreferences.length === 0) {
            const card = createAirportPOICard(poi);
            container.appendChild(card);
          }
        });
      }

      // ê³µí•­ POI ì¹´ë“œ ìƒì„±
      function createAirportPOICard(poi) {
        const card = document.createElement('div');
        card.className = 'poi-card';
        card.dataset.poiId = poi.id;
        card.dataset.category = poi.category;
        
        card.innerHTML = `
          <div class="poi-header">
            <h4>${poi.name}</h4>
            <span class="poi-category">${getCategoryLabel(poi.category)}</span>
          </div>
          <p class="poi-description">${poi.description}</p>
          <div class="poi-footer">
            <span class="estimated-time">ì˜ˆìƒ ì†Œìš”ì‹œê°„: ${poi.estimatedTime}ë¶„</span>
            <button class="btn btn--small" onclick="toggleAirportPOI(${poi.id})">ì„ íƒ</button>
          </div>
        `;
        
        return card;
      }

      // ê³µí•­ POI í† ê¸€
      function toggleAirportPOI(poiId) {
        const card = document.querySelector(`#airport-poi-grid [data-poi-id="${poiId}"]`);
        const button = card.querySelector('button');
        
        if (selectedPOIs.includes(poiId)) {
          selectedPOIs = selectedPOIs.filter(id => id !== poiId);
          card.classList.remove('selected');
          button.textContent = 'ì„ íƒ';
        } else {
          selectedPOIs.push(poiId);
          card.classList.add('selected');
          button.textContent = 'ì„ íƒë¨';
        }
        
        updateSelectedPOIsList();
        updatePOINextButton();
      }

      // ì„ íƒëœ ê³µí•­ POI ëª©ë¡ ì—…ë°ì´íŠ¸ (deprecated, using updateSelectedPOIsList)
      function updateAirportSelectedPOIsList() {
        updateSelectedPOIsList();
      }
      
      function updateAirportSelectedPOIsList2() {
        const container = document.getElementById('airport-selected-list');
        
        if (selectedPOIs.length === 0) {
          container.innerHTML = '<p class="empty-message">ì•„ì§ ì„ íƒí•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = selectedPOIs.map(poiId => {
          const card = document.querySelector(`#airport-poi-grid [data-poi-id="${poiId}"]`);
          const name = card.querySelector('h4').textContent;
          const category = card.querySelector('.poi-category').textContent;
          const time = card.querySelector('.estimated-time').textContent;
          
          return `
            <div class="selected-poi-item">
              <div class="poi-info">
                <h5>${name}</h5>
                <span class="poi-category">${category}</span>
              </div>
              <div class="poi-time">${time}</div>
              <button class="btn btn--small btn--ghost" onclick="toggleAirportPOI(${poiId})">ì œê±°</button>
            </div>
          `;
        }).join('');
      }

      // ê³µí•­ POI ë‹¤ìŒ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      function updateAirportPOINextButton() {
        const nextButton = document.getElementById('airport-poi-next');
        nextButton.disabled = selectedPOIs.length === 0;
      }

      // ê³µí•­ í•„í„° ì ìš©
      function filterAirportPOIs(category) {
        document.querySelectorAll('#airport-filter-buttons .filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('#airport-poi-grid .poi-card').forEach(card => {
          if (category === 'all' || card.dataset.category === category) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }

      // ë„ì‹œ ì„ í˜¸ë„ í† ê¸€
      function toggleCityPreference(category) {
        const card = document.querySelector(`#city-preferences-step [data-category="${category}"]`);
        
        if (selectedCityPreferences.includes(category)) {
          selectedCityPreferences = selectedCityPreferences.filter(p => p !== category);
          card.classList.remove('selected');
        } else {
          // ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥
          if (selectedCityPreferences.length >= 3) {
            if (window.showModal) {
              showModal({
                message: 'ìµœëŒ€ 3ê°œì˜ ì¹´í…Œê³ ë¦¬ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                type: 'warning'
              });
            } else {
            alert('ìµœëŒ€ 3ê°œì˜ ì¹´í…Œê³ ë¦¬ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            return;
          }
          selectedCityPreferences.push(category);
          card.classList.add('selected');
        }
        
        updateCityPreferencesNextButton();
      }

      // ë„ì‹œ ì„ í˜¸ë„ ë‹¤ìŒ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      function updateCityPreferencesNextButton() {
        const nextButton = document.getElementById('city-preferences-next');
        const hasSelected = selectedCityPreferences.length > 0;
        
        // disabled ëŒ€ì‹  CSSë¡œ ì‹œê°ì  ë¹„í™œì„±í™” (í´ë¦­ì€ ê°€ëŠ¥í•˜ê²Œ í•˜ì—¬ toast í‘œì‹œ)
        if (!hasSelected) {
          nextButton.style.opacity = '0.5';
          nextButton.style.cursor = 'not-allowed';
        } else {
          nextButton.style.opacity = '1';
          nextButton.style.cursor = 'pointer';
        }
      }

      // ë„ì‹œ ì„ í˜¸ë„ ë‹¨ê³„ë¡œ ì´ë™
      function nextToCityPreferences() {
        // ê²€ì¦: ì¹´í…Œê³ ë¦¬ ì„ íƒ í™•ì¸
        if (!selectedTable) {
          showToast({ message: 'ê´€ì‹¬ ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', type: 'warning' });
          return;
        }
        
        // ê²€ì¦: ì¥ì†Œ ì„ íƒ í™•ì¸
        if (selectedPOIs.length === 0) {
          showToast({ message: 'ë°©ë¬¸í•  ì¥ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', type: 'warning' });
          return;
        }
        
        // ê³µí•­ ë‚´ë¶€ ì¼ì • í˜ì´ì§€ë¡œ ì´ë™
        currentStep = 'airport-schedule';
        document.getElementById('preferences-poi-step').style.display = 'none';
        document.getElementById('airport-schedule-step').style.display = 'block';
        
        // ê³µí•­ ë‚´ë¶€ ì¼ì • ìƒì„±
        generateSchedule();
      }

      // ë„ì‹œ ì„ í˜¸ë„ í˜ì´ì§€ë¡œ ì´ë™ (ê³µí•­ ë‚´ë¶€ ì¼ì • í˜ì´ì§€ì—ì„œ í˜¸ì¶œ)
      function goToCityPreferences() {
        currentStep = 'city-preferences';
        document.getElementById('airport-schedule-step').style.display = 'none';
        document.getElementById('city-preferences-step').style.display = 'block';
        
        // ë„ì‹œ ì„ í˜¸ë„ ì´ˆê¸°í™”
        initializeCityPreferences();
      }

      function backToPOISelection() {
        currentStep = 'preferences';
        document.getElementById('airport-schedule-step').style.display = 'none';
        document.getElementById('preferences-poi-step').style.display = 'block';
      }

      function generateSchedule() {
        console.log('ğŸ“ ê³µí•­ ë‚´ë¶€ ì¼ì • ìƒì„± ì‹œì‘');
        console.log('selectedPOIs:', selectedPOIs);
        
        const container = document.getElementById('timeline');
        container.innerHTML = '';
        
        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        selectedPOIs.forEach((poiId, index) => {
          // allPOIsMapì—ì„œ ë¨¼ì € ì°¾ê³ , ì—†ìœ¼ë©´ allPOIsì—ì„œ ì°¾ê¸°
          let poi = allPOIsMap.get(poiId);
          if (!poi) {
            poi = allPOIs.find(p => p.id === poiId);
          }
          
          console.log(`POI ${index + 1} ì¡°íšŒ:`, poiId, poi);
          if (!poi) return;
          
          const timelineItem = document.createElement('div');
          timelineItem.className = 'timeline-item';
          
          const startTime = new Date(currentTime);
          const endTime = new Date(currentTime.getTime() + (poi.estimatedTime || 10) * 60000);
          
          // ì´ë¯¸ì§€ HTML ì¶”ê°€ (airport-only.htmlê³¼ ë™ì¼)
          const imageHtml = poi.imageUrl ? 
            `<div class="timeline-image"><img src="${poi.imageUrl}" alt="${poi.name}" onerror="this.style.display='none'"></div>` : '';
          
          // poi.idë¥¼ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„
          const safePoiId = String(poiId).replace(/'/g, "\\'").replace(/"/g, '&quot;');
          const safeVisitTime = startTime.toISOString();
          
          timelineItem.innerHTML = `
            <div class="timeline-time">
              <span class="start-time">${formatTime(startTime)}</span>
              <span class="end-time">${formatTime(endTime)}</span>
            </div>
            <div class="timeline-content">
              <div class="timeline-content-header">
                <div>
                  <h4>${poi.name}</h4>
                  <span class="timeline-category">${poi.categoryIcon || 'ğŸ“'} ${poi.category || ''}</span>
                </div>
                <button class="btn btn--poi-ai-tip" 
                        data-poi-id="${safePoiId}"
                        data-visit-time="${safeVisitTime}"
                        onclick="generatePOITip('${safePoiId}', '${safeVisitTime}')"
                        aria-label="${poi.name} AI ì´ìš© íŒ ë°›ê¸°">
                  ğŸ¤– AI íŒ
                </button>
              </div>
              ${poi.location ? `<p class="timeline-location">ğŸ“ ${poi.location}</p>` : ''}
              <p>${poi.estimatedTime || 10}ë¶„ ì²´ë¥˜</p>
              
              <!-- AI íŒ í‘œì‹œ ì˜ì—­ -->
              <div class="poi-ai-tip-container" id="poi-tip-${safePoiId}" style="display: none;">
                <div class="poi-ai-tip-content" id="poi-tip-content-${safePoiId}">
                  <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
              </div>
            </div>
            ${imageHtml}
          `;
          
          container.appendChild(timelineItem);
          currentTime = endTime;
        });
        
        console.log('ğŸ“ ê³µí•­ ë‚´ë¶€ ì¼ì • ìƒì„± ì™„ë£Œ');
      }

      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // ì „ì²´ ì¼ì • AI íŒ ìƒì„±
      async function generateAITips() {
        const button = document.getElementById('generate-ai-tips-btn');
        const container = document.getElementById('ai-tips-container');
        const grid = document.getElementById('ai-tips-grid');
        
        if (!button || !container || !grid) {
          console.error('AI íŒ UI ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
        button.disabled = true;
        button.innerHTML = 'â³ AIê°€ íŒì„ ìƒì„± ì¤‘...';
        
        container.style.display = 'block';
        grid.innerHTML = '<div class="loading-ai-tips">AIê°€ ë§ì¶¤ íŒì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';

        try {
          // API í‚¤ í™•ì¸
          const apiKey = window.getOpenAIApiKey ? window.getOpenAIApiKey() : '';
          
          if (!apiKey) {
            throw new Error('OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ì˜ meta íƒœê·¸ì— openai-api-keyë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
          }

          window.aiTipsService.setApiKey(apiKey);

          // ì„ íƒëœ POI ì •ë³´ ìˆ˜ì§‘
          const selectedPOIDetails = selectedPOIs.map(poiId => {
            return allPOIsMap.get(poiId);
          }).filter(poi => poi !== undefined);

          if (selectedPOIDetails.length === 0) {
            throw new Error('ì„ íƒëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.');
          }

          // AI íŒ ìƒì„±
          const tips = await window.aiTipsService.generateAirportScheduleTips(
            selectedPOIs,
            transferInfo,
            allPOIsMap
          );

          // íŒ ë Œë”ë§
          renderAITips(tips);
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          button.disabled = false;
          button.innerHTML = 'ğŸ¤– AI ë§ì¶¤ íŒ ë°›ê¸°';

        } catch (error) {
          console.error('AI íŒ ìƒì„± ì‹¤íŒ¨:', error);
          
          // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
          grid.innerHTML = `
            <div class="ai-tips-error">
              <p>âš ï¸ AI íŒì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
              <p class="error-detail">${error.message}</p>
            </div>
          `;
          
          button.disabled = false;
          button.innerHTML = 'ğŸ¤– AI ë§ì¶¤ íŒ ë°›ê¸°';
        }
      }

      // AI íŒ ë Œë”ë§
      function renderAITips(tips) {
        const grid = document.getElementById('ai-tips-grid');
        if (!grid) return;

        if (!tips || tips.length === 0) {
          grid.innerHTML = '<p>ìƒì„±ëœ íŒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        grid.innerHTML = tips.map(tip => `
          <div class="tip-card ai-tip-card">
            <div class="tip-icon">${tip.icon || 'ğŸ’¡'}</div>
            <h4>${tip.title || 'íŒ'}</h4>
            <p>${tip.description || ''}</p>
            <span class="ai-badge">ğŸ¤– AI ìƒì„±</span>
          </div>
        `).join('');
      }

      // POIë³„ AI íŒ ìƒì„±
      async function generatePOITip(poiId, visitTime) {
        const button = document.querySelector(`[data-poi-id="${poiId}"].btn--poi-ai-tip`);
        const container = document.getElementById(`poi-tip-${poiId}`);
        const content = document.getElementById(`poi-tip-content-${poiId}`);
        
        if (!button || !container || !content) {
          console.error('POI íŒ UI ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', poiId);
          return;
        }

        // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        if (container.style.display !== 'none') {
          container.style.display = 'none';
          button.innerHTML = 'ğŸ¤– AI íŒ';
          return;
        }

        // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”©
        button.disabled = true;
        button.innerHTML = 'â³ ìƒì„± ì¤‘...';
        
        container.style.display = 'block';
        content.innerHTML = '<div class="loading-poi-tip">AIê°€ ì´ìš© íŒì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';

        try {
          // API í‚¤ í™•ì¸
          const apiKey = window.getOpenAIApiKey ? window.getOpenAIApiKey() : '';
          
          if (!apiKey) {
            throw new Error('OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          }

          window.aiTipsService.setApiKey(apiKey);

          // POI ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const poi = allPOIsMap.get(poiId) || allPOIs.find(p => p.id === poiId);
          if (!poi) {
            throw new Error('ì¥ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          // AI íŒ ìƒì„±
          const tipData = await window.aiTipsService.generatePOITip(
            poi,
            transferInfo,
            new Date(visitTime)
          );

          // íŒ ë Œë”ë§
          renderPOITip(tipData, content);
          
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          button.disabled = false;
          button.innerHTML = 'ğŸ¤– AI íŒ';

        } catch (error) {
          console.error('POI AI íŒ ìƒì„± ì‹¤íŒ¨:', error);
          
          content.innerHTML = `
            <div class="poi-tip-error">
              <p>âš ï¸ íŒì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
              <p class="error-detail">${error.message}</p>
            </div>
          `;
          
          button.disabled = false;
          button.innerHTML = 'ğŸ¤– AI íŒ';
        }
      }

      // POI íŒ ë Œë”ë§
      function renderPOITip(tipData, container) {
        if (!tipData || !tipData.tips || tipData.tips.length === 0) {
          container.innerHTML = '<p>ìƒì„±ëœ íŒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // ì¶œì²˜ ë§í¬ HTML ìƒì„±
        let sourcesHtml = '';
        if (tipData.sources && Array.isArray(tipData.sources) && tipData.sources.length > 0) {
          // ìœ íš¨í•œ URLë§Œ í•„í„°ë§
          const validSources = tipData.sources.filter(source => {
            if (!source.url) return false;
            try {
              new URL(source.url);
              return true;
            } catch (e) {
              return false;
            }
          });
          
          if (validSources.length > 0) {
            sourcesHtml = `
              <div class="poi-tip-sources">
                ${validSources.map(source => `
                  <a href="${source.url}" target="_blank" rel="noopener noreferrer" class="poi-tip-source-link">
                    ${source.label || 'ì¶œì²˜'}
                  </a>
                `).join('')}
              </div>
            `;
          } else if (tipData.sourceNote) {
            sourcesHtml = `
              <div class="poi-tip-source-note">
                ${tipData.sourceNote}
              </div>
            `;
          }
        } else if (tipData.sourceNote) {
          sourcesHtml = `
            <div class="poi-tip-source-note">
              ${tipData.sourceNote}
            </div>
          `;
        } else {
          sourcesHtml = `
            <div class="poi-tip-source-note">
              â€» ìœ„ ì •ë³´ëŠ” ì¼ë°˜ì ì¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
          `;
        }

        container.innerHTML = `
          <div class="poi-tip-header">
            <h5>${tipData.title || 'ğŸ’¡ ì´ìš© íŒ'}</h5>
            <span class="ai-badge-small">ğŸ¤– AI ìƒì„±</span>
          </div>
          <ul class="poi-tip-list">
            ${tipData.tips.map(tip => `<li>${tip}</li>`).join('')}
          </ul>
          ${sourcesHtml}
        `;
      }

      // ì¼ì • ì €ì¥ (PDF ë‹¤ìš´ë¡œë“œ)
      async function saveSchedule() {
        try {
          const scheduleContent = document.getElementById('airport-schedule-step');
          
          // html2canvasë¡œ HTMLì„ ì´ë¯¸ì§€ë¡œ ë³€í™˜
          const canvas = await html2canvas(scheduleContent, {
            useCORS: true,
            scale: 2,
            backgroundColor: '#ffffff'
          });
          
          // PDF ìƒì„±
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
          });
          
          // ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚°
          const imgWidth = 210; // A4 width in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          // ì´ë¯¸ì§€ë¥¼ PDFì— ì¶”ê°€
          const imgData = canvas.toDataURL('image/png');
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          
          // PDF ì €ì¥
          const fileName = `ê³µí•­ë‚´ë¶€ì¼ì •_${transferInfo.city}_${new Date().toISOString().split('T')[0]}.pdf`;
          pdf.save(fileName);
          
          if (window.showModal) {
            showModal({
              message: 'PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!',
              type: 'success'
            });
          } else {
          alert('âœ… PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        } catch (error) {
          console.error('PDF ìƒì„± ì‹¤íŒ¨:', error);
          if (window.showModal) {
            showModal({
              message: 'PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
              type: 'error'
            });
          } else {
          alert('âŒ PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        }
      }

      // ì¼ì • ê³µìœ 
      function shareSchedule() {
        let shareText = `ğŸ¢ ê³µí•­ ë‚´ë¶€ ì¼ì •\n\n`;
        shareText += `ê²½ìœ  ë„ì‹œ: ${transferInfo.city}\n`;
        shareText += `í™˜ìŠ¹ ì‹œê°„: ${formatDuration(transferInfo.duration)}\n\n`;
        shareText += `ğŸ“ ë°©ë¬¸ ì¥ì†Œ:\n`;
        
        selectedPOIs.forEach((poiId, index) => {
          const poi = allPOIs.find(p => p.id === poiId);
          if (poi) {
            shareText += `${index + 1}. ${poi.name}\n`;
            shareText += `   ìœ„ì¹˜: ${poi.location}\n`;
            shareText += `   ì†Œìš” ì‹œê°„: ${poi.estimatedTime}ë¶„\n`;
            if (poi.businessHours) {
              shareText += `   ì˜ì—… ì‹œê°„: ${poi.businessHours}\n`;
            }
            shareText += `\n`;
          }
        });
        
        // í´ë¦½ë³´ë“œì— ë³µì‚¬
        navigator.clipboard.writeText(shareText).then(() => {
          if (window.showModal) {
            showModal({
              message: 'ì¼ì •ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nê³µìœ í•  ê³³ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”.',
              type: 'success'
            });
          } else {
          alert('âœ… ì¼ì •ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nê³µìœ í•  ê³³ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”.');
          }
        }).catch((error) => {
          console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', error);
          if (window.showModal) {
            showModal({
              message: 'ì¼ì • ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
              type: 'error'
            });
          } else {
          alert('âŒ ì¼ì • ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        });
      }

      // ë„ì‹œ POI ì„ íƒ ë‹¨ê³„ë¡œ ì´ë™
      async function nextToCityPOISelection() {
        // ê²€ì¦: ë„ì‹œ ì¹´í…Œê³ ë¦¬ ì„ íƒ í™•ì¸
        if (selectedCityPreferences.length === 0) {
          showToast({ message: 'ê´€ì‹¬ ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', type: 'warning' });
          return;
        }
        
        // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
        
        try {
          // ê³µí•­ ë‚´ë¶€ POI ë°ì´í„°ë¥¼ sessionStorageì— ì €ì¥
          // allPOIsëŠ” í˜„ì¬ í•„í„°ëœ ê²°ê³¼ë§Œ ìˆìœ¼ë¯€ë¡œ, allPOIsMapì—ì„œ ëª¨ë“  POIë¥¼ ê°€ì ¸ì˜´
          const allPOIsArray = Array.from(allPOIsMap.values());
          
          const airportPOIData = {
            selectedPOIs: selectedPOIs,
            allPOIs: allPOIsArray, // allPOIsMapì˜ ëª¨ë“  POI í¬í•¨ (ëª¨ë“  ì¹´í…Œê³ ë¦¬)
            selectedTable: selectedTable,
            selectedTypes: selectedTypes
          };
          sessionStorage.setItem('airportPOIData', JSON.stringify(airportPOIData));
          console.log('âœ… ê³µí•­ ë‚´ë¶€ POI ë°ì´í„° ì €ì¥ ì™„ë£Œ:', {
            selectedCount: selectedPOIs.length,
            allPOIsCount: allPOIsArray.length,
            selectedPOIs: selectedPOIs,
            allPOIsIds: allPOIsArray.map(p => p.id).slice(0, 10) // ì²˜ìŒ 10ê°œë§Œ ë¡œê·¸
          });
          
          // ì¼ì • ìƒì„± (ìš´ì˜ ì‹œê°„ ë¹„êµ í¬í•¨)
          await generateCityPlan();
          
          // ì „ì²´ ì¼ì • í˜ì´ì§€ë¡œ ì´ë™
          currentStep = 'full-schedule';
          document.getElementById('city-preferences-step').style.display = 'none';
          document.getElementById('full-schedule-step').style.display = 'block';
          
          // DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ì „ì²´ ì¼ì • ìƒì„±
          setTimeout(() => {
            generateFullSchedule();
          }, 50);
        } catch (error) {
          console.error('ë„ì‹œ ì¼ì • ìƒì„± ì‹¤íŒ¨:', error);
          if (window.showModal) {
            showModal({
              message: 'ì¼ì • ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
              type: 'error'
            });
          } else {
          alert('ì¼ì • ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        } finally {
          // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
        }
      }
      
      // ë„ì‹œ ì¼ì • ìƒì„±
      async function generateCityPlan() {
        // transferInfoì—ì„œ ë„ì°©/ì¶œë°œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        const arrivalTime = new Date(transferInfo.arrival);
        const departureTime = new Date(transferInfo.departure);
        
        // ë²„í¼ ì‹œê°„ ì„¤ì • (ê¸°ë³¸ê°’ ì‚¬ìš©)
        const entryBufferMinutes = 90; // ì…êµ­ ë²„í¼
        const returnBufferMinutes = 120; // ë³µê·€ ë²„í¼
        
        // ê¸°ë³¸ ì²´ë¥˜ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        const defaultStayMinutes = parseInt(document.getElementById('city-stay-number')?.value || '60', 10);
        
        // íƒë°© ê°€ëŠ¥ ì‹œê°„ ê³„ì‚°
        const startWindow = new Date(arrivalTime.getTime() + entryBufferMinutes * 60000);
        const endWindow = new Date(departureTime.getTime() - returnBufferMinutes * 60000);
        const availableMinutes = Math.max((endWindow.getTime() - startWindow.getTime()) / 60000, 0);
        
        // ë„ì‹œ POI ê²€ìƒ‰ (POI Service Manager ì‚¬ìš©)
        if (!window.poiServiceManager) {
          throw new Error('POI Service Managerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        // ì‹±ê°€í¬ë¥´ ë„ì‹œ ì¤‘ì‹¬ ì¢Œí‘œ
        const cityCenter = { lat: 1.3521, lng: 103.8198 }; // Singapore city center
        
        // 1ë‹¨ê³„: ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ POI ê²€ìƒ‰ (ê· í˜• ìˆëŠ” ì„ íƒì„ ìœ„í•´ ì¶©ë¶„íˆ ê°€ì ¸ì˜¤ê¸°)
        const categoryPOIsMap = new Map(); // ì¹´í…Œê³ ë¦¬ë³„ POI ê·¸ë£¹
        const targetCount = 3; // ìµœì¢…ì ìœ¼ë¡œ ì„ íƒí•  POI ê°œìˆ˜
        
        for (const category of selectedCityPreferences) {
          const pois = await window.poiServiceManager.searchCityPOIs(cityCenter, [category], 10000); // 10km ë°˜ê²½
          
          if (pois.length > 0) {
            // ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ìµœì†Œ 5-10ê°œ ì •ë„ëŠ” ê°€ì ¸ì™€ì„œ ìš´ì˜ ì‹œê°„ í•„í„°ë§ í›„ ì„ íƒ
            categoryPOIsMap.set(category, pois.slice(0, 10)); // ìƒìœ„ 10ê°œë§Œ ì‚¬ìš©
          }
        }
        
        // 2ë‹¨ê³„: ê° POIì˜ ìƒì„¸ ì •ë³´(ìš´ì˜ ì‹œê°„ í¬í•¨) ê°€ì ¸ì˜¤ê¸° ë° ìš´ì˜ ì‹œê°„ í•„í„°ë§
        const allPOIsWithDetails = [];
        const exploreWindow = {
          start: startWindow,
          end: endWindow,
          durationMinutes: defaultStayMinutes,
          timeZone: 'Asia/Singapore' // ì‹±ê°€í¬ë¥´ ì‹œê°„ëŒ€
        };
        
        for (const [category, pois] of categoryPOIsMap.entries()) {
          for (let i = 0; i < pois.length; i++) {
            const poi = pois[i];
            if (!poi.id) {
              console.warn(`  âš ï¸ [generateCityPlan] POI "${poi.name}"ì— place_idê°€ ì—†ìŠµë‹ˆë‹¤.`);
              continue;
            }
            
            try {
              // POI ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (opening_hours í¬í•¨)
              const poiDetails = await window.getPOIInfo(poi.id);
              
              if (!poiDetails) {
                console.warn(`  âš ï¸ [generateCityPlan] POI "${poi.name}" ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                continue;
              }
              
              // ìš´ì˜ ì‹œê°„ í™•ì¸ì„ ìœ„í•œ travelTime ìƒì„± (exploreWindow ì¤‘ê°„ ì‹œì ì„ ë°©ë¬¸ ì‹œê°„ìœ¼ë¡œ ê°€ì •)
              const visitStartTime = new Date(startWindow.getTime() + (i * (availableMinutes / categoryPOIsMap.size / 2) * 60000));
              const travelTime = {
                start: visitStartTime,
                durationMinutes: defaultStayMinutes,
                timeZone: 'Asia/Singapore'
              };
              
              // ìš´ì˜ ìƒíƒœ í™•ì¸
              const businessStatus = window.getBusinessStatus(poiDetails, travelTime);
              
              // OPEN ìƒíƒœì¸ POIë§Œ ì¶”ê°€ (UNKNOWNê³¼ CLOSEDëŠ” ì œì™¸)
              if (businessStatus === 'OPEN') {
                allPOIsWithDetails.push({
                  ...poi,
                  ...poiDetails,
                  category,
                  businessStatus,
                  visitStartTime
                });
                
                // ì¶©ë¶„í•œ POIë¥¼ ëª¨ìœ¼ë©´ ì¤‘ë‹¨ (ì„±ëŠ¥ ìµœì í™”)
                if (allPOIsWithDetails.length >= targetCount * 2) {
                  break;
                }
              }
            } catch (error) {
              console.error(`  âŒ [generateCityPlan] POI "${poi.name}" ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:`, error);
              // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ë‹¤ìŒ POI ê³„ì† ê²€ìƒ‰
              continue;
            }
          }
        }
        
        // 3ë‹¨ê³„: ì¹´í…Œê³ ë¦¬ë³„ ê· í˜• ìˆëŠ” ì„ íƒ
        const selectedPOIs = [];
        const categoryCount = selectedCityPreferences.length;
        const poisPerCategory = Math.ceil(targetCount / categoryCount); // ì¹´í…Œê³ ë¦¬ë‹¹ ìµœì†Œ ê°œìˆ˜
        
        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¶„ë¥˜
        const poisByCategory = new Map();
        for (const poi of allPOIsWithDetails) {
          if (!poisByCategory.has(poi.category)) {
            poisByCategory.set(poi.category, []);
          }
          poisByCategory.get(poi.category).push(poi);
        }
        
        
        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê· í˜• ìˆê²Œ ì„ íƒ (ë¼ìš´ë“œ ë¡œë¹ˆ ë°©ì‹)
        const categoryIndices = new Map(); // ê° ì¹´í…Œê³ ë¦¬ì˜ í˜„ì¬ ì¸ë±ìŠ¤
        selectedCityPreferences.forEach(cat => categoryIndices.set(cat, 0));
        
        while (selectedPOIs.length < targetCount && allPOIsWithDetails.length > 0) {
          let found = false;
          
          // ê° ì¹´í…Œê³ ë¦¬ë¥¼ ìˆœíšŒí•˜ë©´ì„œ í•˜ë‚˜ì”© ì„ íƒ
          for (const category of selectedCityPreferences) {
            if (selectedPOIs.length >= targetCount) break;
            
            const categoryPOIs = poisByCategory.get(category) || [];
            const currentIndex = categoryIndices.get(category) || 0;
            
            if (currentIndex < categoryPOIs.length) {
              const poi = categoryPOIs[currentIndex];
              
              // ì¤‘ë³µ ì²´í¬ (ì´ë¯¸ ì„ íƒëœ POI ì œì™¸)
              if (!selectedPOIs.some(sp => sp.id === poi.id)) {
                selectedPOIs.push(poi);
                categoryIndices.set(category, currentIndex + 1);
                found = true;
              } else {
                categoryIndices.set(category, currentIndex + 1);
              }
            }
          }
          
          // ë” ì´ìƒ ì„ íƒí•  ìˆ˜ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if (!found) {
            break;
          }
        }
        
        // ì„ íƒëœ POIê°€ ë¶€ì¡±í•œ ê²½ìš°, ë‚˜ë¨¸ì§€ëŠ” í‰ì /ë¦¬ë·° ê¸°ì¤€ìœ¼ë¡œ ì¶”ê°€
        if (selectedPOIs.length < targetCount) {
          const remainingPOIs = allPOIsWithDetails
            .filter(poi => !selectedPOIs.some(sp => sp.id === poi.id))
            .sort((a, b) => {
              // í‰ì  ìš°ì„ , ê·¸ ë‹¤ìŒ ë¦¬ë·° ìˆ˜
              if (b.rating !== a.rating) return b.rating - a.rating;
              return (b.userRatingsTotal || 0) - (a.userRatingsTotal || 0);
            });
          
          while (selectedPOIs.length < targetCount && remainingPOIs.length > 0) {
            selectedPOIs.push(remainingPOIs.shift());
          }
        }
        
        // ê²€ìƒ‰ëœ POIë¥¼ waypoint í˜•íƒœë¡œ ë³€í™˜ (Google Maps API ì‹¤ì œ ë°ì´í„° í¬í•¨)
        const waypoints = selectedPOIs.map((poi, index) => ({
          label: poi.name,
          address: poi.address || poi.location,
          location: poi.location,
          categoryKey: poi.category,
          category: poi.category, // ì¹´í…Œê³ ë¦¬ ë¼ë²¨
          categoryIcon: poi.categoryIcon, // í•˜ë“œì½”ë”©ëœ ì´ëª¨ì§€
          stayMinutes: defaultStayMinutes,
          rating: poi.rating || 0, // Google Maps APIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ í‰ì 
          userRatingsTotal: poi.userRatingsTotal || 0, // Google Maps APIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ë¦¬ë·° ìˆ˜
          photos: poi.photos || [] // Google Maps Photo ê°ì²´
        }));
        
        // ê³µí•­ ì•µì»¤ ìƒì„±
        const arriveAnchor = {
          label: 'ì‹±ê°€í¬ë¥´ ì°½ì´ê³µí•­',
          address: 'Singapore Changi Airport',
          location: { lat: 1.3644, lng: 103.9915 },
          placeId: null
        };
        
        // ì¼ì • ë°ì´í„° ìƒì„±
        const plan = {
          origin: arriveAnchor,
          destination: arriveAnchor,
          waypoints,
          meta: {
            // ì›ë³¸ ë„ì°©/ì¶œë°œ ì‹œê°„ (transfer-infoì—ì„œ ì…ë ¥í•œ ê°’)
            originalArrival: arrivalTime.toISOString(),
            originalDeparture: departureTime.toISOString(),
            // ë²„í¼ ì ìš©ëœ ë„ì°©/ì¶œë°œ ì‹œê°„
            arrival: startWindow.toISOString(),
            departure: endWindow.toISOString(),
            entryBufferMinutes,
            returnBufferMinutes,
            exploreWindow: {
              start: startWindow.toISOString(),
              end: endWindow.toISOString(),
              availableMinutes: Math.round(availableMinutes)
            },
            categoriesUsed: selectedCityPreferences,
            cityText: 'Singapore',
            timeZone: 'Asia/Singapore' // ì‹±ê°€í¬ë¥´ ì‹œê°„ëŒ€ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥
          }
        };
        
        // ìƒì„±ëœ ì¼ì • ì €ì¥
        sessionStorage.setItem('cityPlan', JSON.stringify(plan));
        
        return plan;
      }

      // ë„ì‹œ POI ì„ íƒ ì´ˆê¸°í™”
      function initializeCityPOISelection() {
        generateCityFilterButtons();
        generateCityPOICards();
        updateCityPOINextButton();
      }

      // ë„ì‹œ í•„í„° ë²„íŠ¼ ìƒì„±
      function generateCityFilterButtons() {
        const container = document.getElementById('city-filter-buttons');
        container.innerHTML = '';
        
        const allButton = document.createElement('button');
        allButton.className = 'filter-btn active';
        allButton.textContent = 'ì „ì²´';
        allButton.onclick = () => filterCityPOIs('all');
        container.appendChild(allButton);
        
        selectedCityPreferences.forEach(category => {
          const button = document.createElement('button');
          button.className = 'filter-btn';
          button.textContent = getCityCategoryLabel(category);
          button.onclick = () => filterCityPOIs(category);
          container.appendChild(button);
        });
      }

      // ë„ì‹œ ì¹´í…Œê³ ë¦¬ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
      function getCityCategoryLabel(category) {
        const labels = {
          attractions: 'ê´€ê´‘ëª…ì†Œ',
          shopping: 'ì‡¼í•‘',
          food: 'ìŒì‹',
          culture: 'ë¬¸í™”ì²´í—˜',
          nature: 'ìì—°',
          nightlife: 'ì•¼ê²½/ì•¼ìƒí™œ'
        };
        return labels[category] || category;
      }

      // ë„ì‹œ POI ì¹´ë“œ ìƒì„± (ì„ì‹œ ë°ì´í„°)
      function generateCityPOICards() {
        const container = document.getElementById('city-poi-grid');
        container.innerHTML = '';
        
        // ì„ì‹œ ë„ì‹œ POI ë°ì´í„°
        const sampleCityPOIs = [
          { id: 101, name: 'ë„ì‹œ ëœë“œë§ˆí¬', category: 'attractions', description: 'ìœ ëª…í•œ ê´€ê´‘ëª…ì†Œ', estimatedTime: 120 },
          { id: 102, name: 'ë¡œì»¬ ì‹œì¥', category: 'shopping', description: 'ì „í†µ ì‹œì¥ ì²´í—˜', estimatedTime: 90 },
          { id: 103, name: 'ì „í†µ ë§›ì§‘', category: 'food', description: 'ë¡œì»¬ ì „í†µ ìŒì‹', estimatedTime: 60 },
          { id: 104, name: 'ë°•ë¬¼ê´€', category: 'culture', description: 'ì—­ì‚¬ ë¬¸í™” ì²´í—˜', estimatedTime: 90 },
          { id: 105, name: 'ì¤‘ì•™ ê³µì›', category: 'nature', description: 'ìì—° íœ´ì‹ ê³µê°„', estimatedTime: 60 },
          { id: 106, name: 'ì•¼ê²½ ì „ë§ëŒ€', category: 'nightlife', description: 'ë„ì‹œ ì•¼ê²½ ê°ìƒ', estimatedTime: 45 }
        ];
        
        sampleCityPOIs.forEach(poi => {
          if (selectedCityPreferences.includes(poi.category) || selectedCityPreferences.length === 0) {
            const card = createCityPOICard(poi);
            container.appendChild(card);
          }
        });
      }

      // ë„ì‹œ POI ì¹´ë“œ ìƒì„±
      function createCityPOICard(poi) {
        const card = document.createElement('div');
        card.className = 'poi-card';
        card.dataset.poiId = poi.id;
        card.dataset.category = poi.category;
        
        card.innerHTML = `
          <div class="poi-header">
            <h4>${poi.name}</h4>
            <span class="poi-category">${getCityCategoryLabel(poi.category)}</span>
          </div>
          <p class="poi-description">${poi.description}</p>
          <div class="poi-footer">
            <span class="estimated-time">ì˜ˆìƒ ì†Œìš”ì‹œê°„: ${poi.estimatedTime}ë¶„</span>
            <button class="btn btn--small" onclick="toggleCityPOI(${poi.id})">ì„ íƒ</button>
          </div>
        `;
        
        return card;
      }

      // ë„ì‹œ POI í† ê¸€
      function toggleCityPOI(poiId) {
        const card = document.querySelector(`#city-poi-grid [data-poi-id="${poiId}"]`);
        if (!card) return;
        
        const button = card.querySelector('button');
        if (!button) return;
        
        // ì´ë¯¸ ì„ íƒëœ ê²½ìš° ì œê±°
        if (selectedCityPOIs.includes(poiId)) {
          selectedCityPOIs = selectedCityPOIs.filter(id => id !== poiId);
          card.classList.remove('selected');
          button.textContent = 'ì„ íƒ';
        } else {
          // ì¤‘ë³µ ì„ íƒ í™•ì¸ (ì´ë¯¸ ì„ íƒëœ ê²½ìš°)
          if (selectedCityPOIs.includes(poiId)) {
            showToast({ message: 'ì´ë¯¸ ì„ íƒí•œ ì¥ì†Œì…ë‹ˆë‹¤.', type: 'warning' });
            return;
          }
          
          selectedCityPOIs.push(poiId);
          card.classList.add('selected');
          button.textContent = 'ì„ íƒë¨';
        }
        
        updateCitySelectedPOIsList();
        updateCityPOINextButton();
      }

      // ì„ íƒëœ ë„ì‹œ POI ëª©ë¡ ì—…ë°ì´íŠ¸
      function updateCitySelectedPOIsList() {
        const container = document.getElementById('city-selected-list');
        
        if (selectedCityPOIs.length === 0) {
          container.innerHTML = '<p class="empty-message">ì•„ì§ ì„ íƒí•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        container.innerHTML = selectedCityPOIs.map(poiId => {
          const card = document.querySelector(`#city-poi-grid [data-poi-id="${poiId}"]`);
          const name = card.querySelector('h4').textContent;
          const category = card.querySelector('.poi-category').textContent;
          const time = card.querySelector('.estimated-time').textContent;
          
          return `
            <div class="selected-poi-item">
              <div class="poi-info">
                <h5>${name}</h5>
                <span class="poi-category">${category}</span>
              </div>
              <div class="poi-time">${time}</div>
              <button class="btn btn--small btn--ghost" onclick="toggleCityPOI(${poiId})">ì œê±°</button>
            </div>
          `;
        }).join('');
      }

      // ë„ì‹œ POI ë‹¤ìŒ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      function updateCityPOINextButton() {
        const nextButton = document.getElementById('city-poi-next');
        nextButton.disabled = selectedCityPOIs.length === 0;
      }

      // ë„ì‹œ í•„í„° ì ìš©
      function filterCityPOIs(category) {
        document.querySelectorAll('#city-filter-buttons .filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.querySelectorAll('#city-poi-grid .poi-card').forEach(card => {
          if (category === 'all' || card.dataset.category === category) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }

      // ì¼ì • ë‹¨ê³„ë¡œ ì´ë™
      async function nextToSchedule() {
        // ê²€ì¦: ë„ì‹œ ì¥ì†Œ ì„ íƒ í™•ì¸
        if (selectedCityPOIs.length === 0) {
          showToast({ message: 'ë°©ë¬¸í•  ì¥ì†Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', type: 'warning' });
          return;
        }
        
        // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
        
        try {
          // ë„ì‹œ ì¼ì • ìƒì„± (ìš´ì˜ ì‹œê°„ ë¹„êµ í¬í•¨)
          await generateCityPlan();
          
          // ì „ì²´ ì¼ì • í˜ì´ì§€ë¡œ ì´ë™
          currentStep = 'full-schedule';
          document.getElementById('city-poi-step').style.display = 'none';
          document.getElementById('full-schedule-step').style.display = 'block';
          
          // DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ì „ì²´ ì¼ì • ìƒì„±
          setTimeout(() => {
            generateFullSchedule();
          }, 50);
        } catch (error) {
          console.error('ë„ì‹œ ì¼ì • ìƒì„± ì‹¤íŒ¨:', error);
          showToast({ message: 'ì¼ì • ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', type: 'error' });
        } finally {
          // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
        }
      }

      // ì¼ì • ìƒì„±
      // ì „ì²´ ì¼ì • ìƒì„± (ì „ì²´ ì¼ì • í˜ì´ì§€ìš©)
      function generateFullSchedule() {
        generateAirportTimeline();
        generateCitySchedule();
      }

      // ê³µí•­ ë‚´ë¶€ íƒ€ì„ë¼ì¸ ìƒì„± (ì „ì²´ ì¼ì • í˜ì´ì§€ìš©)
      function generateAirportTimeline() {
        const container = document.getElementById('airport-timeline');
        
        if (!container) {
          console.error('âŒ [generateAirportTimeline] airport-timeline ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
          // DOMì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì‹œ í›„ ì¬ì‹œë„
          setTimeout(() => {
            generateAirportTimeline();
          }, 100);
          return;
        }
        
        container.innerHTML = '';
        
        // sessionStorageì—ì„œ ê³µí•­ POI ë°ì´í„° ë¡œë“œ (trip-summary.htmlê³¼ ë™ì¼í•œ ë°©ì‹)
        const airportPOIDataStr = sessionStorage.getItem('airportPOIData');
        let airportPOIs = [];
        
        if (airportPOIDataStr) {
          try {
            const airportPOIData = JSON.parse(airportPOIDataStr);
            
            // ì„ íƒëœ POI ID ëª©ë¡ê³¼ ì „ì²´ POI ëª©ë¡ì„ ë§¤ì¹­í•˜ì—¬ airportPOIs ìƒì„± (trip-summary.htmlê³¼ ë™ì¼)
            airportPOIs = airportPOIData.selectedPOIs
              .map(poiId => airportPOIData.allPOIs.find(p => p.id === poiId))
              .filter(poi => poi != null);
            
          } catch (error) {
            console.error('âŒ [generateAirportTimeline] airportPOIData íŒŒì‹± ì‹¤íŒ¨:', error);
          }
        }
        
        // sessionStorageì—ì„œ ë°ì´í„°ë¥¼ ëª» ì°¾ì€ ê²½ìš° ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© (í´ë°±)
        if (airportPOIs.length === 0) {
          airportPOIs = selectedPOIs.map(poiId => {
            let poi = allPOIsMap.get(poiId);
            if (!poi) {
              poi = allPOIs.find(p => p.id === poiId);
            }
            return poi;
          }).filter(poi => poi != null);
        }
        
        if (airportPOIs.length === 0) {
          console.warn('âš ï¸ [generateAirportTimeline] ì„ íƒëœ POIê°€ ì—†ìŠµë‹ˆë‹¤.');
          container.innerHTML = '<p class="empty-timeline">ì„ íƒëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        const arrivalTime = new Date(transferInfo.arrival);
        let currentTime = new Date(arrivalTime);
        
        airportPOIs.forEach((poi, index) => {
          const timelineItem = document.createElement('div');
          timelineItem.className = 'timeline-item';
          
          const startTime = new Date(currentTime);
          const endTime = new Date(currentTime.getTime() + (poi.estimatedTime || 10) * 60000);
          
          timelineItem.innerHTML = `
            <div class="timeline-time">
              <span class="start-time">${formatTime(startTime)}</span>
              <span class="end-time">${formatTime(endTime)}</span>
            </div>
            <div class="timeline-content">
              <h4>${poi.name}</h4>
              <p>${poi.location || ''}</p>
            </div>
          `;
          
          container.appendChild(timelineItem);
          currentTime = endTime;
        });
        
        console.log('âœ… [generateAirportTimeline] ì™„ë£Œ:', {
          renderedCount: container.children.length,
          selectedCount: airportPOIs.length
        });
      }

      // ë„ì‹œ ì¼ì • ìƒì„±
      function generateCitySchedule() {
        const container = document.getElementById('city-timeline');
        if (!container) return;
        container.innerHTML = '';
        
        // ì €ì¥ëœ ë„ì‹œ ì¼ì • ê°€ì ¸ì˜¤ê¸°
        const cityPlanStr = sessionStorage.getItem('cityPlan');
        if (!cityPlanStr) {
          container.innerHTML = '<p class="empty-message">ë„ì‹œ íƒë°© ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        const cityPlan = JSON.parse(cityPlanStr);
        const { waypoints, meta } = cityPlan;
        
        if (!waypoints || waypoints.length === 0) {
          container.innerHTML = '<p class="empty-message">ë°©ë¬¸í•  ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        waypoints.forEach((waypoint, index) => {
          const poiCard = document.createElement('div');
          poiCard.className = 'city-poi-card';
          
          // ì´ë¯¸ì§€, í‰ì , ë¦¬ë·° ìˆ˜ ì •ë³´ í‘œì‹œ (Google Maps API ì‹¤ì œ ë°ì´í„° ì‚¬ìš©)
          // photosëŠ” Google Maps Photo ê°ì²´ì´ê±°ë‚˜ ì§ë ¬í™”ëœ ê²½ìš°ë¥¼ ëŒ€ë¹„
          let imageUrl = null;
          if (waypoint.photos && waypoint.photos.length > 0) {
            const photo = waypoint.photos[0];
            if (typeof photo.getUrl === 'function') {
              // Google Maps Photo ê°ì²´ì¸ ê²½ìš°
              try {
                imageUrl = photo.getUrl({ maxWidth: 300, maxHeight: 200 });
              } catch (e) {
                console.warn('Photo getUrl() ì‹¤íŒ¨:', e);
              }
            } else if (photo.url) {
              // ì§ë ¬í™”ëœ ê²½ìš° URLì´ ìˆì„ ìˆ˜ ìˆìŒ
              imageUrl = photo.url;
            }
          }
          const rating = waypoint.rating || 0; // ì‹¤ì œ Google Maps API í‰ì  (í´ë°± ì œê±°)
          const reviewCount = waypoint.userRatingsTotal || 0; // ì‹¤ì œ Google Maps API ë¦¬ë·° ìˆ˜ (í´ë°± ì œê±°)
          const categoryIcon = waypoint.categoryIcon || 'ğŸ“'; // í•˜ë“œì½”ë”©ëœ ì´ëª¨ì§€ (ìœ ì§€)
          
          poiCard.innerHTML = `
            <div class="poi-card-content">
              ${imageUrl ? `<img src="${imageUrl}" alt="${waypoint.label}" onerror="this.style.display='none'" />` : ''}
              <div class="poi-card-details">
                <h4>${waypoint.label}</h4>
                <p class="poi-address">${waypoint.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</p>
                <div class="poi-meta">
                  <div class="poi-rating">
                    <span class="rating-stars">â­ ${rating.toFixed(1)}</span>
                    <span class="review-count">(${reviewCount.toLocaleString()}ë¦¬ë·°)</span>
                  </div>
                  <div class="poi-category-badge">
                    ${categoryIcon} ${waypoint.category || 'ê¸°íƒ€'}
                  </div>
                </div>
              </div>
            </div>
          `;
          
          container.appendChild(poiCard);
        });
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // ë„¤ë¹„ê²Œì´ì…˜ ì‹œì‘
      function startNavigation() {
        // ë„ì‹œ ì¼ì • ê°€ì ¸ì˜¤ê¸°
        const cityPlanStr = sessionStorage.getItem('cityPlan');
        const airportPOIDataStr = sessionStorage.getItem('airportPOIData');
        
        if (!cityPlanStr) {
          if (window.showModal) {
            showModal({
              message: 'ë„ì‹œ íƒë°© ì¼ì •ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
              type: 'error'
            });
          } else {
          alert('ë„ì‹œ íƒë°© ì¼ì •ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
          return;
        }
        
        const cityPlan = JSON.parse(cityPlanStr);
        
        // navigation.htmlì—ì„œ ì‚¬ìš©í•  í˜•íƒœë¡œ ë°ì´í„° ì €ì¥
        const plan = {
          origin: cityPlan.origin,
          destination: cityPlan.destination,
          waypoints: cityPlan.waypoints,
          meta: cityPlan.meta
        };
        
        // sessionStorageì— ì €ì¥
        sessionStorage.setItem('plannerResult', JSON.stringify(plan));
        
        // airport POI ë°ì´í„°ë„ í•¨ê»˜ ì €ì¥
        if (airportPOIDataStr) {
          sessionStorage.setItem('airportPOIData', airportPOIDataStr);
        }
        
        // navigation.htmlë¡œ ì´ë™
        window.location.href = 'navigation.html';
      }

      // ë’¤ë¡œê°€ê¸° í•¨ìˆ˜ë“¤
      function backToAirportPreferences() {
        currentStep = 'preferences';
        document.getElementById('airport-poi-step').style.display = 'none';
        document.getElementById('preferences-step').style.display = 'block';
      }

      function backToAirportPOISelection() {
        // ê³µí•­ ë‚´ë¶€ ì¼ì • í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸° (ë„ì‹œ ì„ í˜¸ë„ í˜ì´ì§€ì—ì„œ ì˜¨ ê²½ìš°)
        currentStep = 'airport-schedule';
        document.getElementById('city-preferences-step').style.display = 'none';
        document.getElementById('airport-schedule-step').style.display = 'block';
      }

      function backToCityPreferences() {
        currentStep = 'city-preferences';
        document.getElementById('city-poi-step').style.display = 'none';
        document.getElementById('city-preferences-step').style.display = 'block';
      }

      function backToCityPOISelection() {
        currentStep = 'city-poi-selection';
        document.getElementById('full-schedule-step').style.display = 'none';
        document.getElementById('city-poi-step').style.display = 'block';
      }

      // AI ì±„íŒ…ì°½ ì´ˆê¸°í™”
      async function initAIChat() {
        const chatContainer = document.getElementById('ai-chat-container');
        const chatMessages = document.getElementById('ai-chat-messages');
        const chatInput = document.getElementById('ai-chat-input');
        const chatSend = document.getElementById('ai-chat-send');
        const chatToggle = document.getElementById('ai-chat-toggle');

        if (!chatContainer || !chatMessages || !chatInput || !chatSend) {
          console.warn('AI ì±„íŒ…ì°½ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ì „ì†¡ ë²„íŠ¼ í´ë¦­
        chatSend.addEventListener('click', async () => {
          await handleAIChatSend();
        });

        // Enter í‚¤ ì…ë ¥
        chatInput.addEventListener('keypress', async (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            await handleAIChatSend();
          }
        });

        // ì ‘ê¸°/í¼ì¹˜ê¸°
        if (chatToggle) {
          let isCollapsed = false;
          
          // í† ê¸€ ë²„íŠ¼ í´ë¦­
          chatToggle.addEventListener('click', (e) => {
            e.stopPropagation(); // í—¤ë” í´ë¦­ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€
            toggleChat();
          });
          
          // í—¤ë” í´ë¦­ìœ¼ë¡œë„ ì ‘ê¸°/í¼ì¹˜ê¸° ê°€ëŠ¥
          const chatHeader = chatContainer.querySelector('.ai-chat-header');
          if (chatHeader) {
            chatHeader.addEventListener('click', (e) => {
              // í† ê¸€ ë²„íŠ¼ì´ ì•„ë‹Œ í—¤ë” ì˜ì—­ í´ë¦­ ì‹œì—ë§Œ
              if (!chatToggle.contains(e.target)) {
                toggleChat();
              }
            });
          }
          
          function toggleChat() {
            isCollapsed = !isCollapsed;
            chatContainer.classList.toggle('collapsed');
            chatToggle.textContent = isCollapsed ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
          }
        }

        async function handleAIChatSend() {
          const query = chatInput.value.trim();
          if (!query) return;

          // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
          addChatMessage('user', query);
          chatInput.value = '';
          chatSend.disabled = true;

          // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'ai-chat-loading';
          loadingDiv.textContent = 'ê²€ìƒ‰ ì¤‘...';
          chatMessages.appendChild(loadingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          try {
            // AI ê²€ìƒ‰ ì„œë¹„ìŠ¤ import
            const { airportPOIChatService } = await import('./scripts/airportPOIChatService.js');
            
            // ëª¨ë“  í…Œì´ë¸”ì˜ POIë¥¼ ë¡œë“œí•˜ì—¬ ê²€ìƒ‰ (ë©´ì„¸ì , ì‹ë‹¹, íœ´ì‹ê³µê°„ ë“± ëª¨ë“  ì¹´í…Œê³ ë¦¬ í¬í•¨)
            let allPOIsForSearch = new Map();
            
            // í˜„ì¬ allPOIsMapì— ìˆëŠ” POI ì¶”ê°€
            if (allPOIsMap.size > 0) {
              allPOIsMap.forEach((poi, id) => {
                allPOIsForSearch.set(id, poi);
              });
            }
            
            // ëª¨ë“  í…Œì´ë¸”ì—ì„œ POI ë¡œë“œ (ì‚¬ìš©ìê°€ ì–´ë–¤ ì§ˆì˜ë¥¼ í• ì§€ ëª¨ë¥´ë¯€ë¡œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ í¬í•¨)
            const allTables = ['meal_options_db_frame', 'shopping_options_db_frame', 'rests_db_frame', 'airport_events_db_frame'];
            
            try {
              await window.sqliteClient.initialize();
              
              for (const table of allTables) {
                try {
                  const pois = await window.sqliteClient.getTablePOIs(table, null); // ëª¨ë“  ì¹´í…Œê³ ë¦¬
                  pois.forEach(poi => {
                    // ì¤‘ë³µ ë°©ì§€: ê°™ì€ IDê°€ ì—†ì„ ë•Œë§Œ ì¶”ê°€
                    if (!allPOIsForSearch.has(poi.id)) {
                      allPOIsForSearch.set(poi.id, poi);
                    }
                  });
                } catch (tableError) {
                  console.warn(`[AI ì±„íŒ…] í…Œì´ë¸” ${table} ë¡œë“œ ì‹¤íŒ¨:`, tableError);
                  // ì¼ë¶€ í…Œì´ë¸” ë¡œë“œ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                }
              }
              
              console.log(`âœ… [AI ì±„íŒ…] ëª¨ë“  í…Œì´ë¸”ì—ì„œ POI ë¡œë“œ ì™„ë£Œ: ${allPOIsForSearch.size}ê°œ`);
            } catch (loadError) {
              console.warn('[AI ì±„íŒ…] ì „ì²´ POI ë¡œë“œ ì‹¤íŒ¨, í˜„ì¬ ë¡œë“œëœ POIë§Œ ì‚¬ìš©:', loadError);
              // ì‹¤íŒ¨í•´ë„ í˜„ì¬ ë¡œë“œëœ POIë¡œ ê²€ìƒ‰ ê³„ì† ì§„í–‰
            }
            
            if (allPOIsForSearch.size === 0) {
              loadingDiv.remove();
              addChatMessage('assistant', 'ì•„ì§ ì¥ì†Œ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
              return;
            }

            const recommendedPOIs = await airportPOIChatService.searchPOIsByNaturalLanguage(
              query,
              allPOIsForSearch,
              'ê³µí•­'
            );

            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            loadingDiv.remove();

            if (recommendedPOIs.length === 0) {
              addChatMessage('assistant', 'ì£„ì†¡í•©ë‹ˆë‹¤. ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.');
            } else {
              // ì¶”ì²œ POI í‘œì‹œ
              addChatMessage('assistant', `ë‹¤ìŒ ${recommendedPOIs.length}ê°œì˜ ì¥ì†Œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤:`, recommendedPOIs);
            }
          } catch (error) {
            console.error('AI ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            loadingDiv.remove();
            
            let errorMessage = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (error.message && error.message.includes('API í‚¤')) {
              errorMessage = 'OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            }
            addChatMessage('assistant', errorMessage);
          } finally {
            chatSend.disabled = false;
          }
        }

        function addChatMessage(role, message, recommendedPOIs = []) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `ai-message ai-message--${role}`;
          
          if (role === 'assistant' && recommendedPOIs.length > 0) {
            // ì¶”ì²œ POI ì¹´ë“œë“¤ ì¶”ê°€
            messageDiv.innerHTML = `<p>${message}</p>`;
            recommendedPOIs.forEach(poi => {
              const poiCard = createPOIRecommendationCard(poi);
              messageDiv.appendChild(poiCard);
            });
          } else {
            messageDiv.innerHTML = `<p>${message}</p>`;
          }

          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function createPOIRecommendationCard(poi) {
          const card = document.createElement('div');
          card.className = 'ai-poi-recommendation';
          
          // poi.idë¥¼ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„
          const safeId = String(poi.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
          
          card.innerHTML = `
            <h4>${poi.name || 'ì´ë¦„ ì—†ìŒ'}</h4>
            ${poi.aiReason ? `<p class="ai-poi-reason">ğŸ’¡ ${poi.aiReason}</p>` : ''}
            <div class="ai-poi-info">
              ${poi.category ? `<span>ì¹´í…Œê³ ë¦¬: ${poi.category}</span>` : ''}
              ${poi.location ? `<span>ğŸ“ ${poi.location}</span>` : ''}
            </div>
            <button class="ai-poi-select-btn" data-poi-id="${safeId}">ì„ íƒ</button>
          `;

          // ì„ íƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
          const selectBtn = card.querySelector('.ai-poi-select-btn');
          selectBtn.addEventListener('click', () => {
            selectPOIFromAI(poi);
          });

          return card;
        }

        function selectPOIFromAI(poi) {
          // POI ê°ì²´ë¥¼ allPOIsMapì— ë¨¼ì € ì¶”ê°€/ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ í…Œì´ë¸”ì—ì„œ ë¡œë“œëœ POIì¼ ìˆ˜ ìˆìŒ)
          if (poi && poi.id) {
            allPOIsMap.set(poi.id, poi);
            console.log('âœ… [AI ì±„íŒ…] POIë¥¼ allPOIsMapì— ì¶”ê°€:', { id: poi.id, name: poi.name });
          }
          
          // ê¸°ì¡´ selectPOISingle í•¨ìˆ˜ ì¬ì‚¬ìš©
          if (typeof selectPOISingle === 'function') {
            selectPOISingle(poi.id);
            // POI ìƒì„¸ ì •ë³´ë„ í‘œì‹œ
            if (typeof showPOIDetailSingle === 'function') {
              showPOIDetailSingle(poi);
            }
          } else {
            // í´ë°±: ì§ì ‘ ì„ íƒ ë¡œì§ ì‹¤í–‰
            if (!selectedPOIs.includes(poi.id)) {
              selectedPOIs.push(poi.id);
              updateSelectedPOIsList();
              if (typeof updatePreferencesPOINextButton === 'function') {
                updatePreferencesPOINextButton();
              }
              if (typeof showPOIDetailSingle === 'function') {
                showPOIDetailSingle(poi);
              }
              // Toast ë©”ì‹œì§€
              if (typeof showToast === 'function') {
                showToast({ message: `${poi.name}ì´(ê°€) ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, type: 'success' });
              } else {
                console.log(`${poi.name}ì´(ê°€) ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              }
            } else {
              if (typeof showToast === 'function') {
                showToast({ message: `ì´ë¯¸ ì„ íƒí•œ ì¥ì†Œì…ë‹ˆë‹¤: ${poi.name}`, type: 'warning' });
              }
            }
          }
        }
      }

      // ì¹´í…Œê³ ë¦¬ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸° (ê³µí•­ìš©)
      function getCategoryLabel(category) {
        const labels = {
          shopping: 'ì‡¼í•‘',
          food: 'ìŒì‹',
          culture: 'ë¬¸í™”ì²´í—˜',
          relax: 'íœ´ì‹',
          entertainment: 'ì—”í„°í…Œì¸ë¨¼íŠ¸',
          services: 'í¸ì˜ì‹œì„¤'
        };
        return labels[category] || category;
      }
    </script>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" style="display: none;">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p class="loading-message">ì¼ì •ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        <p class="loading-submessage">ìš´ì˜ ì‹œê°„ì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
      </div>
    </div>
    <script src="scripts/modal.js"></script>
  </body>
</html>
