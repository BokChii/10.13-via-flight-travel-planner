<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <meta name="openai-api-key" content="YOUR_OPENAI_API_KEY" />
    <meta name="supabase-url" content="https://qghwyrdxxlsigtputuyj.supabase.co" />
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnaHd5cmR4eGxzaWd0cHV0dXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MjIyNzIsImV4cCI6MjA3OTA5ODI3Mn0.8Ia_UCE-HYjZy2XX0VYEAKY2zGaN1QlvcTUlPPK8mxY" />
    <title>ì—¬í–‰ ìŠ¤íƒ€ì¼ ì„ íƒ - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/airport-main.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
    <link rel="stylesheet" href="styles/components/steps.css" />
  </head>
  <body class="app airport-main-page">
    <header class="app-header">
      <div>
        <h1>Via Flight</h1>
        <p class="tagline">ì–´ë–¤ ì—¬í–‰ì„ ì›í•˜ì‹œë‚˜ìš”?</p>
        <nav class="breadcrumb">
          <a href="transfer-info.html" class="breadcrumb__link">â† í™˜ìŠ¹ ì •ë³´ ìˆ˜ì •</a>
        </nav>
      </div>
      
      <!-- ì¸ì¦ UI -->
      <div class="auth-container">
        <div class="user-info-container" style="display: none;" title="í”„ë¡œí•„ ë³´ê¸°">
          <span class="user-info"></span>
          <span class="user-email"></span>
        </div>
        <button class="auth-button" data-action="login" onclick="window.loginWithGoogle()">
          Googleë¡œ ë¡œê·¸ì¸
        </button>
        <button class="auth-button" data-action="logout" style="display: none;" onclick="window.logout()">
          ë¡œê·¸ì•„ì›ƒ
        </button>
      </div>
    </header>

    <main class="airport-main-content">
      <!-- Progress Indicator -->
      <div class="progress-container">
        <div class="progress-steps">
          <div class="step completed">
            <div class="step-number">âœ“</div>
            <div class="step-label">í™˜ìŠ¹ ì •ë³´</div>
          </div>
          <div class="step active">
            <div class="step-number">2</div>
            <div class="step-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">ì¼ì • ìƒì„±</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 66%"></div>
        </div>
      </div>

      <!-- Transfer Summary -->
      <section class="transfer-summary">
        <div class="summary-card">
          <h2 class="summary-title" id="summary-title">í™˜ìŠ¹ ì •ë³´</h2>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">ê²½ìœ  ë„ì‹œ</span>
              <span class="summary-value" id="summary-city">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">í™˜ìŠ¹ ì‹œê°„</span>
              <span class="summary-value" id="summary-duration">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ë„ì°© ì‹œê°„</span>
              <span class="summary-value" id="summary-arrival">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ì¶œë°œ ì‹œê°„</span>
              <span class="summary-value" id="summary-departure">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Choice Section -->
      <section class="choice-section">
        <h2 class="choice-title">ì–´ë–¤ ì—¬í–‰ì„ ì›í•˜ì‹œë‚˜ìš”?</h2>
        <p class="choice-description">
          í™˜ìŠ¹ ì‹œê°„ ë™ì•ˆ ì–´ë–»ê²Œ ë³´ë‚´ê³  ì‹¶ìœ¼ì‹ ì§€ ì„ íƒí•´ì£¼ì„¸ìš”.<br>
          ì„ íƒì— ë”°ë¼ ë§ì¶¤í˜• ì¼ì •ì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.
        </p>

        <div class="choice-cards">
          <button class="choice-card" onclick="chooseAirportOnly()">
            <div class="choice-icon">âœˆï¸</div>
            <h3 class="choice-card-title">ê³µí•­ì—ë§Œ ìˆì„ë˜ìš”</h3>
            <p class="choice-card-description">
              ë©´ì„¸ì , ë¼ìš´ì§€, ë¬¸í™”ì²´í—˜ ë“±<br>
              ê³µí•­ ë‚´ë¶€ì—ì„œë§Œ ì¦ê¸°ëŠ” ì—¬í–‰
            </p>
            <div class="choice-features">
              <span class="feature-tag">ë©´ì„¸ì </span>
              <span class="feature-tag">ë¼ìš´ì§€</span>
              <span class="feature-tag">ë¬¸í™”ì²´í—˜</span>
              <span class="feature-tag">ì‹ë‹¹</span>
            </div>
            <div class="choice-benefits">
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ì…êµ­ ì‹¬ì‚¬ ë¶ˆí•„ìš”</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ì§ ë³´ê´€ì†Œ ì´ìš© ê°€ëŠ¥</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ì•ˆì „í•˜ê³  í¸ë¦¬í•¨</span>
              </div>
            </div>
          </button>

          <button class="choice-card" onclick="chooseAirportExternal()">
            <div class="choice-icon">ğŸŒ</div>
            <h3 class="choice-card-title">ê³µí•­ ë°–ì—ë„ ë‚˜ê°ˆë˜ìš”</h3>
            <p class="choice-card-description">
              ë„ì‹œ ê´€ê´‘ + ê³µí•­ ë‚´ë¶€<br>
              ë” í’ë¶€í•œ í™˜ìŠ¹ ì—¬í–‰ ê²½í—˜
            </p>
            <div class="choice-features">
              <span class="feature-tag">ë¡œì»¬ ë§›ì§‘</span>
              <span class="feature-tag">ê´€ê´‘ì§€</span>
              <span class="feature-tag">ì‡¼í•‘</span>
              <span class="feature-tag">ë¬¸í™”ì²´í—˜</span>
            </div>
            <div class="choice-benefits">
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ë¡œì»¬ ë¬¸í™” ì²´í—˜</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ë‹¤ì–‘í•œ í™œë™</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>íŠ¹ë³„í•œ ì¶”ì–µ</span>
              </div>
            </div>
          </button>

          <button class="choice-card choice-card--ai" onclick="openAIChat()">
            <div class="choice-icon">ğŸ¤–</div>
            <h3 class="choice-card-title">AIì™€ ëŒ€í™”í•˜ê¸°</h3>
            <p class="choice-card-description">
              AI ì—¬í–‰ í”Œë˜ë„ˆì™€ ëŒ€í™”í•˜ë©°<br>
              ìë™ìœ¼ë¡œ ë§ì¶¤ ì¼ì •ì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤
            </p>
            <div class="choice-features">
              <span class="feature-tag">ìë™ ì¶”ì²œ</span>
              <span class="feature-tag">ë§ì¶¤ ì¼ì •</span>
              <span class="feature-tag">ë¹ ë¥¸ ìƒì„±</span>
              <span class="feature-tag">ìŠ¤ë§ˆíŠ¸</span>
            </div>
            <div class="choice-benefits">
              <div class="benefit-item">
                <span class="benefit-icon">âœ¨</span>
                <span>ê°„ë‹¨í•œ ëŒ€í™”ë¡œ ì¼ì • ìƒì„±</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ¨</span>
                <span>ì„ í˜¸ë„ ìë™ íŒŒì•…</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ¨</span>
                <span>ìµœì ì˜ ì¥ì†Œ ì¶”ì²œ</span>
              </div>
            </div>
          </button>
        </div>
      </section>

      <!-- AI Chat Modal -->
      <div class="ai-chat-modal" id="ai-chat-modal" style="display: none;">
        <div class="ai-chat-container">
          <div class="ai-chat-header">
            <div class="ai-chat-header-content">
              <div class="ai-chat-avatar">ğŸ¤–</div>
              <div>
                <h3>AI ì—¬í–‰ í”Œë˜ë„ˆ</h3>
                <p>ì›í•˜ì‹œëŠ” ì—¬í–‰ ìŠ¤íƒ€ì¼ì„ ë§ì”€í•´ì£¼ì„¸ìš”!</p>
              </div>
            </div>
            <button class="ai-chat-close" onclick="closeAIChat()">Ã—</button>
          </div>
          
          <div class="ai-chat-messages" id="ai-chat-messages">
            <div class="ai-message">
              <div class="message-avatar">ğŸ¤–</div>
              <div class="message-content">
                <p>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” AI ì—¬í–‰ í”Œë˜ë„ˆì…ë‹ˆë‹¤. ğŸ‰</p>
                <p>í™˜ìŠ¹ ì‹œê°„ ë™ì•ˆ ë¬´ì—‡ì„ í•˜ê³  ì‹¶ìœ¼ì‹ ì§€ ë§ì”€í•´ì£¼ì‹œë©´, ìµœì ì˜ ì¼ì •ì„ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë¦´ê²Œìš”!</p>
                <p><strong>ì˜ˆì‹œ:</strong></p>
                <ul class="example-messages">
                  <li>"ì‹±ê°€í¬ë¥´ì—ì„œ 4ì‹œê°„ ë™ì•ˆ ì‡¼í•‘í•˜ê³  ë§›ìˆëŠ” ìŒì‹ ë¨¹ê³  ì‹¶ì–´"</li>
                  <li>"ê³µí•­ì—ì„œ íœ´ì‹í•˜ê³  ë¬¸í™”ì²´í—˜ í•˜ê³  ì‹¶ì–´"</li>
                  <li>"ë„ì‹œ ë‚˜ê°€ì„œ ê´€ê´‘ì§€ ë³´ê³  ë¡œì»¬ ë§›ì§‘ ê°€ê³  ì‹¶ì–´"</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="ai-chat-input-container">
            <div class="ai-chat-input-wrapper">
              <input 
                type="text" 
                id="ai-chat-input" 
                class="ai-chat-input" 
                placeholder="ì›í•˜ì‹œëŠ” ì—¬í–‰ ìŠ¤íƒ€ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."
                onkeypress="handleAIChatKeyPress(event)"
              />
              <button class="ai-chat-send" onclick="sendAIMessage()" id="ai-chat-send-btn">
                <span>ì „ì†¡</span>
              </button>
            </div>
            <div class="ai-chat-loading" id="ai-chat-loading" style="display: none;">
              <div class="loading-spinner"></div>
              <span>AIê°€ ì¼ì •ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommendations Section -->
      <section class="recommendations-section">
        <h3 class="recommendations-title">ğŸ’¡ ì¶”ì²œ ì •ë³´</h3>
        <div class="recommendations-grid">
          <div class="recommendation-card">
            <h4>ê³µí•­ì—ì„œ ë­í•˜ì§€?</h4>
            <div class="recommendation-items">
              <div class="recommendation-item">
                <span class="item-icon">ğŸ›ï¸</span>
                <span>ë©´ì„¸ì  ì‡¼í•‘</span>
              </div>
              <div class="recommendation-item">
                <span class="item-icon">ğŸ½ï¸</span>
                <span>ê³µí•­ ë§›ì§‘</span>
              </div>
              <div class="recommendation-item">
                <span class="item-icon">ğŸ¨</span>
                <span>ë¬¸í™”ì²´í—˜</span>
              </div>
              <div class="recommendation-item">
                <span class="item-icon">ğŸ’†</span>
                <span>ìŠ¤íŒŒ & ë§ˆì‚¬ì§€</span>
              </div>
            </div>
          </div>

          <div class="recommendation-card">
            <h4>ë² ìŠ¤íŠ¸ í™˜ìŠ¹ ì—¬í–‰ ì½”ìŠ¤</h4>
            <div class="course-list">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <div class="recommendation-card">
            <h4>ğŸ“ ë‹¤ë¥¸ ì—¬í–‰ìë“¤ì˜ ë¦¬ë·°</h4>
            <div class="reviews-sort-container">
              <label for="review-sort-select">ì •ë ¬:</label>
              <select id="review-sort-select" class="review-sort-select" onchange="applySort()">
                <option value="latest">ìµœì‹ ìˆœ</option>
                <option value="rating-desc">í‰ì  ë†’ì€ìˆœ</option>
                <option value="rating-asc">í‰ì  ë‚®ì€ìˆœ</option>
              </select>
            </div>
            <div class="reviews-container" id="city-reviews-container">
              <div class="reviews-loading" style="display: none;">
                <p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
              <div class="reviews-list" id="city-reviews-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
              </div>
              <div class="reviews-empty" id="city-reviews-empty" style="display: none;">
                <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script type="module" src="scripts/supabaseClient.js"></script>
    <script type="module" src="scripts/router.js"></script>
    <script type="module" src="scripts/userProfile.js"></script>
    <script type="module" src="scripts/auth.js"></script>
    <script src="scripts/sqliteClient.js"></script>
    <script type="module" src="scripts/reviewDB.js"></script>
    <script type="module" src="scripts/airportPOIService.js"></script>
    <script type="module" src="scripts/cityPOIService.js"></script>
    <script type="module" src="scripts/poiServiceManager.js"></script>
    <script type="module" src="scripts/aiPlannerService.js"></script>
    <script type="module">
      import { getOpenAIApiKey } from './scripts/config.js';
      window.getOpenAIApiKey = getOpenAIApiKey;
    </script>
    <script>
      // ì „ì—­ ìƒíƒœ
      let transferInfo = null;
      let selectedChoice = null;
      
      // ë¦¬ë·° ê´€ë ¨ ìƒíƒœ (ìµœì†Œí•œì˜ ì „ì—­ ë³€ìˆ˜)
      let allCityReviews = []; // ì „ì²´ ë¦¬ë·° ì €ì¥
      let showingAllReviews = false; // ì „ì²´ ë³´ê¸° ì—¬ë¶€
      let currentSortType = 'latest'; // í˜„ì¬ ì •ë ¬ íƒ€ì…

      // í™œë™ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
      const ACTIVITY_CATEGORIES = {
        'shopping': {
          tableName: 'shopping_options_db_frame',
          icon: 'ğŸ›ï¸',
          label: 'ë©´ì„¸ì  ì‡¼í•‘',
          displayOrder: 1
        },
        'food': {
          tableName: 'meal_options_db_frame',
          icon: 'ğŸ½ï¸',
          label: 'ê³µí•­ ë§›ì§‘',
          displayOrder: 2
        },
        'culture': {
          tableName: 'airport_events_db_frame',
          icon: 'ğŸ¨',
          label: 'ë¬¸í™”ì²´í—˜',
          displayOrder: 3
        },
        'relax': {
          tableName: 'rests_db_frame',
          icon: 'ğŸ’†',
          label: 'ìŠ¤íŒŒ & ë§ˆì‚¬ì§€',
          displayOrder: 4
        }
      };

      // í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ìŠ¹ ì •ë³´ í‘œì‹œ
      document.addEventListener('DOMContentLoaded', async function() {
        // Auth0 ì´ˆê¸°í™”
        try {
          const { initAuth } = await import('./scripts/auth.js');
          await initAuth();
        } catch (error) {
          console.error('Auth0 ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        }
        
        loadTransferInfo();
        updateSummary();
        
        // ê³µí•­ í™œë™ ë° ì¶”ì²œ ì½”ìŠ¤ ë¡œë“œ (ë¹„ë™ê¸°)
        await loadAirportActivities();
        renderRecommendationCourses();
        
        // ë™ì¼ ë„ì‹œ ë¦¬ë·° ë¡œë“œ
        await loadCityReviews();
        
        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        setTimeout(() => {
          document.querySelector('.transfer-summary').style.opacity = '1';
          document.querySelector('.transfer-summary').style.transform = 'translateY(0)';
        }, 300);
        
        setTimeout(() => {
          document.querySelector('.choice-section').style.opacity = '1';
          document.querySelector('.choice-section').style.transform = 'translateY(0)';
        }, 600);
        
        setTimeout(() => {
          document.querySelector('.recommendations-section').style.opacity = '1';
          document.querySelector('.recommendations-section').style.transform = 'translateY(0)';
        }, 900);
      });

      // í™˜ìŠ¹ ì •ë³´ ë¡œë“œ
      function loadTransferInfo() {
        const state = window.getAppState();
        if (state.transferInfo) {
          transferInfo = state.transferInfo;
        } else {
          // ê¸°ë³¸ê°’ ì„¤ì •
          transferInfo = {
            city: 'ì„œìš¸',
            arrival: new Date(),
            departure: new Date(Date.now() + 4 * 60 * 60 * 1000),
            duration: 4 * 60 * 60 * 1000
          };
        }
      }

      // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateSummary() {
        if (!transferInfo) return;

        document.getElementById('summary-city').textContent = transferInfo.city;
        document.getElementById('summary-duration').textContent = formatDuration(transferInfo.duration);
        document.getElementById('summary-arrival').textContent = formatDateTime(transferInfo.arrival);
        document.getElementById('summary-departure').textContent = formatDateTime(transferInfo.departure);
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatDuration(durationMs) {
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let result = '';
        if (hours > 0) result += `${hours}ì‹œê°„`;
        if (minutes > 0) result += ` ${minutes}ë¶„`;
        
        return result || '0ë¶„';
      }

      // ë‚ ì§œ ì‹œê°„ í¬ë§·íŒ…
      function formatDateTime(date) {
        if (!date) return '-';
        
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        
        return `${year}.${month}.${day} ${hours}:${minutes}`;
      }

      // ê³µí•­ì—ë§Œ ìˆì„ë˜ìš” ì„ íƒ
      function chooseAirportOnly() {
        selectedChoice = 'airport-only';
        
        // ì„ íƒ ìƒíƒœ í‘œì‹œ
        document.querySelectorAll('.choice-card').forEach(card => {
          card.classList.remove('selected');
        });
        event.target.closest('.choice-card').classList.add('selected');
        
        // ë¼ìš°í„°ë¥¼ í†µí•´ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.navigateTo('/airport-only', { userChoice: selectedChoice });
        }, 500);
      }

      // ê³µí•­ ë°–ì—ë„ ë‚˜ê°ˆë˜ìš” ì„ íƒ
      async function chooseAirportExternal() {
        // ë¡œê·¸ì¸ í™•ì¸
        if (window.requireAuth) {
          const authenticated = await window.requireAuth('ê³µí•­ ë°–ìœ¼ë¡œ ë‚˜ê°€ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          if (!authenticated) {
            return; // ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì§„í–‰í•˜ì§€ ì•ŠìŒ
          }
        }
        
        selectedChoice = 'airport-external';
        
        // ì„ íƒ ìƒíƒœ í‘œì‹œ
        document.querySelectorAll('.choice-card').forEach(card => {
          card.classList.remove('selected');
        });
        if (event && event.target) {
          event.target.closest('.choice-card')?.classList.add('selected');
        }
        
        // ë¼ìš°í„°ë¥¼ í†µí•´ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.navigateTo('/airport-external', { userChoice: selectedChoice });
        }, 500);
      }

      // AI ì±„íŒ… ì—´ê¸°
      function openAIChat() {
        const modal = document.getElementById('ai-chat-modal');
        if (modal) {
          modal.style.display = 'flex';
          // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
          setTimeout(() => {
            const input = document.getElementById('ai-chat-input');
            if (input) input.focus();
          }, 100);
        }
      }

      // AI ì±„íŒ… ë‹«ê¸°
      function closeAIChat() {
        const modal = document.getElementById('ai-chat-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // AI ì±„íŒ… ì—”í„° í‚¤ ì²˜ë¦¬
      function handleAIChatKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendAIMessage();
        }
      }

      // AI ë©”ì‹œì§€ ì „ì†¡
      async function sendAIMessage() {
        const input = document.getElementById('ai-chat-input');
        const sendBtn = document.getElementById('ai-chat-send-btn');
        const loadingEl = document.getElementById('ai-chat-loading');
        const messagesEl = document.getElementById('ai-chat-messages');
        
        if (!input || !input.value.trim()) return;
        
        const userMessage = input.value.trim();
        input.value = '';
        sendBtn.disabled = true;
        
        // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        const userMsgEl = document.createElement('div');
        userMsgEl.className = 'user-message';
        userMsgEl.innerHTML = `
          <div class="message-content">
            <p>${escapeHtml(userMessage)}</p>
          </div>
          <div class="message-avatar">ğŸ‘¤</div>
        `;
        messagesEl.appendChild(userMsgEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        
        // ë¡œë”© í‘œì‹œ
        loadingEl.style.display = 'flex';
        
        try {
          // AI í”Œë˜ë„ˆ ì„œë¹„ìŠ¤ í˜¸ì¶œ
          if (!window.aiPlannerService) {
            throw new Error('AI í”Œë˜ë„ˆ ì„œë¹„ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          }
          
          const result = await window.aiPlannerService.generatePlanFromChat(userMessage, transferInfo);
          
          // AI ì‘ë‹µ í‘œì‹œ
          const aiMsgEl = document.createElement('div');
          aiMsgEl.className = 'ai-message';
          
          // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
          const messageHtml = markdownToHtml(result.message);
          
          aiMsgEl.innerHTML = `
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
              ${messageHtml}
              ${result.recommendations ? `
                <div class="ai-recommendations">
                  <p><strong>ì¶”ì²œ ì¼ì •:</strong></p>
                  <ul>
                    ${result.recommendations.map(rec => `<li>${escapeHtml(rec)}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          `;
          messagesEl.appendChild(aiMsgEl);
          messagesEl.scrollTop = messagesEl.scrollHeight;
          
          // ì¼ì • ìƒì„± ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ ì¼ì • í˜ì´ì§€ë¡œ ì´ë™
          if (result.planGenerated && result.planData) {
            setTimeout(() => {
              loadingEl.innerHTML = '<div class="loading-spinner"></div><span>ì¼ì •ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>';
              
              // ì¼ì • ë°ì´í„°ë¥¼ sessionStorageì— ì €ì¥
              if (result.planData.airportPOIs && result.planData.airportPOIs.length > 0) {
                // airportPOIData í˜•ì‹ìœ¼ë¡œ ì €ì¥
                const airportPOIData = {
                  selectedPOIs: result.planData.airportPOIs.map(poi => poi.id),
                  allPOIs: result.planData.airportPOIs,
                  selectedTable: getTableNameFromCategories(result.planData.selectedCategories.airport),
                  selectedTypes: result.planData.selectedCategories.airport
                };
                sessionStorage.setItem('airportPOIData', JSON.stringify(airportPOIData));
                console.log('âœ… ê³µí•­ POI ë°ì´í„° ì €ì¥:', airportPOIData);
              }
              
              if (result.planData.cityPOIs && result.planData.cityPOIs.length > 0) {
                // cityPOIData í˜•ì‹ìœ¼ë¡œ ì €ì¥
                const cityPOIData = {
                  selectedPOIs: result.planData.cityPOIs.map(poi => poi.id || poi.place_id),
                  allPOIs: result.planData.cityPOIs,
                  selectedCategories: result.planData.selectedCategories.city || []
                };
                sessionStorage.setItem('cityPOIData', JSON.stringify(cityPOIData));
                console.log('âœ… ë„ì‹œ POI ë°ì´í„° ì €ì¥:', cityPOIData);
              }
              
              // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì •ë³´ë„ ì €ì¥
              if (result.planData.selectedCategories) {
                sessionStorage.setItem('aiSelectedCategories', JSON.stringify(result.planData.selectedCategories));
              }
              
              // AIë¡œ ìƒì„±ëœ ì¼ì •ì„ì„ í‘œì‹œ
              sessionStorage.setItem('aiGeneratedPlan', 'true');
              
              // ì¼ì • ìƒì„± ì™„ë£Œ ë©”ì‹œì§€
              setTimeout(() => {
                const successMsg = document.createElement('div');
                successMsg.className = 'ai-message';
                successMsg.innerHTML = `
                  <div class="message-avatar">ğŸ¤–</div>
                  <div class="message-content">
                    <p>âœ… ì¼ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                    <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¼ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.</p>
                    <button class="ai-go-to-plan-btn" onclick="goToPlanPage('${result.planData.type}')">
                      ğŸ“… ì¼ì • í™•ì¸í•˜ê¸°
                    </button>
                  </div>
                `;
                messagesEl.appendChild(successMsg);
                messagesEl.scrollTop = messagesEl.scrollHeight;
              }, 1000);
            }, 1500);
          }
          
        } catch (error) {
          console.error('AI ì¼ì • ìƒì„± ì‹¤íŒ¨:', error);
          
          const errorMsg = document.createElement('div');
          errorMsg.className = 'ai-message';
          errorMsg.innerHTML = `
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
              <p>ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì • ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
              <p style="font-size: 0.9rem; color: #666; margin-top: 8px;">ì˜¤ë¥˜: ${escapeHtml(error.message)}</p>
            </div>
          `;
          messagesEl.appendChild(errorMsg);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        } finally {
          loadingEl.style.display = 'none';
          sendBtn.disabled = false;
          input.focus();
        }
      }

      // ë’¤ë¡œê°€ê¸°
      function goBack() {
        window.goBack();
      }

      // ê³µí•­ í™œë™ í†µê³„ ë¡œë“œ
      async function loadAirportActivities() {
        const container = document.querySelector('.recommendation-items');
        if (!container) return;

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const originalHTML = container.innerHTML;
        container.innerHTML = '<div class="loading-activities">ë¡œë”© ì¤‘...</div>';

        try {
          // SQLite í´ë¼ì´ì–¸íŠ¸ í™•ì¸ (sqliteClient.jsì—ì„œ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±)
          if (!window.sqliteClient) {
            console.warn('SQLite í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return; // ì›ë˜ HTML ìœ ì§€
          }

          await window.sqliteClient.initialize();

          // ëª¨ë“  ì¹´í…Œê³ ë¦¬ í†µê³„ ë³‘ë ¬ ì¡°íšŒ
          const activityPromises = Object.entries(ACTIVITY_CATEGORIES).map(
            async ([key, category]) => {
              try {
                const pois = await window.sqliteClient.getTablePOIs(category.tableName);
                return {
                  key,
                  ...category,
                  count: pois.length,
                  available: pois.length > 0
                };
              } catch (error) {
                console.error(`${category.label} ì¡°íšŒ ì‹¤íŒ¨:`, error);
                return {
                  key,
                  ...category,
                  count: 0,
                  available: false
                };
              }
            }
          );

          const activities = await Promise.all(activityPromises);
          
          // ì‚¬ìš© ê°€ëŠ¥í•œ í™œë™ë§Œ í•„í„°ë§ ë° ì •ë ¬
          const availableActivities = activities
            .filter(a => a.available)
            .sort((a, b) => a.displayOrder - b.displayOrder);

          if (availableActivities.length === 0) {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì›ë˜ HTML ìœ ì§€
            container.innerHTML = originalHTML;
            return;
          }

          renderAirportActivities(availableActivities);

        } catch (error) {
          console.error('ê³µí•­ í™œë™ ë¡œë“œ ì‹¤íŒ¨:', error);
          // ì—ëŸ¬ ë°œìƒ ì‹œ ì›ë˜ HTML ìœ ì§€
          container.innerHTML = originalHTML;
        }
      }

      // ê³µí•­ í™œë™ ë Œë”ë§
      function renderAirportActivities(activities) {
        const container = document.querySelector('.recommendation-items');
        if (!container) return;

        container.innerHTML = activities.map(activity => `
          <div class="recommendation-item clickable" 
               data-table="${activity.tableName}" 
               data-category-key="${activity.key}"
               role="button"
               tabindex="0"
               aria-label="${activity.label} - ${activity.count}ê°œ ì¥ì†Œ">
            <span class="item-icon">${activity.icon}</span>
            <span class="item-label">${activity.label}</span>
            <span class="item-count">${activity.count}ê°œ</span>
          </div>
        `).join('');

        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        attachActivityClickHandlers(container);
      }

      // í™œë™ í´ë¦­ í•¸ë“¤ëŸ¬ ì—°ê²°
      function attachActivityClickHandlers(container) {
        container.querySelectorAll('.recommendation-item.clickable').forEach(item => {
          // í´ë¦­ ì´ë²¤íŠ¸
          item.addEventListener('click', function() {
            handleActivityClick(this);
          });

          // í‚¤ë³´ë“œ ì ‘ê·¼ì„± (Enter, Space)
          item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleActivityClick(this);
            }
          });
        });
      }

      // í™œë™ í´ë¦­ ì²˜ë¦¬
      function handleActivityClick(element) {
        const tableName = element.dataset.table;
        const categoryKey = element.dataset.categoryKey;

        // í´ë¦­ íš¨ê³¼
        element.style.transform = 'scale(0.95)';
        setTimeout(() => {
          element.style.transform = '';
        }, 150);

        // sessionStorageì— ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
        sessionStorage.setItem('preSelectedTable', tableName);
        sessionStorage.setItem('preSelectedCategory', categoryKey);

        // airport-only í˜ì´ì§€ë¡œ ì´ë™
        if (window.navigateTo) {
          window.navigateTo('/airport-only', { 
            userChoice: 'airport-only',
            preSelectedTable: tableName,
            preSelectedCategory: categoryKey
          });
        } else {
          // í´ë°±: ì§ì ‘ URL ì´ë™
          window.location.href = `airport-only.html`;
        }
      }

      // í™˜ìŠ¹ ì‹œê°„ë³„ ì¶”ì²œ ì½”ìŠ¤ ìƒì„±
      function generateRecommendationCourses() {
        if (!transferInfo || !transferInfo.duration) {
          return getDefaultCourses();
        }

        const durationHours = transferInfo.duration / (1000 * 60 * 60);
        
        let courses = [];
        
        if (durationHours < 2) {
          // 2ì‹œê°„ ë¯¸ë§Œ: ë¹ ë¥¸ í™œë™ë§Œ
          courses = [
            { time: '1-2ì‹œê°„', title: 'ë¹ ë¥¸ ì‡¼í•‘ & ê°„ì‹', description: 'ë©´ì„¸ì  + ì¹´í˜', recommended: true }
          ];
        } else if (durationHours < 4) {
          // 2-4ì‹œê°„: ê³µí•­ ë‚´ë¶€ íƒí—˜
          courses = [
            { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€', recommended: true }
          ];
        } else if (durationHours < 6) {
          // 4-6ì‹œê°„: ë„ì‹œ ë‚˜ë“¤ì´ ê°€ëŠ¥
          courses = [
            { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€' },
            { time: '4-6ì‹œê°„', title: 'ë„ì‹œ ë‚˜ë“¤ì´', description: 'ëª…ì†Œ + ë§›ì§‘ + ì‡¼í•‘', recommended: true }
          ];
        } else {
          // 6ì‹œê°„ ì´ìƒ: í†µí•© ì—¬í–‰
          courses = [
            { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€' },
            { time: '4-6ì‹œê°„', title: 'ë„ì‹œ ë‚˜ë“¤ì´', description: 'ëª…ì†Œ + ë§›ì§‘ + ì‡¼í•‘' },
            { time: '6ì‹œê°„+', title: 'í†µí•© ì—¬í–‰', description: 'ê³µí•­ + ë„ì‹œ + ë¬¸í™”ì²´í—˜', recommended: true }
          ];
        }

        return courses;
      }

      // ê¸°ë³¸ ì½”ìŠ¤ (í™˜ìŠ¹ ì •ë³´ê°€ ì—†ì„ ë•Œ)
      function getDefaultCourses() {
        return [
          { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€' },
          { time: '4-6ì‹œê°„', title: 'ë„ì‹œ ë‚˜ë“¤ì´', description: 'ëª…ì†Œ + ë§›ì§‘ + ì‡¼í•‘' },
          { time: '6ì‹œê°„+', title: 'í†µí•© ì—¬í–‰', description: 'ê³µí•­ + ë„ì‹œ + ë¬¸í™”ì²´í—˜' }
        ];
      }

      // ì¶”ì²œ ì½”ìŠ¤ ë Œë”ë§
      function renderRecommendationCourses() {
        const container = document.querySelector('.course-list');
        if (!container) return;

        const courses = generateRecommendationCourses();
        
        container.innerHTML = courses.map(course => {
          const recommendedBadge = course.recommended 
            ? '<span class="recommended-badge">ì¶”ì²œ</span>' 
            : '';
          
          return `
            <div class="course-item ${course.recommended ? 'recommended' : ''}">
              <div class="course-time">${course.time}</div>
              <div class="course-content">
                <strong>${course.title} ${recommendedBadge}</strong>
                <p>${course.description}</p>
              </div>
            </div>
          `;
        }).join('');
      }

      // ë„ì‹œ ì´ë¦„ ì •ê·œí™” í•¨ìˆ˜
      function normalizeCityName(city) {
        if (!city) return '';
        
        const cityNameMap = {
          'ì‹±ê°€í¬ë¥´': 'Singapore',
          'Singapore': 'Singapore',
          'ì„œìš¸': 'Seoul',
          'Seoul': 'Seoul',
          'ë„ì¿„': 'Tokyo',
          'Tokyo': 'Tokyo',
          'ë°©ì½•': 'Bangkok',
          'Bangkok': 'Bangkok'
        };
        
        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
        if (cityNameMap[city]) {
          return cityNameMap[city];
        }
        
        // ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë§¤ì¹­
        const cityLower = city.toLowerCase();
        for (const [key, value] of Object.entries(cityNameMap)) {
          if (key.toLowerCase() === cityLower) {
            return value;
          }
        }
        
        // ë§¤í•‘ë˜ì§€ ì•Šìœ¼ë©´ ì›ë³¸ ë°˜í™˜
        return city;
      }

      // ë™ì¼ ë„ì‹œ ë¦¬ë·° ë¡œë“œ
      async function loadCityReviews() {
        const container = document.getElementById('city-reviews-list');
        const loadingEl = document.querySelector('.reviews-loading');
        const emptyEl = document.getElementById('city-reviews-empty');
        
        if (!container) {
          console.warn('âš ï¸ [loadCityReviews] ë¦¬ë·° ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ë„ì‹œ ì •ë³´ í™•ì¸
        if (!transferInfo || !transferInfo.city) {
          console.warn('âš ï¸ [loadCityReviews] ë„ì‹œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤:', transferInfo);
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        // ë„ì‹œ ì´ë¦„ ì •ê·œí™”
        const normalizedCity = normalizeCityName(transferInfo.city);

        try {
          // ë¡œë”© í‘œì‹œ
          if (loadingEl) loadingEl.style.display = 'block';
          if (emptyEl) emptyEl.style.display = 'none';
          container.innerHTML = '';

          // ë¦¬ë·° DB ì´ˆê¸°í™”
          await window.reviewDB.initialize();
          
          // ì •ê·œí™”ëœ ë„ì‹œ ì´ë¦„ìœ¼ë¡œ ë¦¬ë·° ì¡°íšŒ
          const reviews = await window.reviewDB.getCityReviews(normalizedCity);

          if (loadingEl) loadingEl.style.display = 'none';

          if (!reviews || reviews.length === 0) {
            if (emptyEl) emptyEl.style.display = 'block';
            return;
          }

          // ì •ë ¬ ì ìš©
          currentSortType = 'latest'; // ê¸°ë³¸ ì •ë ¬
          const sortedReviews = sortReviews(reviews, currentSortType);
          
          // ì „ì²´ ë¦¬ë·° ì €ì¥ (ì •ë ¬ëœ ë²„ì „)
          allCityReviews = sortedReviews;
          showingAllReviews = false; // ì´ˆê¸°í™”

          // 3ê°œë§Œ í‘œì‹œ
          const displayReviews = sortedReviews.slice(0, 3);
          const hasMore = sortedReviews.length > 3;

          await renderCityReviews(displayReviews, hasMore);

        } catch (error) {
          console.error('âŒ [loadCityReviews] ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:', error);
          console.error('âŒ [loadCityReviews] ì—ëŸ¬ ìƒì„¸:', {
            message: error.message,
            stack: error.stack,
            city: transferInfo.city,
            normalizedCity: normalizedCity
          });
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) emptyEl.style.display = 'block';
        }
      }

      // ë„ì‹œ ë¦¬ë·° ë Œë”ë§
      async function renderCityReviews(reviews, hasMore = false) {
        const container = document.getElementById('city-reviews-list');
        if (!container) return;

        // ë¦¬ë·° HTML ìƒì„± (ë¹„ë™ê¸° ì²˜ë¦¬)
        const reviewsHtmlPromises = reviews.map(async (review) => {
          // ë³„ì  ìƒì„±
          const rating = review.overall_review_rating || 0;
          const stars = 'â­'.repeat(rating);
          
          // ë‚ ì§œ í¬ë§·íŒ…
          const reviewDate = new Date(review.submitted_at);
          const formattedDate = formatReviewDate(reviewDate);
          
          // ì—¬í–‰ íƒ€ì… í‘œì‹œ
          const tripTypeText = review.trip_info_trip_type === 'airport-only' 
            ? 'ê³µí•­ ë‚´ë¶€ë§Œ' 
            : review.trip_info_trip_type === 'airport-external' 
            ? 'ê³µí•­ + ë„ì‹œ' 
            : 'ì „ì²´';
          
          // í™˜ìŠ¹ ì‹œê°„ í‘œì‹œ
          const durationText = review.trip_info_duration 
            ? formatDuration(review.trip_info_duration) 
            : '';

          // ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ (ë¹„ë™ê¸°)
          const isLiked = await checkIfLiked(review.id);
          const likeCount = await getLikeCount(review.id);
          
          // ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
          let authorName = 'ìµëª… ì‚¬ìš©ì';
          if (review.user_id && window.getUserNickname) {
            try {
              authorName = await window.getUserNickname(review.user_id) || 'ìµëª… ì‚¬ìš©ì';
            } catch (e) {
              console.warn('ì‘ì„±ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', e);
            }
          }

          return `
            <div class="review-card-item" onclick="viewReviewDetail('${review.id}')" style="cursor: pointer;">
              <div class="review-card-header">
                <div class="review-rating">
                  <span class="review-stars">${stars}</span>
                  <span class="review-rating-number">${rating}.0</span>
                </div>
                <div class="review-header-right">
                  <span class="review-author">âœï¸ ${escapeHtml(authorName)}</span>
                  <span class="review-date">${formattedDate}</span>
                </div>
              </div>
              <div class="review-summary">${escapeHtml(review.overall_review_summary || '')}</div>
              ${review.overall_review_detail ? `<div class="review-detail">${escapeHtml(review.overall_review_detail)}</div>` : ''}
              <div class="review-meta">
                <span class="review-trip-type">${tripTypeText}</span>
                ${durationText ? `<span class="review-duration">${durationText}</span>` : ''}
                ${review.trip_info_visit_count ? `<span class="review-visit-count">${review.trip_info_visit_count}ê°œ ì¥ì†Œ ë°©ë¬¸</span>` : ''}
              </div>
              <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
              <div class="review-actions" onclick="event.stopPropagation(); toggleLike('${review.id}')">
                <button class="btn-like ${isLiked ? 'liked' : ''}" id="like-btn-${review.id}">
                  <span class="like-icon">${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                  <span class="like-count" id="like-count-${review.id}">${likeCount}</span>
                </button>
              </div>
            </div>
          `;
        });
        
        // ëª¨ë“  Promise í•´ê²° í›„ HTML ì¡°ì¸
        const reviewsHtml = (await Promise.all(reviewsHtmlPromises)).join('');

        // "ë” ë³´ê¸°" ë²„íŠ¼ ì¶”ê°€
        let moreButtonHtml = '';
        if (hasMore) {
          const remainingCount = allCityReviews.length - reviews.length;
          moreButtonHtml = `
            <div class="reviews-more-container">
              <button class="btn btn--ghost btn--small" onclick="showAllReviews()">
                ë” ë³´ê¸° (${remainingCount}ê°œ ë”)
              </button>
            </div>
          `;
        }

        container.innerHTML = reviewsHtml + moreButtonHtml;
      }

      // ì •ë ¬ í•¨ìˆ˜
      function sortReviews(reviews, sortType) {
        const sorted = [...reviews]; // ë³µì‚¬ë³¸ ìƒì„±
        
        switch (sortType) {
          case 'latest':
            return sorted.sort((a, b) => {
              const dateA = new Date(a.submitted_at);
              const dateB = new Date(b.submitted_at);
              return dateB - dateA; // ìµœì‹ ìˆœ
            });
          
          case 'rating-desc':
            return sorted.sort((a, b) => {
              const ratingA = a.overall_review_rating || 0;
              const ratingB = b.overall_review_rating || 0;
              if (ratingB !== ratingA) {
                return ratingB - ratingA; // í‰ì  ë†’ì€ìˆœ
              }
              // í‰ì ì´ ê°™ìœ¼ë©´ ìµœì‹ ìˆœ
              return new Date(b.submitted_at) - new Date(a.submitted_at);
            });
          
          case 'rating-asc':
            return sorted.sort((a, b) => {
              const ratingA = a.overall_review_rating || 0;
              const ratingB = b.overall_review_rating || 0;
              if (ratingA !== ratingB) {
                return ratingA - ratingB; // í‰ì  ë‚®ì€ìˆœ
              }
              // í‰ì ì´ ê°™ìœ¼ë©´ ìµœì‹ ìˆœ
              return new Date(b.submitted_at) - new Date(a.submitted_at);
            });
          
          default:
            return sorted;
        }
      }

      // ì •ë ¬ ì ìš© í•¨ìˆ˜
      async function applySort() {
        const sortSelect = document.getElementById('review-sort-select');
        if (!sortSelect) return;
        
        currentSortType = sortSelect.value;
        showingAllReviews = false; // ì •ë ¬ ë³€ê²½ ì‹œ ì´ˆê¸°í™”
        
        // ì›ë³¸ ë¦¬ë·° ê°€ì ¸ì˜¤ê¸° (DBì—ì„œ ë‹¤ì‹œ ì¡°íšŒí•˜ì—¬ ì›ë³¸ ë°ì´í„° í™•ë³´)
        const normalizedCity = normalizeCityName(transferInfo.city);
        const originalReviews = await window.reviewDB.getCityReviews(normalizedCity);
        
        // ì •ë ¬ ì ìš©
        const sortedReviews = sortReviews(originalReviews, currentSortType);
        allCityReviews = sortedReviews;
        
        // 3ê°œë§Œ í‘œì‹œ
        const displayReviews = sortedReviews.slice(0, 3);
        const hasMore = sortedReviews.length > 3;
        
        renderCityReviews(displayReviews, hasMore);
      }

      // ì „ì²´ ë¦¬ë·° í‘œì‹œ
      async function showAllReviews() {
        showingAllReviews = true;
        await renderCityReviews(allCityReviews, false);
      }

      // ë‚ ì§œ í¬ë§·íŒ… (ë¦¬ë·°ìš©)
      function formatReviewDate(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
          return 'ì˜¤ëŠ˜';
        } else if (diffDays === 1) {
          return 'ì–´ì œ';
        } else if (diffDays < 7) {
          return `${diffDays}ì¼ ì „`;
        } else if (diffDays < 30) {
          const weeks = Math.floor(diffDays / 7);
          return `${weeks}ì£¼ ì „`;
        } else if (diffDays < 365) {
          const months = Math.floor(diffDays / 30);
          return `${months}ê°œì›” ì „`;
        } else {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}.${month}.${day}`;
        }
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
      function markdownToHtml(text) {
        if (!text) return '';
        
        // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ (ë³´ì•ˆ)
        const div = document.createElement('div');
        div.textContent = text;
        let html = div.innerHTML;
        
        // **í…ìŠ¤íŠ¸** â†’ <strong>í…ìŠ¤íŠ¸</strong>
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        // *í…ìŠ¤íŠ¸* â†’ <em>í…ìŠ¤íŠ¸</em> (ë‹¨, ** ë‹¤ìŒì´ ì•„ë‹Œ ê²½ìš°)
        html = html.replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>');
        
        // \n\n â†’ </p><p> (ë‹¨ë½ êµ¬ë¶„)
        const paragraphs = html.split(/\n\n+/).filter(p => p.trim());
        if (paragraphs.length > 1) {
          return paragraphs.map(p => {
            // \n â†’ <br> (ì¤„ë°”ê¿ˆ)
            p = p.replace(/\n/g, '<br>');
            return `<p>${p}</p>`;
          }).join('');
        } else {
          // ë‹¨ë½ì´ í•˜ë‚˜ë©´ <p> íƒœê·¸ ì—†ì´ <br>ë§Œ ì‚¬ìš©
          return html.replace(/\n/g, '<br>');
        }
      }

      // ì¹´í…Œê³ ë¦¬ì—ì„œ í…Œì´ë¸” ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (AI ì¼ì • ìƒì„±ìš©)
      function getTableNameFromCategories(categories) {
        if (!categories || categories.length === 0) return 'shopping_options_db_frame';
        
        const categoryTableMap = {
          shopping: 'shopping_options_db_frame',
          food: 'meal_options_db_frame',
          culture: 'airport_events_db_frame',
          relax: 'rests_db_frame'
        };
        
        return categoryTableMap[categories[0]] || 'shopping_options_db_frame';
      }

      // ì¼ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
      function goToPlanPage(planType) {
        // Router state ì—…ë°ì´íŠ¸
        if (window.updateAppState) {
          window.updateAppState({ userChoice: planType });
        }
        
        if (planType === 'airport-only') {
          window.location.href = 'airport-only.html';
        } else {
          window.location.href = 'airport-external.html';
        }
      }

      // ë¦¬ë·° ìƒì„¸ ë³´ê¸°
      function viewReviewDetail(reviewId) {
        // sessionStorageì— ë¦¬ë·° ID ì €ì¥
        sessionStorage.setItem('selectedReviewId', reviewId);
        // ë¦¬ë·° ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `review-detail.html?id=${reviewId}`;
      }

      // ì¢‹ì•„ìš” ê´€ë ¨ í•¨ìˆ˜ë“¤ (DB ê¸°ë°˜)
      async function getLikeCount(reviewId) {
        try {
          if (window.reviewDB) {
            await window.reviewDB.initialize();
            return await window.reviewDB.getLikeCount(reviewId);
          }
          // í´ë°±: localStorage
          const likes = JSON.parse(localStorage.getItem('review_likes') || '{}');
          return likes[reviewId]?.count || 0;
        } catch (e) {
          console.error('ì¢‹ì•„ìš” ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', e);
          return 0;
        }
      }

      async function checkIfLiked(reviewId) {
        try {
          // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° false ë°˜í™˜
          let userId = null;
          try {
            userId = window.getUserId ? await window.getUserId() : null;
          } catch (e) {
            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ ì‹œ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰ (ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ìˆ˜ ìˆìŒ)
            console.warn('ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ìˆ˜ ìˆìŒ):', e);
          }
          
          if (window.reviewDB && userId) {
            await window.reviewDB.initialize();
            const likes = await window.reviewDB.getLikesByReviewId(reviewId);
            return likes.some(like => like.user_id === userId);
          }
          // í´ë°±: localStorage
          const userLikes = JSON.parse(localStorage.getItem('user_liked_reviews') || '[]');
          return userLikes.includes(reviewId);
        } catch (e) {
          console.error('ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', e);
          return false;
        }
      }

      async function toggleLike(reviewId) {
        try {
          // ë¡œê·¸ì¸ í™•ì¸
          if (window.requireAuth) {
            const authenticated = await window.requireAuth('ë¦¬ë·°ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            if (!authenticated) {
              return; // ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì§„í–‰í•˜ì§€ ì•ŠìŒ
            }
          }
          
          // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
          const userId = window.getUserId ? await window.getUserId() : null;
          if (!userId) {
            if (window.showModal) {
              showModal({
                message: 'ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
                type: 'error'
              });
            } else {
              alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            }
            return;
          }
          
          // ReviewDB ì´ˆê¸°í™”
          if (!window.reviewDB) {
            console.error('ReviewDBë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          await window.reviewDB.initialize();
          
          // í˜„ì¬ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
          const currentLikes = await window.reviewDB.getLikesByReviewId(reviewId);
          const isLiked = currentLikes.some(like => like.user_id === userId);
          
          if (isLiked) {
            // ì¢‹ì•„ìš” ì·¨ì†Œ
            await window.reviewDB.removeLike(reviewId, userId);
          } else {
            // ì¢‹ì•„ìš” ì¶”ê°€
            await window.reviewDB.addLike(reviewId, userId);
          }
          
          // ì¢‹ì•„ìš” ê°œìˆ˜ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
          const likeCount = await window.reviewDB.getLikeCount(reviewId);
          
          // UI ì—…ë°ì´íŠ¸
          const likeBtn = document.getElementById(`like-btn-${reviewId}`);
          const likeCountEl = document.getElementById(`like-count-${reviewId}`);
          const likeIcon = likeBtn?.querySelector('.like-icon');
          
          if (likeBtn && likeCountEl && likeIcon) {
            if (isLiked) {
              likeBtn.classList.remove('liked');
              likeIcon.textContent = 'ğŸ¤';
            } else {
              likeBtn.classList.add('liked');
              likeIcon.textContent = 'â¤ï¸';
            }
            likeCountEl.textContent = likeCount;
          }
          
          console.log('âœ… ì¢‹ì•„ìš” ìƒíƒœ ë³€ê²½ ì™„ë£Œ:', { reviewId, isLiked: !isLiked, count: likeCount });
          
        } catch (e) {
          console.error('ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:', e);
          if (window.showModal) {
            showModal({
              message: 'ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
              type: 'error'
            });
          } else {
            alert('ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        }
      }
    </script>
    <script src="scripts/modal.js"></script>
  </body>
</html>
