<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="google-maps-api-key" content="AIzaSyCGuiWVQgNS8egFImIxqQjA1LFI47TBmw8" />
    <title>ì—¬í–‰ ìŠ¤íƒ€ì¼ ì„ íƒ - Via Flight</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/airport-main.css" />
    <link rel="stylesheet" href="styles/components/buttons.css" />
    <link rel="stylesheet" href="styles/components/cards.css" />
    <link rel="stylesheet" href="styles/components/steps.css" />
  </head>
  <body class="app airport-main-page">
    <header class="app-header">
      <h1>Via Flight</h1>
      <p class="tagline">ì–´ë–¤ ì—¬í–‰ì„ ì›í•˜ì‹œë‚˜ìš”?</p>
      <nav class="breadcrumb">
        <a href="transfer-info.html" class="breadcrumb__link">â† í™˜ìŠ¹ ì •ë³´ ìˆ˜ì •</a>
      </nav>
    </header>

    <main class="airport-main-content">
      <!-- Progress Indicator -->
      <div class="progress-container">
        <div class="progress-steps">
          <div class="step completed">
            <div class="step-number">âœ“</div>
            <div class="step-label">í™˜ìŠ¹ ì •ë³´</div>
          </div>
          <div class="step active">
            <div class="step-number">2</div>
            <div class="step-label">ì—¬í–‰ ìŠ¤íƒ€ì¼</div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">ì¼ì • ìƒì„±</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 66%"></div>
        </div>
      </div>

      <!-- Transfer Summary -->
      <section class="transfer-summary">
        <div class="summary-card">
          <h2 class="summary-title" id="summary-title">í™˜ìŠ¹ ì •ë³´</h2>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">ê²½ìœ  ë„ì‹œ</span>
              <span class="summary-value" id="summary-city">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">í™˜ìŠ¹ ì‹œê°„</span>
              <span class="summary-value" id="summary-duration">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ë„ì°© ì‹œê°„</span>
              <span class="summary-value" id="summary-arrival">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">ì¶œë°œ ì‹œê°„</span>
              <span class="summary-value" id="summary-departure">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Choice Section -->
      <section class="choice-section">
        <h2 class="choice-title">ì–´ë–¤ ì—¬í–‰ì„ ì›í•˜ì‹œë‚˜ìš”?</h2>
        <p class="choice-description">
          í™˜ìŠ¹ ì‹œê°„ ë™ì•ˆ ì–´ë–»ê²Œ ë³´ë‚´ê³  ì‹¶ìœ¼ì‹ ì§€ ì„ íƒí•´ì£¼ì„¸ìš”.<br>
          ì„ íƒì— ë”°ë¼ ë§ì¶¤í˜• ì¼ì •ì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤.
        </p>

        <div class="choice-cards">
          <button class="choice-card" onclick="chooseAirportOnly()">
            <div class="choice-icon">âœˆï¸</div>
            <h3 class="choice-card-title">ê³µí•­ì—ë§Œ ìˆì„ë˜ìš”</h3>
            <p class="choice-card-description">
              ë©´ì„¸ì , ë¼ìš´ì§€, ë¬¸í™”ì²´í—˜ ë“±<br>
              ê³µí•­ ë‚´ë¶€ì—ì„œë§Œ ì¦ê¸°ëŠ” ì—¬í–‰
            </p>
            <div class="choice-features">
              <span class="feature-tag">ë©´ì„¸ì </span>
              <span class="feature-tag">ë¼ìš´ì§€</span>
              <span class="feature-tag">ë¬¸í™”ì²´í—˜</span>
              <span class="feature-tag">ì‹ë‹¹</span>
            </div>
            <div class="choice-benefits">
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ì…êµ­ ì‹¬ì‚¬ ë¶ˆí•„ìš”</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ì§ ë³´ê´€ì†Œ ì´ìš© ê°€ëŠ¥</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ì•ˆì „í•˜ê³  í¸ë¦¬í•¨</span>
              </div>
            </div>
          </button>

          <button class="choice-card" onclick="chooseAirportExternal()">
            <div class="choice-icon">ğŸŒ</div>
            <h3 class="choice-card-title">ê³µí•­ ë°–ì—ë„ ë‚˜ê°ˆë˜ìš”</h3>
            <p class="choice-card-description">
              ë„ì‹œ ê´€ê´‘ + ê³µí•­ ë‚´ë¶€<br>
              ë” í’ë¶€í•œ í™˜ìŠ¹ ì—¬í–‰ ê²½í—˜
            </p>
            <div class="choice-features">
              <span class="feature-tag">ë¡œì»¬ ë§›ì§‘</span>
              <span class="feature-tag">ê´€ê´‘ì§€</span>
              <span class="feature-tag">ì‡¼í•‘</span>
              <span class="feature-tag">ë¬¸í™”ì²´í—˜</span>
            </div>
            <div class="choice-benefits">
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ë¡œì»¬ ë¬¸í™” ì²´í—˜</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>ë‹¤ì–‘í•œ í™œë™</span>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">âœ“</span>
                <span>íŠ¹ë³„í•œ ì¶”ì–µ</span>
              </div>
            </div>
          </button>
        </div>
      </section>

      <!-- Recommendations Section -->
      <section class="recommendations-section">
        <h3 class="recommendations-title">ğŸ’¡ ì¶”ì²œ ì •ë³´</h3>
        <div class="recommendations-grid">
          <div class="recommendation-card">
            <h4>ê³µí•­ì—ì„œ ë­í•˜ì§€?</h4>
            <div class="recommendation-items">
              <div class="recommendation-item">
                <span class="item-icon">ğŸ›ï¸</span>
                <span>ë©´ì„¸ì  ì‡¼í•‘</span>
              </div>
              <div class="recommendation-item">
                <span class="item-icon">ğŸ½ï¸</span>
                <span>ê³µí•­ ë§›ì§‘</span>
              </div>
              <div class="recommendation-item">
                <span class="item-icon">ğŸ¨</span>
                <span>ë¬¸í™”ì²´í—˜</span>
              </div>
              <div class="recommendation-item">
                <span class="item-icon">ğŸ’†</span>
                <span>ìŠ¤íŒŒ & ë§ˆì‚¬ì§€</span>
              </div>
            </div>
          </div>

          <div class="recommendation-card">
            <h4>ë² ìŠ¤íŠ¸ í™˜ìŠ¹ ì—¬í–‰ ì½”ìŠ¤</h4>
            <div class="course-list">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>

          <div class="recommendation-card">
            <h4>ğŸ“ ë‹¤ë¥¸ ì—¬í–‰ìë“¤ì˜ ë¦¬ë·°</h4>
            <div class="reviews-sort-container">
              <label for="review-sort-select">ì •ë ¬:</label>
              <select id="review-sort-select" class="review-sort-select" onchange="applySort()">
                <option value="latest">ìµœì‹ ìˆœ</option>
                <option value="rating-desc">í‰ì  ë†’ì€ìˆœ</option>
                <option value="rating-asc">í‰ì  ë‚®ì€ìˆœ</option>
              </select>
            </div>
            <div class="reviews-container" id="city-reviews-container">
              <div class="reviews-loading" style="display: none;">
                <p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
              <div class="reviews-list" id="city-reviews-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
              </div>
              <div class="reviews-empty" id="city-reviews-empty" style="display: none;">
                <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script type="module" src="scripts/router.js"></script>
    <script src="scripts/sqliteClient.js"></script>
    <script src="scripts/reviewDB.js"></script>
    <script>
      // ì „ì—­ ìƒíƒœ
      let transferInfo = null;
      let selectedChoice = null;
      
      // ë¦¬ë·° ê´€ë ¨ ìƒíƒœ (ìµœì†Œí•œì˜ ì „ì—­ ë³€ìˆ˜)
      let allCityReviews = []; // ì „ì²´ ë¦¬ë·° ì €ì¥
      let showingAllReviews = false; // ì „ì²´ ë³´ê¸° ì—¬ë¶€
      let currentSortType = 'latest'; // í˜„ì¬ ì •ë ¬ íƒ€ì…

      // í™œë™ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
      const ACTIVITY_CATEGORIES = {
        'shopping': {
          tableName: 'shopping_options_db_frame',
          icon: 'ğŸ›ï¸',
          label: 'ë©´ì„¸ì  ì‡¼í•‘',
          displayOrder: 1
        },
        'food': {
          tableName: 'meal_options_db_frame',
          icon: 'ğŸ½ï¸',
          label: 'ê³µí•­ ë§›ì§‘',
          displayOrder: 2
        },
        'culture': {
          tableName: 'airport_events_db_frame',
          icon: 'ğŸ¨',
          label: 'ë¬¸í™”ì²´í—˜',
          displayOrder: 3
        },
        'relax': {
          tableName: 'rests_db_frame',
          icon: 'ğŸ’†',
          label: 'ìŠ¤íŒŒ & ë§ˆì‚¬ì§€',
          displayOrder: 4
        }
      };

      // í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ìŠ¹ ì •ë³´ í‘œì‹œ
      document.addEventListener('DOMContentLoaded', async function() {
        loadTransferInfo();
        updateSummary();
        
        // ê³µí•­ í™œë™ ë° ì¶”ì²œ ì½”ìŠ¤ ë¡œë“œ (ë¹„ë™ê¸°)
        await loadAirportActivities();
        renderRecommendationCourses();
        
        // ë™ì¼ ë„ì‹œ ë¦¬ë·° ë¡œë“œ
        await loadCityReviews();
        
        // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        setTimeout(() => {
          document.querySelector('.transfer-summary').style.opacity = '1';
          document.querySelector('.transfer-summary').style.transform = 'translateY(0)';
        }, 300);
        
        setTimeout(() => {
          document.querySelector('.choice-section').style.opacity = '1';
          document.querySelector('.choice-section').style.transform = 'translateY(0)';
        }, 600);
        
        setTimeout(() => {
          document.querySelector('.recommendations-section').style.opacity = '1';
          document.querySelector('.recommendations-section').style.transform = 'translateY(0)';
        }, 900);
      });

      // í™˜ìŠ¹ ì •ë³´ ë¡œë“œ
      function loadTransferInfo() {
        const state = window.getAppState();
        if (state.transferInfo) {
          transferInfo = state.transferInfo;
        } else {
          // ê¸°ë³¸ê°’ ì„¤ì •
          transferInfo = {
            city: 'ì„œìš¸',
            arrival: new Date(),
            departure: new Date(Date.now() + 4 * 60 * 60 * 1000),
            duration: 4 * 60 * 60 * 1000
          };
        }
      }

      // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateSummary() {
        if (!transferInfo) return;

        document.getElementById('summary-city').textContent = transferInfo.city;
        document.getElementById('summary-duration').textContent = formatDuration(transferInfo.duration);
        document.getElementById('summary-arrival').textContent = formatDateTime(transferInfo.arrival);
        document.getElementById('summary-departure').textContent = formatDateTime(transferInfo.departure);
      }

      // ì‹œê°„ í¬ë§·íŒ…
      function formatDuration(durationMs) {
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let result = '';
        if (hours > 0) result += `${hours}ì‹œê°„`;
        if (minutes > 0) result += ` ${minutes}ë¶„`;
        
        return result || '0ë¶„';
      }

      // ë‚ ì§œ ì‹œê°„ í¬ë§·íŒ…
      function formatDateTime(date) {
        if (!date) return '-';
        
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        
        return `${year}.${month}.${day} ${hours}:${minutes}`;
      }

      // ê³µí•­ì—ë§Œ ìˆì„ë˜ìš” ì„ íƒ
      function chooseAirportOnly() {
        selectedChoice = 'airport-only';
        
        // ì„ íƒ ìƒíƒœ í‘œì‹œ
        document.querySelectorAll('.choice-card').forEach(card => {
          card.classList.remove('selected');
        });
        event.target.closest('.choice-card').classList.add('selected');
        
        // ë¼ìš°í„°ë¥¼ í†µí•´ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.navigateTo('/airport-only', { userChoice: selectedChoice });
        }, 500);
      }

      // ê³µí•­ ë°–ì—ë„ ë‚˜ê°ˆë˜ìš” ì„ íƒ
      function chooseAirportExternal() {
        selectedChoice = 'airport-external';
        
        // ì„ íƒ ìƒíƒœ í‘œì‹œ
        document.querySelectorAll('.choice-card').forEach(card => {
          card.classList.remove('selected');
        });
        event.target.closest('.choice-card').classList.add('selected');
        
        // ë¼ìš°í„°ë¥¼ í†µí•´ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.navigateTo('/airport-external', { userChoice: selectedChoice });
        }, 500);
      }

      // ë’¤ë¡œê°€ê¸°
      function goBack() {
        window.goBack();
      }

      // ê³µí•­ í™œë™ í†µê³„ ë¡œë“œ
      async function loadAirportActivities() {
        const container = document.querySelector('.recommendation-items');
        if (!container) return;

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const originalHTML = container.innerHTML;
        container.innerHTML = '<div class="loading-activities">ë¡œë”© ì¤‘...</div>';

        try {
          // SQLite í´ë¼ì´ì–¸íŠ¸ í™•ì¸ (sqliteClient.jsì—ì„œ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±)
          if (!window.sqliteClient) {
            console.warn('SQLite í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return; // ì›ë˜ HTML ìœ ì§€
          }

          await window.sqliteClient.initialize();

          // ëª¨ë“  ì¹´í…Œê³ ë¦¬ í†µê³„ ë³‘ë ¬ ì¡°íšŒ
          const activityPromises = Object.entries(ACTIVITY_CATEGORIES).map(
            async ([key, category]) => {
              try {
                const pois = await window.sqliteClient.getTablePOIs(category.tableName);
                return {
                  key,
                  ...category,
                  count: pois.length,
                  available: pois.length > 0
                };
              } catch (error) {
                console.error(`${category.label} ì¡°íšŒ ì‹¤íŒ¨:`, error);
                return {
                  key,
                  ...category,
                  count: 0,
                  available: false
                };
              }
            }
          );

          const activities = await Promise.all(activityPromises);
          
          // ì‚¬ìš© ê°€ëŠ¥í•œ í™œë™ë§Œ í•„í„°ë§ ë° ì •ë ¬
          const availableActivities = activities
            .filter(a => a.available)
            .sort((a, b) => a.displayOrder - b.displayOrder);

          if (availableActivities.length === 0) {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì›ë˜ HTML ìœ ì§€
            container.innerHTML = originalHTML;
            return;
          }

          renderAirportActivities(availableActivities);

        } catch (error) {
          console.error('ê³µí•­ í™œë™ ë¡œë“œ ì‹¤íŒ¨:', error);
          // ì—ëŸ¬ ë°œìƒ ì‹œ ì›ë˜ HTML ìœ ì§€
          container.innerHTML = originalHTML;
        }
      }

      // ê³µí•­ í™œë™ ë Œë”ë§
      function renderAirportActivities(activities) {
        const container = document.querySelector('.recommendation-items');
        if (!container) return;

        container.innerHTML = activities.map(activity => `
          <div class="recommendation-item clickable" 
               data-table="${activity.tableName}" 
               data-category-key="${activity.key}"
               role="button"
               tabindex="0"
               aria-label="${activity.label} - ${activity.count}ê°œ ì¥ì†Œ">
            <span class="item-icon">${activity.icon}</span>
            <span class="item-label">${activity.label}</span>
            <span class="item-count">${activity.count}ê°œ</span>
          </div>
        `).join('');

        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        attachActivityClickHandlers(container);
      }

      // í™œë™ í´ë¦­ í•¸ë“¤ëŸ¬ ì—°ê²°
      function attachActivityClickHandlers(container) {
        container.querySelectorAll('.recommendation-item.clickable').forEach(item => {
          // í´ë¦­ ì´ë²¤íŠ¸
          item.addEventListener('click', function() {
            handleActivityClick(this);
          });

          // í‚¤ë³´ë“œ ì ‘ê·¼ì„± (Enter, Space)
          item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleActivityClick(this);
            }
          });
        });
      }

      // í™œë™ í´ë¦­ ì²˜ë¦¬
      function handleActivityClick(element) {
        const tableName = element.dataset.table;
        const categoryKey = element.dataset.categoryKey;

        // í´ë¦­ íš¨ê³¼
        element.style.transform = 'scale(0.95)';
        setTimeout(() => {
          element.style.transform = '';
        }, 150);

        // sessionStorageì— ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
        sessionStorage.setItem('preSelectedTable', tableName);
        sessionStorage.setItem('preSelectedCategory', categoryKey);

        // airport-only í˜ì´ì§€ë¡œ ì´ë™
        if (window.navigateTo) {
          window.navigateTo('/airport-only', { 
            userChoice: 'airport-only',
            preSelectedTable: tableName,
            preSelectedCategory: categoryKey
          });
        } else {
          // í´ë°±: ì§ì ‘ URL ì´ë™
          window.location.href = `airport-only.html`;
        }
      }

      // í™˜ìŠ¹ ì‹œê°„ë³„ ì¶”ì²œ ì½”ìŠ¤ ìƒì„±
      function generateRecommendationCourses() {
        if (!transferInfo || !transferInfo.duration) {
          return getDefaultCourses();
        }

        const durationHours = transferInfo.duration / (1000 * 60 * 60);
        
        let courses = [];
        
        if (durationHours < 2) {
          // 2ì‹œê°„ ë¯¸ë§Œ: ë¹ ë¥¸ í™œë™ë§Œ
          courses = [
            { time: '1-2ì‹œê°„', title: 'ë¹ ë¥¸ ì‡¼í•‘ & ê°„ì‹', description: 'ë©´ì„¸ì  + ì¹´í˜', recommended: true }
          ];
        } else if (durationHours < 4) {
          // 2-4ì‹œê°„: ê³µí•­ ë‚´ë¶€ íƒí—˜
          courses = [
            { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€', recommended: true }
          ];
        } else if (durationHours < 6) {
          // 4-6ì‹œê°„: ë„ì‹œ ë‚˜ë“¤ì´ ê°€ëŠ¥
          courses = [
            { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€' },
            { time: '4-6ì‹œê°„', title: 'ë„ì‹œ ë‚˜ë“¤ì´', description: 'ëª…ì†Œ + ë§›ì§‘ + ì‡¼í•‘', recommended: true }
          ];
        } else {
          // 6ì‹œê°„ ì´ìƒ: í†µí•© ì—¬í–‰
          courses = [
            { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€' },
            { time: '4-6ì‹œê°„', title: 'ë„ì‹œ ë‚˜ë“¤ì´', description: 'ëª…ì†Œ + ë§›ì§‘ + ì‡¼í•‘' },
            { time: '6ì‹œê°„+', title: 'í†µí•© ì—¬í–‰', description: 'ê³µí•­ + ë„ì‹œ + ë¬¸í™”ì²´í—˜', recommended: true }
          ];
        }

        return courses;
      }

      // ê¸°ë³¸ ì½”ìŠ¤ (í™˜ìŠ¹ ì •ë³´ê°€ ì—†ì„ ë•Œ)
      function getDefaultCourses() {
        return [
          { time: '2-3ì‹œê°„', title: 'ê³µí•­ ë‚´ë¶€ íƒí—˜', description: 'ë©´ì„¸ì  + ì‹ë‹¹ + ë¼ìš´ì§€' },
          { time: '4-6ì‹œê°„', title: 'ë„ì‹œ ë‚˜ë“¤ì´', description: 'ëª…ì†Œ + ë§›ì§‘ + ì‡¼í•‘' },
          { time: '6ì‹œê°„+', title: 'í†µí•© ì—¬í–‰', description: 'ê³µí•­ + ë„ì‹œ + ë¬¸í™”ì²´í—˜' }
        ];
      }

      // ì¶”ì²œ ì½”ìŠ¤ ë Œë”ë§
      function renderRecommendationCourses() {
        const container = document.querySelector('.course-list');
        if (!container) return;

        const courses = generateRecommendationCourses();
        
        container.innerHTML = courses.map(course => {
          const recommendedBadge = course.recommended 
            ? '<span class="recommended-badge">ì¶”ì²œ</span>' 
            : '';
          
          return `
            <div class="course-item ${course.recommended ? 'recommended' : ''}">
              <div class="course-time">${course.time}</div>
              <div class="course-content">
                <strong>${course.title} ${recommendedBadge}</strong>
                <p>${course.description}</p>
              </div>
            </div>
          `;
        }).join('');
      }

      // ë„ì‹œ ì´ë¦„ ì •ê·œí™” í•¨ìˆ˜
      function normalizeCityName(city) {
        if (!city) return '';
        
        const cityNameMap = {
          'ì‹±ê°€í¬ë¥´': 'Singapore',
          'Singapore': 'Singapore',
          'ì„œìš¸': 'Seoul',
          'Seoul': 'Seoul',
          'ë„ì¿„': 'Tokyo',
          'Tokyo': 'Tokyo',
          'ë°©ì½•': 'Bangkok',
          'Bangkok': 'Bangkok'
        };
        
        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
        if (cityNameMap[city]) {
          return cityNameMap[city];
        }
        
        // ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë§¤ì¹­
        const cityLower = city.toLowerCase();
        for (const [key, value] of Object.entries(cityNameMap)) {
          if (key.toLowerCase() === cityLower) {
            return value;
          }
        }
        
        // ë§¤í•‘ë˜ì§€ ì•Šìœ¼ë©´ ì›ë³¸ ë°˜í™˜
        return city;
      }

      // ë™ì¼ ë„ì‹œ ë¦¬ë·° ë¡œë“œ
      async function loadCityReviews() {
        const container = document.getElementById('city-reviews-list');
        const loadingEl = document.querySelector('.reviews-loading');
        const emptyEl = document.getElementById('city-reviews-empty');
        
        console.log('ğŸ” [loadCityReviews] ì‹œì‘');
        
        if (!container) {
          console.warn('âš ï¸ [loadCityReviews] ë¦¬ë·° ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ë„ì‹œ ì •ë³´ í™•ì¸
        if (!transferInfo || !transferInfo.city) {
          console.warn('âš ï¸ [loadCityReviews] ë„ì‹œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤:', transferInfo);
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        // ë„ì‹œ ì´ë¦„ ì •ê·œí™”
        const normalizedCity = normalizeCityName(transferInfo.city);
        console.log('ğŸ” [loadCityReviews] ë„ì‹œ ì´ë¦„ ì •ê·œí™”:', {
          originalCity: transferInfo.city,
          normalizedCity: normalizedCity,
          transferInfo: transferInfo
        });

        try {
          // ë¡œë”© í‘œì‹œ
          if (loadingEl) loadingEl.style.display = 'block';
          if (emptyEl) emptyEl.style.display = 'none';
          container.innerHTML = '';

          // ë¦¬ë·° DB ì´ˆê¸°í™”
          console.log('ğŸ” [loadCityReviews] DB ì´ˆê¸°í™” ì‹œì‘...');
          await window.reviewDB.initialize();
          console.log('âœ… [loadCityReviews] ë¦¬ë·° DB ì´ˆê¸°í™” ì™„ë£Œ');

          // ì •ê·œí™”ëœ ë„ì‹œ ì´ë¦„ìœ¼ë¡œ ë¦¬ë·° ì¡°íšŒ
          console.log('ğŸ” [loadCityReviews] ë¦¬ë·° ì¡°íšŒ ì‹œì‘:', {
            normalizedCity: normalizedCity,
            dbInitialized: window.reviewDB.isInitialized
          });
          
          const reviews = window.reviewDB.getCityReviews(normalizedCity);
          console.log('ğŸ“‹ [loadCityReviews] ì¡°íšŒëœ ë¦¬ë·°:', {
            count: reviews?.length || 0,
            city: normalizedCity,
            reviews: reviews
          });

          if (loadingEl) loadingEl.style.display = 'none';

          if (!reviews || reviews.length === 0) {
            console.log('âš ï¸ [loadCityReviews] ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ë””ë²„ê¹… ì •ë³´ í™•ì¸ ì¤‘...');
            
            // ë””ë²„ê¹…: ì €ì¥ëœ ëª¨ë“  ë„ì‹œ ì´ë¦„ í™•ì¸
            try {
              const allCities = window.reviewDB.db.exec(`
                SELECT DISTINCT trip_info_city, COUNT(*) as count 
                FROM trip_reviews 
                GROUP BY trip_info_city
              `);
              console.log('ğŸ“Š [loadCityReviews] ì €ì¥ëœ ë„ì‹œ ëª©ë¡:', allCities);
              
              // ì „ì²´ ë¦¬ë·° ê°œìˆ˜ í™•ì¸
              const totalReviews = window.reviewDB.db.exec(`
                SELECT COUNT(*) as count FROM trip_reviews
              `);
              console.log('ğŸ“Š [loadCityReviews] ì „ì²´ ë¦¬ë·° ê°œìˆ˜:', totalReviews);
              
              if (totalReviews.length > 0 && totalReviews[0].values.length > 0) {
                const totalCount = totalReviews[0].values[0][0];
                console.log(`ğŸ“Š [loadCityReviews] ì´ ${totalCount}ê°œì˜ ë¦¬ë·°ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                
                if (totalCount > 0 && allCities.length > 0) {
                  const cities = allCities[0].values.map(v => v[0]);
                  console.log('ğŸ’¡ [loadCityReviews] ì €ì¥ëœ ë„ì‹œë“¤:', cities);
                  console.log('ğŸ’¡ [loadCityReviews] ì°¾ëŠ” ë„ì‹œ:', normalizedCity);
                  console.log('ğŸ’¡ [loadCityReviews] ë§¤ì¹­ ì—¬ë¶€:', cities.includes(normalizedCity));
                  
                  // ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë§¤ì¹­ í™•ì¸
                  const cityLower = normalizedCity.toLowerCase();
                  const matchingCity = cities.find(c => c.toLowerCase() === cityLower);
                  console.log('ğŸ’¡ [loadCityReviews] ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë§¤ì¹­:', matchingCity || 'ì—†ìŒ');
                }
              }
            } catch (debugError) {
              console.error('âŒ [loadCityReviews] ë””ë²„ê¹… ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', debugError);
            }
            
            if (emptyEl) emptyEl.style.display = 'block';
            return;
          }

          // ì •ë ¬ ì ìš©
          currentSortType = 'latest'; // ê¸°ë³¸ ì •ë ¬
          const sortedReviews = sortReviews(reviews, currentSortType);
          
          // ì „ì²´ ë¦¬ë·° ì €ì¥ (ì •ë ¬ëœ ë²„ì „)
          allCityReviews = sortedReviews;
          showingAllReviews = false; // ì´ˆê¸°í™”

          // 3ê°œë§Œ í‘œì‹œ
          const displayReviews = sortedReviews.slice(0, 3);
          const hasMore = sortedReviews.length > 3;
          console.log('âœ… [loadCityReviews] í‘œì‹œí•  ë¦¬ë·°:', displayReviews.length, 'ê°œ');
          console.log('ğŸ“Š [loadCityReviews] ì „ì²´ ë¦¬ë·°:', sortedReviews.length, 'ê°œ');

          renderCityReviews(displayReviews, hasMore);

        } catch (error) {
          console.error('âŒ [loadCityReviews] ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨:', error);
          console.error('âŒ [loadCityReviews] ì—ëŸ¬ ìƒì„¸:', {
            message: error.message,
            stack: error.stack,
            city: transferInfo.city,
            normalizedCity: normalizedCity
          });
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) emptyEl.style.display = 'block';
        }
      }

      // ë„ì‹œ ë¦¬ë·° ë Œë”ë§
      function renderCityReviews(reviews, hasMore = false) {
        const container = document.getElementById('city-reviews-list');
        if (!container) return;

        const reviewsHtml = reviews.map(review => {
          // ë³„ì  ìƒì„±
          const rating = review.overall_review_rating || 0;
          const stars = 'â­'.repeat(rating);
          
          // ë‚ ì§œ í¬ë§·íŒ…
          const reviewDate = new Date(review.submitted_at);
          const formattedDate = formatReviewDate(reviewDate);
          
          // ì—¬í–‰ íƒ€ì… í‘œì‹œ
          const tripTypeText = review.trip_info_trip_type === 'airport-only' 
            ? 'ê³µí•­ ë‚´ë¶€ë§Œ' 
            : review.trip_info_trip_type === 'airport-external' 
            ? 'ê³µí•­ + ë„ì‹œ' 
            : 'ì „ì²´';
          
          // í™˜ìŠ¹ ì‹œê°„ í‘œì‹œ
          const durationText = review.trip_info_duration 
            ? formatDuration(review.trip_info_duration) 
            : '';

          // ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
          const isLiked = checkIfLiked(review.id);
          const likeCount = getLikeCount(review.id);

          return `
            <div class="review-card-item" onclick="viewReviewDetail('${review.id}')" style="cursor: pointer;">
              <div class="review-card-header">
                <div class="review-rating">
                  <span class="review-stars">${stars}</span>
                  <span class="review-rating-number">${rating}.0</span>
                </div>
                <span class="review-date">${formattedDate}</span>
              </div>
              <div class="review-summary">${escapeHtml(review.overall_review_summary || '')}</div>
              ${review.overall_review_detail ? `<div class="review-detail">${escapeHtml(review.overall_review_detail)}</div>` : ''}
              <div class="review-meta">
                <span class="review-trip-type">${tripTypeText}</span>
                ${durationText ? `<span class="review-duration">${durationText}</span>` : ''}
                ${review.trip_info_visit_count ? `<span class="review-visit-count">${review.trip_info_visit_count}ê°œ ì¥ì†Œ ë°©ë¬¸</span>` : ''}
              </div>
              <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
              <div class="review-actions" onclick="event.stopPropagation(); toggleLike('${review.id}')">
                <button class="btn-like ${isLiked ? 'liked' : ''}" id="like-btn-${review.id}">
                  <span class="like-icon">${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                  <span class="like-count" id="like-count-${review.id}">${likeCount}</span>
                </button>
              </div>
            </div>
          `;
        }).join('');

        // "ë” ë³´ê¸°" ë²„íŠ¼ ì¶”ê°€
        let moreButtonHtml = '';
        if (hasMore) {
          const remainingCount = allCityReviews.length - reviews.length;
          moreButtonHtml = `
            <div class="reviews-more-container">
              <button class="btn btn--ghost btn--small" onclick="showAllReviews()">
                ë” ë³´ê¸° (${remainingCount}ê°œ ë”)
              </button>
            </div>
          `;
        }

        container.innerHTML = reviewsHtml + moreButtonHtml;
      }

      // ì •ë ¬ í•¨ìˆ˜
      function sortReviews(reviews, sortType) {
        const sorted = [...reviews]; // ë³µì‚¬ë³¸ ìƒì„±
        
        switch (sortType) {
          case 'latest':
            return sorted.sort((a, b) => {
              const dateA = new Date(a.submitted_at);
              const dateB = new Date(b.submitted_at);
              return dateB - dateA; // ìµœì‹ ìˆœ
            });
          
          case 'rating-desc':
            return sorted.sort((a, b) => {
              const ratingA = a.overall_review_rating || 0;
              const ratingB = b.overall_review_rating || 0;
              if (ratingB !== ratingA) {
                return ratingB - ratingA; // í‰ì  ë†’ì€ìˆœ
              }
              // í‰ì ì´ ê°™ìœ¼ë©´ ìµœì‹ ìˆœ
              return new Date(b.submitted_at) - new Date(a.submitted_at);
            });
          
          case 'rating-asc':
            return sorted.sort((a, b) => {
              const ratingA = a.overall_review_rating || 0;
              const ratingB = b.overall_review_rating || 0;
              if (ratingA !== ratingB) {
                return ratingA - ratingB; // í‰ì  ë‚®ì€ìˆœ
              }
              // í‰ì ì´ ê°™ìœ¼ë©´ ìµœì‹ ìˆœ
              return new Date(b.submitted_at) - new Date(a.submitted_at);
            });
          
          default:
            return sorted;
        }
      }

      // ì •ë ¬ ì ìš© í•¨ìˆ˜
      function applySort() {
        const sortSelect = document.getElementById('review-sort-select');
        if (!sortSelect) return;
        
        currentSortType = sortSelect.value;
        showingAllReviews = false; // ì •ë ¬ ë³€ê²½ ì‹œ ì´ˆê¸°í™”
        
        // ì›ë³¸ ë¦¬ë·° ê°€ì ¸ì˜¤ê¸° (DBì—ì„œ ë‹¤ì‹œ ì¡°íšŒí•˜ì—¬ ì›ë³¸ ë°ì´í„° í™•ë³´)
        const normalizedCity = normalizeCityName(transferInfo.city);
        const originalReviews = window.reviewDB.getCityReviews(normalizedCity);
        
        // ì •ë ¬ ì ìš©
        const sortedReviews = sortReviews(originalReviews, currentSortType);
        allCityReviews = sortedReviews;
        
        // 3ê°œë§Œ í‘œì‹œ
        const displayReviews = sortedReviews.slice(0, 3);
        const hasMore = sortedReviews.length > 3;
        
        renderCityReviews(displayReviews, hasMore);
      }

      // ì „ì²´ ë¦¬ë·° í‘œì‹œ
      function showAllReviews() {
        showingAllReviews = true;
        renderCityReviews(allCityReviews, false);
      }

      // ë‚ ì§œ í¬ë§·íŒ… (ë¦¬ë·°ìš©)
      function formatReviewDate(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
          return 'ì˜¤ëŠ˜';
        } else if (diffDays === 1) {
          return 'ì–´ì œ';
        } else if (diffDays < 7) {
          return `${diffDays}ì¼ ì „`;
        } else if (diffDays < 30) {
          const weeks = Math.floor(diffDays / 7);
          return `${weeks}ì£¼ ì „`;
        } else if (diffDays < 365) {
          const months = Math.floor(diffDays / 30);
          return `${months}ê°œì›” ì „`;
        } else {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}.${month}.${day}`;
        }
      }

      // HTML ì´ìŠ¤ì¼€ì´í”„
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ë¦¬ë·° ìƒì„¸ ë³´ê¸°
      function viewReviewDetail(reviewId) {
        // sessionStorageì— ë¦¬ë·° ID ì €ì¥
        sessionStorage.setItem('selectedReviewId', reviewId);
        // ë¦¬ë·° ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `review-detail.html?id=${reviewId}`;
      }

      // ì¢‹ì•„ìš” ê´€ë ¨ í•¨ìˆ˜ë“¤ (localStorage ê¸°ë°˜ - ë¡œê·¸ì¸ ì „ ëŒ€ë¹„)
      function getLikeCount(reviewId) {
        try {
          const likes = JSON.parse(localStorage.getItem('review_likes') || '{}');
          return likes[reviewId]?.count || 0;
        } catch (e) {
          return 0;
        }
      }

      function checkIfLiked(reviewId) {
        try {
          const userLikes = JSON.parse(localStorage.getItem('user_liked_reviews') || '[]');
          return userLikes.includes(reviewId);
        } catch (e) {
          return false;
        }
      }

      function toggleLike(reviewId) {
        try {
          // ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”í•œ ë¦¬ë·° ëª©ë¡
          let userLikes = JSON.parse(localStorage.getItem('user_liked_reviews') || '[]');
          const isLiked = userLikes.includes(reviewId);
          
          // ì¢‹ì•„ìš” ê°œìˆ˜
          let likes = JSON.parse(localStorage.getItem('review_likes') || '{}');
          if (!likes[reviewId]) {
            likes[reviewId] = { count: 0 };
          }
          
          if (isLiked) {
            // ì¢‹ì•„ìš” ì·¨ì†Œ
            userLikes = userLikes.filter(id => id !== reviewId);
            likes[reviewId].count = Math.max(0, likes[reviewId].count - 1);
          } else {
            // ì¢‹ì•„ìš” ì¶”ê°€
            userLikes.push(reviewId);
            likes[reviewId].count = (likes[reviewId].count || 0) + 1;
          }
          
          localStorage.setItem('user_liked_reviews', JSON.stringify(userLikes));
          localStorage.setItem('review_likes', JSON.stringify(likes));
          
          // UI ì—…ë°ì´íŠ¸
          const likeBtn = document.getElementById(`like-btn-${reviewId}`);
          const likeCount = document.getElementById(`like-count-${reviewId}`);
          const likeIcon = likeBtn?.querySelector('.like-icon');
          
          if (likeBtn && likeCount && likeIcon) {
            if (isLiked) {
              likeBtn.classList.remove('liked');
              likeIcon.textContent = 'ğŸ¤';
            } else {
              likeBtn.classList.add('liked');
              likeIcon.textContent = 'â¤ï¸';
            }
            likeCount.textContent = likes[reviewId].count;
          }
          
          // TODO: ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€ í›„ DBì— ë™ê¸°í™”
          console.log('ì¢‹ì•„ìš” ìƒíƒœ ë³€ê²½:', { reviewId, isLiked: !isLiked, count: likes[reviewId].count });
          
        } catch (e) {
          console.error('ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨:', e);
        }
      }
    </script>
  </body>
</html>
